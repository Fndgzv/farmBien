<div class="pedidos-container">
    <div class="titulo-container">
        <h1 class="titulo">Reporte de Pedidos</h1>
    </div>

    <div class="row g-2 align-items-center mb-3">
        <div class="col-auto">
            <label for="filtroFarmaciaId" class="form-label mb-0 lbl-pedido">Farmacia:</label>
        </div>
        <div class="col-auto">
            <select id="filtroFarmaciaId" [(ngModel)]="filtroFarmaciaId" class="form-select" style="width: 200px;">
                <option [ngValue]="null">-- Selecciona --</option>
                <option *ngFor="let f of farmacias" [ngValue]="f._id">
                    {{ f.nombre }}
                </option>
            </select>
        </div>

        <!-- NUEVOS: filtro por nombre de cliente -->
        <div class="col-auto">
            <label for="filtroClienteNombre" class="form-label mb-0 lbl-pedido">Cliente:</label>
        </div>
        <div class="col-auto">
            <input id="filtroClienteNombre" [(ngModel)]="filtroClienteNombre" type="text" class="form-control"
                placeholder="Nombre del cliente" style="width: 220px;" />
        </div>

        <!-- Check para incluir pedidos sin cliente -->
        <div class="col-auto form-check">
            <input class="form-check-input" type="checkbox" id="incluirClienteNull" [(ngModel)]="incluirClienteNull" />
            <label class="form-check-label" for="incluirClienteNull">
                Incluir “sin cliente”
            </label>
        </div>
    </div>

    <div class="row mb-2 filtros-container">

        <div class="col-md-2">
            <label class="lbl-pedido me-2 mb-0" style="white-space: nowrap;" for="filtroFechaPedido">Fecha
                Inicial:</label>
            <div class="position-relative">
                <input type="date" class="form-control pe-5" [(ngModel)]="filtroFechaPedido" />
                <button *ngIf="filtroFechaPedido" type="button" (click)="limpiarFechaPedido()"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>
        <div class="col-md-2">
            <label class="lbl-pedido me-2 mb-0" style="white-space: nowrap;" for="filtroFechaFin">Fecha Final:</label>
            <div class="position-relative">
                <input type="date" class="form-control pe-5" [(ngModel)]="filtroFechaFin" />
                <button *ngIf="filtroFechaFin" type="button" (click)="limpiarFechaFin()"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>
        <div class="col-md-3">
            <label class="lbl-pedido me-2 mb-0" style="white-space: nowrap;"
                for="filtroDescripcion">Descripción:</label>
            <div class="position-relative">
                <input type="text" class="form-control pe-5" [(ngModel)]="filtroDescripcion"
                    placeholder="Descripción..." />
                <button *ngIf="filtroDescripcion" type="button" (click)="limpiarDescripcion()"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>
        <div class="col-md-2">
            <label for="filtroEstado" class="lbl-pedido">Estado:</label>
            <select id="filtroEstado" [(ngModel)]="filtroEstado" class="form-select" style="width: 150px;">
                <option [ngValue]="null">-- Todos --</option>
                <option *ngFor="let estado of estadosPedido" [ngValue]="estado">
                    {{ estado }}
                </option>
            </select>
        </div>
        <div *ngIf="mostrarBotonBuscar" class="col-md-1" style="margin-top: 1rem;">
            <button class="btn-gris" (click)="buscarSinFolio()">Buscar</button>
        </div>

    </div>

    <div *ngIf="pedidos.length > 0" class="d-flex justify-content-between align-items-center w-100 mb-2">
        <h2 class="subtitulo mb-0">Pedidos</h2>
        <button class="btn-amarillo-chico btn-icon-chico" (click)="limpiarFiltroCompleto()"
            matTooltip="Cierra la tabla">
            <i class="fas fa-times"></i>
        </button>
    </div>


    <table *ngIf="pedidos.length > 0" class="tabla">
        <thead>
            <tr>
                <th></th>
                <th>Folio</th>

                <th class="sortable"
                    (click)="ordenarPor('fechaPedido')"
                    [attr.aria-sort]="ariaSortFor('fechaPedido')"
                    role="button"
                    matTooltip="Ordenar por fecha de pedido">
                F. pedido
                <fa-icon class="sort-icon"
                        [icon]="sortBy==='fechaPedido' ? (sortDir==='asc'? faSortUp : faSortDown) : faSort"
                        aria-hidden="true"></fa-icon>
                </th>

                <th class="sortable"
                    (click)="ordenarPor('cliente.nombre')"
                    [attr.aria-sort]="ariaSortFor('cliente.nombre')"
                    role="button"
                    matTooltip="Ordenar por cliente">
                Cliente
                <fa-icon class="sort-icon"
                        [icon]="sortBy==='cliente.nombre' ? (sortDir==='asc'? faSortUp : faSortDown) : faSort"
                        aria-hidden="true"></fa-icon>
                </th>

                <th class="sortable"
                    (click)="ordenarPor('descripcion')"
                    [attr.aria-sort]="ariaSortFor('descripcion')"
                    role="button"
                    matTooltip="Ordenar por descripción">
                Descripción
                <fa-icon class="sort-icon"
                        [icon]="sortBy==='descripcion' ? (sortDir==='asc'? faSortUp : faSortDown) : faSort"></fa-icon>
                </th>

                <th class="sortable"
                    (click)="ordenarPor('estado')"
                    [attr.aria-sort]="ariaSortFor('estado')"
                    role="button"
                    matTooltip="Ordenar por estado">
                Estado
                <fa-icon class="sort-icon"
                        [icon]="sortBy==='estado' ? (sortDir==='asc'? faSortUp : faSortDown) : faSort"></fa-icon>
                </th>

                <th class="sortable"
                    (click)="ordenarPor('costo')"
                    [attr.aria-sort]="ariaSortFor('costo')"
                    role="button"
                    matTooltip="Ordenar por costo">
                Costo
                <fa-icon class="sort-icon"
                        [icon]="sortBy==='costo' ? (sortDir==='asc'? faSortUp : faSortDown) : faSort"></fa-icon>
                </th>

                <th class="sortable"
                    (click)="ordenarPor('total')"
                    [attr.aria-sort]="ariaSortFor('total')"
                    role="button"
                    matTooltip="Ordenar por precio">
                Precio
                <fa-icon class="sort-icon"
                        [icon]="sortBy==='total' ? (sortDir==='asc'? faSortUp : faSortDown) : faSort"></fa-icon>
                </th>

                <th class="sortable"
                    (click)="ordenarPor('aCuenta')"
                    [attr.aria-sort]="ariaSortFor('aCuenta')"
                    role="button"
                    matTooltip="Ordenar por anticipo">
                A cuenta
                <fa-icon class="sort-icon"
                        [icon]="sortBy==='aCuenta' ? (sortDir==='asc'? faSortUp : faSortDown) : faSort"></fa-icon>
                </th>

                <th class="sortable"
                    (click)="ordenarPor('resta')"
                    [attr.aria-sort]="ariaSortFor('resta')"
                    role="button"
                    matTooltip="Ordenar por resto">
                Resta
                <fa-icon class="sort-icon"
                        [icon]="sortBy==='resta' ? (sortDir==='asc'? faSortUp : faSortDown) : faSort"></fa-icon>
                </th>

                <th>Tot. Ingreso</th>
                <th>Utilidad</th>
                <th>% Gan</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            <ng-container *ngFor="let pedido of pedidos">
                <tr>
                    <td>
                        <button class="btn-verde btn-icono"
                            [matTooltip]="pedidoDetalleAbiertoId === pedido._id ? 'Cerrar detalle' : 'Ver detalle'"
                            (click)="pedidoDetalleAbiertoId === pedido._id ? cerrarDetallePedido(pedido) : abrirDetallePedido(pedido)">
                            <fa-icon [icon]="pedidoDetalleAbiertoId === pedido._id ? 'minus' : 'plus'"
                                [ngClass]="pedidoDetalleAbiertoId === pedido._id ? 'icono-rotado' : 'icono-normal'">
                            </fa-icon>
                        </button>
                    </td>
                    <td>{{ pedido.folio }}</td>
                    <td>{{ pedido.fechaPedido | date: 'dd/MM/yyyy':'America/Mexico_City' }}</td>
                    <td>
                        <div>{{ pedido.cliente?.nombre || 'sin cliente' }}</div>
                        <small class="text-muted" *ngIf="pedido.cliente?.telefono">
                            Tel.: {{ pedido.cliente?.telefono }}
                        </small>
                    </td>
                    <td>{{ pedido.descripcion }}</td>
                    <td>{{ pedido.estado }}</td>
                    <td>
                        <ng-container *ngIf="modoEdicionId  === pedido._id; else mostrarCosto">
                            <input type="number" [(ngModel)]="costoEditado" class="form-control form-control-sm"
                                style="width: 80px;">
                        </ng-container>
                        <ng-template #mostrarCosto>
                            {{ pedido.costo | currency }}
                        </ng-template>
                    </td>
                    <td>{{ pedido.total | currency }}</td>
                    <td>{{ pedido.aCuenta | currency }}</td>
                    <td>{{ pedido.resta | currency }}</td>
                    <td>{{ ((pedido.total || 0) - (pedido.resta || 0)) | currency }}</td>
                    <td>{{ ((pedido.total || 0) - (pedido.resta || 0) - (pedido.costo || 0)) | currency }}</td>
                    <td>
                        {{
                            (pedido.costo > 0
                            ? (((pedido.total || 0) - (pedido.resta || 0) - (pedido.costo || 0)) / pedido.costo) * 100
                            : 0) | number:'1.1-2'
                        }}%
                    </td>

                    <td class="d-flex gap-1 align-items-center">
                        <div class="d-flex justify-content-center">
                            <!-- Botón Editar -->
                            <button class="btn-icon-chico btn-gris-chico" (click)="habilitarEdicion(pedido)"
                                [disabled]="modoEdicionId === pedido._id" matTooltip="Editar costo">
                                <fa-icon [icon]="faEdit"></fa-icon>
                            </button>

                            <!-- Botón Guardar -->
                            <button class="btn-icon-chico btn-verde-chico" (click)="guardarFila(pedido)"
                                [disabled]="modoEdicionId !== pedido._id" matTooltip="Guardar costo">
                                <fa-icon [icon]="faSave"></fa-icon>
                            </button>

                            <!-- Botón Cancelar -->
                            <button class="btn-icon-chico btn-rojo-chico" (click)="cancelarEdicion()"
                                [disabled]="modoEdicionId !== pedido._id" matTooltip="Cancelar">
                                <fa-icon [icon]="faTimes"></fa-icon>
                            </button>
                        </div>
                    </td>

                </tr>

                <!-- Detalle del pedido -->
                <tr *ngIf="pedidoDetalleAbiertoId === pedido._id">
                    <td colspan="100">
                        <div class="detalle-tabla-wrapper">
                            <table class="detalle-tabla">
                                <thead>
                                    <tr>
                                        <th colspan="2">Estado: {{ pedido.estado }}</th>
                                        <th colspan="1">Costo: {{ (pedido.costo) || 0 | currency }}</th>
                                        <th colspan="1">Precio: {{ (pedido.total) || 0 | currency }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="2" class="sub-title-tabla">Anticipo: {{ pedido.aCuenta | currency}}
                                        </td>
                                        <td colspan="2" class="sub-title-tabla">Resta: {{ pedido.resta | currency}}</td>
                                    </tr>
                                    <tr>
                                        <td>Efectivo:</td>
                                        <td>{{ (pedido.pagoACuenta.efectivo || 0) | currency }}</td>
                                        <td>Efectivo:</td>
                                        <td>{{ (pedido.pagoResta.efectivo || 0) | currency }}</td>
                                    </tr>
                                    <tr>
                                        <td>Tarjeta:</td>
                                        <td>{{ (pedido.pagoACuenta.tarjeta || 0) | currency }}</td>
                                        <td>Tarjeta:</td>
                                        <td>{{ (pedido.pagoResta.tarjeta || 0) | currency }}</td>
                                    </tr>
                                    <tr>
                                        <td>Transferencia:</td>
                                        <td>{{ (pedido.pagoACuenta.transferencia || 0) | currency }}</td>
                                        <td>Transferencia:</td>
                                        <td>{{ (pedido.pagoResta.transferencia || 0) | currency }}</td>
                                    </tr>
                                    <tr>
                                        <td>Monedero:</td>
                                        <td>{{ (pedido.pagoACuenta.vale || 0) | currency }}</td>
                                        <td>Monedero</td>
                                        <td>{{ (pedido.pagoResta.vale || 0) | currency }}</td>
                                    </tr>
                                    <tr *ngIf="esAdmin">
                                        <td colspan="1">Levantó:</td>
                                        <td colspan="2">{{ pedido.usuarioPidio.nombre || '—'}}</td>
                                        <td colspan="1">
                                            {{ pedido.fechaPedido ? (pedido.fechaPedido | date:'dd/MM/yyyy':'America/Mexico_City') : '—' }}
                                        </td>
                                    </tr>
                                    <tr *ngIf="pedido.estado === 'entregado' && esAdmin">
                                        <td colspan="1">Surtió:</td>
                                        <td colspan="2">{{ pedido.usuarioSurtio?.nombre || '—' }}</td>
                                        <td colspan="1">
                                            {{ pedido.fechaEntrega ? (pedido.fechaEntrega | date:'dd/MM/yyyy':'America/Mexico_City') : '—' }} 
                                        </td>
                                    </tr>
                                    <tr *ngIf="pedido.estado === 'cancelado' && esAdmin">
                                        <td colspan="1">Canceló:</td>
                                        <td colspan="2">{{ pedido.usuarioCancelo?.nombre || '—' }}</td>
                                        <td colspan="1">
                                            {{ pedido.fechaCancelacion ? (pedido.fechaCancelacion | date:'dd/MM/yyyy':'America/Mexico_City') : '—' }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>

            </ng-container>
        </tbody>

        <tfoot>
            <tr>
                <td colspan="6" class="text-end fw-bold">Totales:</td>
                <td class="fw-bold">{{ totalCosto | currency }}</td>
                <td class="fw-bold">{{ totalPrecio | currency }}</td>
                <td class="fw-bold">{{ totalAcuenta | currency }}</td>
                <td class="fw-bold">{{ totalResta | currency }}</td>
                <td class="fw-bold">{{ totalIngreso | currency }}</td>
                <td class="fw-bold">{{ utilidadTotal | currency }}</td>
                <td class="fw-bold">{{ porcentajeUtilidad | number:'1.1-2' }}%</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <div class="paginacion" *ngIf="paginacion?.pages">
        <button (click)="cambiarPagina(1)" [disabled]="paginacion.page <= 1" matTooltip="Inicio">
            <i class="fa fa-angle-double-left"></i>
        </button>
        <button (click)="cambiarPagina(paginacion.page - 1)" [disabled]="!paginacion.hasPrev" matTooltip="Anterior">
            <i class="fa fa-angle-left"></i>
        </button>

        <span> Página {{ paginacion.page }} de {{ paginacion.pages }} ({{ paginacion.total }} registros) </span>

        <button (click)="cambiarPagina(paginacion.page + 1)" [disabled]="!paginacion.hasNext" matTooltip="Siguiente">
            <i class="fa fa-angle-right"></i>
        </button>
        <button (click)="cambiarPagina(paginacion.pages)" [disabled]="paginacion.page >= paginacion.pages" matTooltip="Fin">
            <i class="fa fa-angle-double-right"></i>
        </button>

        <span class="ms-3">Filas pág.:</span>
        <select
            class="form-select form-select-sm d-inline-block w-auto ms-2"
            [(ngModel)]="limit"
            (ngModelChange)="page=1; buscarSinFolio();">
            <option [ngValue]="10">10</option>
            <option [ngValue]="20">20</option>
            <option [ngValue]="50">50</option>
            <option [ngValue]="100">100</option>
        </select>
    </div>

    <p *ngIf="filtroFolio.length === 6 && pedidos.length === 0" class="no-found-error">
        El folio del pedido no existe ó ya no está pendiente de entrega.
    </p>
</div>