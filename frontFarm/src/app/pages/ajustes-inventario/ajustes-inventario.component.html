<div class="panel">
    <div class="titulo-container d-flex justify-content-between align-items-center">
        <h1 class="titulo">Ajuste de Inventario en Almacen</h1>

        <button type="button" class="btn-amarillo-chico d-flex align-items-center" (click)="abrirNuevoProducto()"
            matTooltip="Agregar un nuevo producto">
            <fa-icon [icon]='faPlus'></fa-icon>
            <span class="ms-1">Nuevo</span>
        </button>
    </div>


    <!-- Filtros -->
    <div class="row mb-2 filtros-container">
        <div class="col-md-3">
            <label class="me-2 mb-0" style="white-space: nowrap;">Nombre</label>
            <div class="position-relative">
                <input type="text" [(ngModel)]="filtros.nombre" name="nombre" class="form-control pe-4 flex-grow-1">
                <button *ngIf="filtros.nombre" type="button" matTooltip="Limpiar nombre"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('nombre')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <div class="col-md-2">
            <label class="me-2 mb-0" style="white-space: nowrap;">C√≥digo de barras</label>
            <div class="position-relative">
                <input type="text" [(ngModel)]="filtros.codigoBarras" name="codigoBarras"
                    class="form-control pe-4 flex-grow-1">
                <button *ngIf="filtros.codigoBarras" type="button" matTooltip="Limpiar c√≥d. barras"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('codigoBarras')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <div class="col-md-2">
            <label class="me-2 mb-0" style="white-space: nowrap;">Categor√≠a</label>
            <div class="position-relative">
                <input type="text" [(ngModel)]="filtros.categoria" name="categoria"
                    class="form-control pe-4 flex-grow-1">
                <button *ngIf="filtros.categoria" type="button" matTooltip="Limpiar categor√≠a"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('categoria')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <div class="col-md-1">
            <label class="me-2 mb-0" style="white-space: nowrap;">INAPAM</label>
            <div class="position-relative">
                <select [(ngModel)]="filtros.descuentoINAPAM" name="descuentoINAPAM"
                    class="form-control pe-4 flex-grow-1">
                    <option [ngValue]="null">--</option>
                    <option [ngValue]="true">S√≠</option>
                    <option [ngValue]="false">No</option>
                </select>
                <button *ngIf="filtros.descuentoINAPAM !== null" type="button" matTooltip="Limpiar INAPAM"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('descuentoINAPAM')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>
        <div class="col-md-1">
            <label class="me-2 mb-0" style="white-space: nowrap;">Gen√©rico?</label>
            <div class="position-relative">
                <select [(ngModel)]="filtros.generico" name="generico" class="form-control pe-4 flex-grow-1">
                    <option [ngValue]="null">--</option>
                    <option [ngValue]="true">S√≠</option>
                    <option [ngValue]="false">No</option>
                </select>
                <button *ngIf="filtros.generico !== null" type="button" matTooltip="Limpiar gen√©rico"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('generico')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <div class="col-md-2">
            <label class="me-2 mb-0" style="white-space: nowrap;">Solo bajo stock</label>
            <div class="position-relative">
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" id="filtroBajoStock" [(ngModel)]="filtros.bajoStock"
                        name="bajoStock" (change)="aplicarFiltros()" />
                    <label class="form-check-label" for="filtroBajoStock">
                        Existencia &lt; Stock M√≠n.
                    </label>
                </div>

                <!-- Bot√≥n limpiar (opcional, √∫til si quieres apagar de un clic el flag) -->
                <button *ngIf="filtros.bajoStock" type="button"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('bajoStock')" matTooltip="Quitar filtro bajo stock">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <div class="col-md-1 text-end mt-3">
            <button class="btn-gris" [disabled]="filtrando || iniciando" [attr.aria-busy]="filtrando || iniciando"
                matTooltip="Filtrar informaci√≥n solicitada" (click)="aplicarFiltros()">
                <i class="fa fa-spinner fa-spin me-1" *ngIf="filtrando || iniciando"></i>
                {{ filtrando ? 'Filtrando‚Ä¶' : (iniciando ? 'Iniciando‚Ä¶' : 'Buscar') }}
            </button>
        </div>

        <div class="col-md-2">
            <label class="me-2 mb-0 mt-2" style="white-space: nowrap;">C√≥digo Barras</label>
            <div class="position-relative">
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" id="filtroCBDuplicados"
                        [(ngModel)]="filtros.duplicadosCB" name="duplicadosCB" (change)="aplicarFiltros()" />
                    <label class="form-check-label" for="filtroCBDuplicados">
                        Mostrar duplicados
                    </label>
                </div>

                <button *ngIf="filtros.duplicadosCB" type="button"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('duplicadosCB')" matTooltip="Quitar filtro de duplicados">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

    </div>

    <!-- Cambios Masivos -->
    <form [formGroup]="formularioMasivo" class="masivos">
        <div class="center-content">
            <label class="subtitulo" style="margin-right: 10px;">Cambio masivo</label>
            <label>(aplica a productos seleccionados en la tabla)</label>
        </div>

        <!-- üü¢ Zona General -->
        <div class="container-masivos mb-1">
            <div>
                <label class="tit-promo" style="margin-right: 1rem;">Datos b√°sicos:</label>
                <label style="margin-right: 10px;">Categor√≠a:</label>
                <input style="width: 100px; margin-right: 2rem;" type="text" formControlName="categoria">
                <label style="margin-right: 10px;">Stock M√≠nimo:</label>
                <input style="width: 50px; margin-right: 2rem;" type="number" formControlName="stockMinimo">
                <label style="margin-right: 10px;">Stock M√°ximo:</label>
                <input style="width: 50px; margin-right: 2rem;" type="number" formControlName="stockMaximo">
                <label style="margin-right: 10px;">INAPAM:</label>
                <select formControlName="descuentoINAPAM">
                    <option [ngValue]="null">--</option>
                    <option [ngValue]="true">S√≠</option>
                    <option [ngValue]="false">No</option>
                </select>
            </div>
            <!-- üü° Zona Ajuste de Precios -->
            <div>
                <label class="tit-promo" style="margin-right: 2rem;">Aumentar o disminuir Precios:</label>

                <label [ngClass]="{'selected-radio': formularioMasivo.get('ajustePrecioModo')?.value === 'porcentaje'}"
                    style="margin-right: 1rem;">
                    <input type="radio" formControlName="ajustePrecioModo" value="porcentaje">Porcentaje
                </label>
                <label [class.disabled-label]="formularioMasivo.get('ajustePrecioModo')?.value != 'porcentaje'"
                    style="margin-right: 10px;">%:</label>
                <input [class.disabled-label]="formularioMasivo.get('ajustePrecioModo')?.value != 'porcentaje'"
                    type="number" style="width: 50px; margin-right: 4rem;" formControlName="ajustePrecioPorcentaje">

                <label [ngClass]="{'selected-radio': formularioMasivo.get('ajustePrecioModo')?.value === 'cantidad'}"
                    style="margin-right: 1rem;">
                    <input type="radio" formControlName="ajustePrecioModo" value="cantidad">Cantidad
                </label>
                <label [class.disabled-label]="formularioMasivo.get('ajustePrecioModo')?.value != 'cantidad'"
                    style="margin-right: 10px;">$:</label>
                <input [class.disabled-label]="formularioMasivo.get('ajustePrecioModo')?.value != 'cantidad'"
                    type="number" style="width: 50px; margin-right: 5rem;" formControlName="ajustePrecioCantidad">
            </div>
        </div>

        <!-- Zona Promociones -->
        <div>

            <!-- üîµ Promo Cantidad Requerida -->
            <div class="container-masivos mb-1">
                <div>
                    <label style="margin-right: 10px;" class="tit-promo">Promo Cantidad Requerida:</label>
                    <select formControlName="promoCantidadRequerida" style="margin-right: 1rem;">
                        <option [ngValue]="null">--</option>
                        <option [ngValue]="2">2x1</option>
                        <option [ngValue]="3">3x2</option>
                        <option [ngValue]="4">4x3</option>
                    </select>
                    <label style="margin-right: 10px;">Inicia:</label>
                    <input type="date" formControlName="inicioPromoCantidad" style="margin-right: 1rem;">
                    <label style="margin-right: 10px;">Termina:</label>
                    <input type="date" formControlName="finPromoCantidad">
                </div>

                <!-- üü£ Promo Temporada -->
                <div>
                    <label class="tit-promo" style="margin-right: 10px;">Promo Temporada:</label>
                    <label style="margin-right: 10px;">% Desc.:</label>
                    <input style="width: 50px; margin-right: 1rem;" type="number"
                        formControlName="promoDeTemporadaPorcentaje">
                    <label style="margin-right: 10px;">Inicia:</label>
                    <input style="margin-right: 1rem;" type="date" formControlName="promoDeTemporadaInicio">
                    <label style="margin-right: 10px;">Termina:</label>
                    <input style="margin-right: 1rem;" type="date" formControlName="promoDeTemporadaFin">
                    <label style="margin-right: 10px;">Monedero:</label>
                    <select formControlName="promoDeTemporadaMonedero" style="margin-right: 2rem;">
                        <option [ngValue]="null">--</option>
                        <option [ngValue]="true">S√≠</option>
                        <option [ngValue]="false">No</option>
                    </select>
                </div>
            </div>

            <!-- üü§ Promo por D√≠a -->
            <div [formGroup]="promosPorDiaForm" style="margin-top: 10px;">
                <div *ngFor="let dia of diasSemana">
                    <div [formGroupName]="'promo' + dia" class="row" style="margin-bottom: 5px;">

                        <div class="col-2"><label class="tit-promo" style="margin-left: 3rem;">Promo {{ dia }}:</label>
                        </div>

                        <div class="col-2"><label style="margin-right: 10px;">% Desc.:</label>
                            <input type="number" formControlName="porcentaje" style="width:50px; height: 20px;">
                        </div>

                        <div class="col-3"><label style="margin-right: 10px;">Inicia:</label>
                            <input type="date" formControlName="inicio">
                        </div>

                        <div class="col-3"><label style="margin-right: 10px;">Termina:</label>
                            <input type="date" formControlName="fin">
                        </div>

                        <div class="col-2"><label style="margin-right: 10px;">Monedero:</label>
                            <select formControlName="monedero">
                                <option [ngValue]="null">--</option>
                                <option [ngValue]="true">S√≠</option>
                                <option [ngValue]="false">No</option>
                            </select>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="modal-actions mt-3">
            <button class="btn-rojo-chico" style="margin-left: 4rem;" type="button"
                matTooltip="Borrar par√°metros del cambio masivo" (click)="limpiarCamposCambioMasivo()">Cancelar
            </button>
            <button class="btn-verde-chico" style="margin-right: 4rem;" type="button"
                matTooltip="Aplica cambios a los productos seleccionados en la tabla"
                [disabled]="!cambiosMasivosValidos" (click)="aplicarCambiosMasivos()">
                Aplicar Cambios
            </button>
        </div>
    </form>

    <table class="tabla">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" (change)="seleccionarTodos($event)">
                </th>
                <th>Imagen</th>
                <th (click)="ordenar('nombre')">
                    Nombre / Ubic.
                    <i [ngClass]="{
                        'bi': true,
                        'bi-caret-up-fill': columnaOrden === 'nombre' && direccionOrden === 'asc',
                        'bi-caret-down-fill': columnaOrden === 'nombre' && direccionOrden === 'desc',
                        'bi-caret-up': columnaOrden !== 'nombre'
                    }" class="icono-orden"></i>
                </th>
                <th (click)="ordenar('codigoBarras')">
                    C√≥digo Barras
                    <i [ngClass]="{
                        'bi': true,
                        'bi-caret-up-fill': columnaOrden === 'codigoBarras' && direccionOrden === 'asc',
                        'bi-caret-down-fill': columnaOrden === 'codigoBarras' && direccionOrden === 'desc',
                        'bi-caret-up': columnaOrden !== 'codigoBarras'
                    }" class="icono-orden"></i>
                </th>
                <th (click)="ordenar('categoria')">
                    Categor√≠a
                    <i [ngClass]="{
                        'bi': true,
                        'bi-caret-up-fill': columnaOrden === 'categoria' && direccionOrden === 'asc',
                        'bi-caret-down-fill': columnaOrden === 'categoria' && direccionOrden === 'desc',
                        'bi-caret-up': columnaOrden !== 'categoria'
                    }" class="icono-orden"></i>
                </th>
                <th>Gen√©rico</th>
                <th>Stock M√≠n.</th>
                <th>Stock M√°x.</th>
                <th (click)="ordenar('existencia')">
                    Existencia
                    <i [ngClass]="{
                        'bi': true,
                        'bi-caret-up-fill': columnaOrden === 'existencia' && direccionOrden === 'asc',
                        'bi-caret-down-fill': columnaOrden === 'existencia' && direccionOrden === 'desc',
                        'bi-caret-up': columnaOrden !== 'existencia'
                    }" class="icono-orden"></i>
                </th>
                <th>INAPAM</th>
                <th>Costo</th>
                <th>Precio</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let p of productosPagina; trackBy: trackProdBy" [class.fila-modificada]="p['modificado']">
                <td><input type="checkbox" [(ngModel)]="p.seleccionado"></td>
                <td>
                    <div class="img-cell" [class.loading]="subiendoId === p._id">

                        <!-- bot√≥n-imagen (abre file) -->
                        <button type="button" class="img-button" (click)="file.click()"
                            [disabled]="subiendoId === p._id"
                            [attr.aria-label]="p.imagen ? 'Cambiar imagen' : 'Agregar imagen'"
                            matTooltip="Cambiar √≥ Subir imagen">
                            <img
                                [src]="p._imgSrc || placeholderSrc"
                                (error)="onImgError($event,p)"
                                loading="lazy" decoding="async"
                            />

                            <span class="overlay" *ngIf="subiendoId !== p._id">
                                <i class="fas fa-upload"></i>
                            </span>
                            <span class="overlay" *ngIf="subiendoId === p._id">
                                <i class="fa fa-spinner fa-spin"></i>
                            </span>
                        </button>

                        <!-- üîç lupa: abre preview grande (NO dispara el file) -->
                        <button type="button" class="zoom-btn" (click)="$event.stopPropagation(); openPreview(p)"
                            [disabled]="subiendoId === p._id" matTooltip="Ver imagen">
                            <i class="fas fa-search-plus"></i>
                        </button>

                        <!-- input file oculto -->
                        <input #file type="file" accept="image/*" style="display:none"
                            (change)="onFileChange($event, p)" />
                    </div>
                </td>


                <td class="col-producto">
                    <div class="prod-nombre">{{ p.nombre }}</div>
                    <small class="prod-ubicacion" *ngIf="p.ubicacion">{{ p.ubicacion }}</small>
                </td>
                <td>{{ p.codigoBarras }}</td>
                <td>{{ p.categoria }}</td>
                <td style="text-align: center;">
                    <input type="checkbox" [checked]="p.generico" disabled>
                </td>
                <td>{{ p.stockMinimo }}</td>
                <td>{{ p.stockMaximo }}</td>
                <td [class.text-danger]="getExistencia(p) < (p.stockMinimo || 0)">
                    {{ getExistencia(p) }}
                </td>

                <td style="text-align: center;">
                    <input type="checkbox" [checked]="p.descuentoINAPAM" disabled>
                </td>
                <td>{{ p.costo | currency }}</td>
                <td>{{ p.precio |currency }}</td>
                <td>
                    <button class="btn-icon-chico btn-gris-chico" (click)="editarProducto(p)"
                        matTooltip="Editar producto">
                        <fa-icon [icon]="'pen'"></fa-icon>
                    </button>
                    <button class="btn-icon-chico btn-rojo-chico" (click)="confirmarEliminar(p)"
                        [disabled]="eliminandoId === p._id" matTooltip="Eliminar producto en TODAS las farmacias">
                        <i *ngIf="eliminandoId !== p._id" class="fas fa-trash"></i>
                        <i *ngIf="eliminandoId === p._id" class="fa fa-spinner fa-spin"></i>
                    </button>
                </td>

            </tr>
        </tbody>
    </table>
    <div class="paginacion">
        <button (click)="paginaActual = 1" [disabled]="paginaActual === 1" matTooltip="Inicio">
            <i class="fa fa-angle-double-left"></i>
        </button>

        <button (click)="paginaActual = paginaActual - 1" [disabled]="paginaActual === 1" matTooltip="Anterior">
            <i class="fa fa-angle-left"></i>
        </button>

        P√°gina {{ paginaActual }} de {{ totalPaginas }}
        <span class="total-registros">({{ productosFiltrados.length }} productos)</span>

        <button (click)="paginaActual = paginaActual + 1" [disabled]="paginaActual === totalPaginas"
            matTooltip="Siguiente">
            <i class="fa fa-angle-right"></i>
        </button>

        <button (click)="paginaActual = totalPaginas" [disabled]="paginaActual === totalPaginas" matTooltip="Fin">
            <i class="fa fa-angle-double-right"></i>
        </button>
    </div>

    <!-- Overlay -->
    <div class="modal-backdrop" *ngIf="mostrarNuevoProducto" #backdrop tabindex="-1"
        (keydown.escape)="cerrarNuevoProducto()">
        <!-- Caja del modal -->
        <div class="modal-dialog" role="dialog" aria-modal="true" (mousedown)="$event.stopPropagation()"
            (click)="$event.stopPropagation()">
            <h3 class="titulo text-center mb-3">Nuevo producto</h3>

            <form [formGroup]="nuevoProductoForm" autocomplete="off">
                <div class="row g-3">
                    <div class="col-12">
                        <label>Nombre *</label>
                        <input type="text" formControlName="nombre" #firstInput class="form-control" />
                    </div>

                    <div class="col-6">
                        <label>Rengl√≥n 1</label>
                        <input type="text" formControlName="renglon1" class="form-control" />
                    </div>
                    <div class="col-6">
                        <label>Rengl√≥n 2</label>
                        <input type="text" formControlName="renglon2" class="form-control" />
                    </div>

                    <div class="col-3">
                        <label>C√≥digo de barras *</label>
                        <input type="text" formControlName="codigoBarras" class="form-control" />
                    </div>
                    <div class="col-3">
                        <label>Categor√≠a *</label>
                        <input type="text" formControlName="categoria" class="form-control" />
                    </div>
                    <div class="col-2">
                        <label>Unidad *</label>
                        <input type="text" formControlName="unidad" class="form-control" />
                    </div>
                    <div class="col-2">
                        <label>Precio *</label>
                        <input type="number" formControlName="precio" class="form-control" />
                    </div>
                    <div class="col-2">
                        <label>Costo *</label>
                        <input type="number" formControlName="costo" class="form-control" />
                    </div>

                    <div class="col-2">
                        <label>Stock M√≠n *</label>
                        <input type="number" formControlName="stockMinimo" class="form-control" />
                    </div>

                    <div class="col-2">
                        <label>Stock M√°x *</label>
                        <input type="number" formControlName="stockMaximo" class="form-control" />
                    </div>

                    <div class="col-2 form-check-vertical">
                        <label for="chkIva" class="form-label">IVA</label>
                        <input type="checkbox" class="form-check-input" formControlName="iva" id="chkIva" />
                    </div>

                    <div class="col-2 form-check-vertical">
                        <label for="chkGen" class="form-label">Gen√©rico</label>
                        <input type="checkbox" class="form-check-input" formControlName="generico" id="chkGen" />
                    </div>

                    <div class="col-2 form-check-vertical">
                        <label for="chkINA" class="form-label">INAPAM</label>
                        <input type="checkbox" class="form-check-input" formControlName="descuentoINAPAM" id="chkINA" />
                    </div>

                    <div class="col-2">
                        <label>Ubicaci√≥n</label>
                        <input type="text" formControlName="ubicacion" class="form-control" />
                    </div>

                </div>
            </form>

            <div class="modal-actions mt-3">
                <button type="button" class="btn-rojo-chico w-100" (click)="cerrarNuevoProducto()">Cancelar</button>
                <button type="button" class="btn-verde-chico w-100"
                    [disabled]="nuevoProductoForm.invalid || guardandoNuevo" (click)="guardarNuevoProducto()">
                    {{ guardandoNuevo ? 'Guardando‚Ä¶' : 'Guardar' }}
                </button>
            </div>
        </div>
    </div>

</div>