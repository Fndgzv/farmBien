<!-- frontFarm/src/app/pages/surtir-farmacia.component.html -->
<div class="surtir-farmacia">
  <div class="titulo-container">
    <p class="titulo">Surtir Farmacias</p>
  </div>

  <form [formGroup]="form" (ngSubmit)="onAceptar()" style="border-bottom:2px solid #0453b3; padding-bottom: 1rem; display:flex; gap:.75rem; align-items:end; flex-wrap:wrap;">
    <label>
      <span class="subtitulo">Farmacia:</span>
      <select formControlName="farmaciaId">
        <option [ngValue]="null">-- Selecciona --</option>
        <option *ngFor="let f of farmacias" [ngValue]="f._id">
          {{ f.nombre }}
        </option>
      </select>
    </label>

    <label>
      <span class="subtitulo">Categoría:</span>
      <input type="text" formControlName="categoria"/>
    </label>

    <label>
      <span class="subtitulo">Ubic.&nbsp;Almacén:</span>
      <input type="text" formControlName="ubicacion"/>
    </label>

    <label>
      <span class="subtitulo">Ubic.&nbsp;Farmacia:</span>
      <input type="text" formControlName="ubicacionFarmacia"/>
    </label>
    
    <button type="submit" class="btn-gris"
            [disabled]="form.get('farmaciaId')?.invalid || cargando || pendientes.length > 0"
            matTooltip="Buscar productos que requieren surtirse">
      {{ cargando ? 'Cargando…' : 'Aceptar' }}
    </button>

    <button type="button" class="btn-rojo-tache"
            (click)="limpiarFiltros()"
            [disabled]="form.get('farmaciaId')?.invalid || cargando || pendientes.length > 0"
            matTooltip="Limpiar filtros">
            <i class="fas fa-times"></i>
    </button>
  </form>

  <div *ngIf="pendientes.length" class="toolbar" style="margin: .5rem 0; display:flex; gap:.5rem; align-items:center;">
    <button class="btn-gris" (click)="omitirTodos()" matTooltip="Marca todos como omitidos">Omitir todos</button>
    <button class="btn-gris" (click)="quitarOmisiones()" matTooltip="Quita todas las omisiones">Quitar
      omisiones</button>
    <span style="margin-left:auto; font-size: .9rem;">
      Omitidos: <strong>{{ totalOmitidos }}</strong> / {{ rows.length }}
    </span>
    <div *ngIf="pendientes.length" class="toolbar"
      style="margin: .5rem 0; display:flex; gap:.5rem; align-items:center;">
      <button class="btn-verde" (click)="imprimirPrevia()" matTooltip="Imprime la hoja de surtido con las omisiones">
        Imprimir previa
      </button>
    </div>

    <button class="btn-amarillo" (click)="exportarExcel()" [disabled]="!rows.length"
      matTooltip="Exporta todos los registros de la tabla">
      Exportar a Excel
    </button>

  </div>

  <table *ngIf="pendientes.length" class="tabla">
  <thead>
    <tr>
      <th>Omit</th>
      <th>Producto - CB</th>

      <th class="th-sort" (click)="setSort('categoria')">
        Categoría
        <span class="sort-arrow">{{ getSortArrow('categoria') }}</span>
      </th>

      <th class="th-sort" (click)="setSort('ubicacion')">
        Ubic almac
        <span class="sort-arrow">{{ getSortArrow('ubicacion') }}</span>
      </th>

      <th class="th-sort" (click)="setSort('ubicacionFarmacia')">
        Ubic farma
        <span class="sort-arrow">{{ getSortArrow('ubicacionFarmacia') }}</span>
      </th>

      <th class="th-sort" (click)="setSort('existenciaActual')">
        Existencia
        <span class="sort-arrow">{{ getSortArrow('existenciaActual') }}</span>
      </th>

      <th>Stock Mínimo</th>
      <th>Stock Máximo</th>

      <th class="th-sort" (click)="setSort('falta')">
        Faltante
        <span class="sort-arrow">{{ getSortArrow('falta') }}</span>
      </th>

      <th class="th-sort" (click)="setSort('podranSurtirse')">
        Podrán surtir
        <span class="sort-arrow">{{ getSortArrow('podranSurtirse') }}</span>
      </th>

      <th class="th-sort" (click)="setSort('disponibleEnAlmacen')">
        Disponible Almacén
        <span class="sort-arrow">{{ getSortArrow('disponibleEnAlmacen') }}</span>
      </th>

      <th class="th-sort" (click)="setSort('faltanEnAlmacen')">
        Faltan en almacén
        <span class="sort-arrow">{{ getSortArrow('faltanEnAlmacen') }}</span>
      </th>
    </tr>
  </thead>

    <tbody>
      <tr *ngFor="let p of pagedRows; trackBy: trackByProd" [class.omitido]="p.omitir">
        <td style="text-align:center;">
          <input type="checkbox" class="chk-omit" [(ngModel)]="p.omitir" name="omitir_{{ p.producto }}"
            [attr.aria-label]="'Omitir ' + p.nombre" matTooltip="Si está activado, este producto no se surtirá" />
        </td>
        <td>
          <div style="font-size: smaller;">{{ p.nombre }}</div>
          <small class="codigo-mini">{{ p.codigoBarras }}</small>
        </td>
        <td>{{ p.categoria }}</td>
        <td>{{ p.ubicacion }}</td>
        <td>{{ p.ubicacionFarmacia }}</td>
        <td>{{ p.existenciaActual }}</td>
        <td>{{ p.stockMin }}</td>
        <td>{{ p.stockMax }}</td>
        <td class="falta">{{ p.falta }}</td>
        <td class="podranSurtir">{{ p.podranSurtirse }}</td>
        <td>{{ p.disponibleEnAlmacen }}</td>
        <td class="faltanAlmacen" [class.alto]="p.faltanEnAlmacen > 9">
            {{ p.faltanEnAlmacen }}
        </td>

      </tr>
    </tbody>
  </table>

  <div class="paginacion" *ngIf="totalItems > 0">
    <button (click)="goFirst()" [disabled]="page === 1" matTooltip="Inicio">
      <i class="fa fa-angle-double-left"></i>
    </button>
    <button (click)="goPrev()" [disabled]="page === 1" matTooltip="Anterior">
      <i class="fa fa-angle-left"></i>
    </button>

    Página {{ page }} de {{ totalPages }} — {{ totalItems }} registros

    <button (click)="goNext()" [disabled]="page === totalPages" matTooltip="Siguiente">
      <i class="fa fa-angle-right"></i>
    </button>
    <button (click)="goLast()" [disabled]="page === totalPages" matTooltip="Fin">
      <i class="fa fa-angle-double-right"></i>
    </button>
  </div>

  <div *ngIf="pendientes.length" class="botones-accion">
    <button (click)="onCancelar()" class="btn-rojo" matTooltip="Quitar lista sin surtir">Cancelar</button>
    <button (click)="onSurtir()" class="btn-verde a-la-derecha"
      [disabled]="rows.length > 0 && totalOmitidos === rows.length" matTooltip="Surtir los productos de la lista">
      Surtir
    </button>
  </div>
</div>