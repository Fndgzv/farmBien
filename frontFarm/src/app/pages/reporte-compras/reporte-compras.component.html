<!-- src/app/pages/compras/compras.component.html -->
<div class="filtros">
  <h2 class="titulo text-center">Reporte General de Compras</h2>
  <div class="row mb-3">
    <div class="col-3">
      <label style="white-space: nowrap;">Proveedor</label>
      <div class="position-relative">
        <input type="text" class="form-control" [(ngModel)]="proveedor" (keyup.enter)="buscar(true)"
          placeholder="Nombre del proveedor">
        <button *ngIf="proveedor" type="button"
          class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
          (click)="limpiarProveedor()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
    </div>

    <div class="col-3">
      <label style="white-space: nowrap;">Producto</label>
      <div class="position-relative">
        <input type="text" class="form-control" [(ngModel)]="productoNombre" (keyup.enter)="buscar(true)"
          placeholder="Nombre del producto">
        <button *ngIf="productoNombre" type="button"
          class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
          (click)="limpiarProducto()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
    </div>

    <div class="col-2">
      <label style="white-space: nowrap;">Código de barras</label>
      <div class="position-relative">
        <input type="text" class="form-control" [(ngModel)]="codigoBarras" (keyup.enter)="buscar(true)"
          placeholder="Código de barras">
        <button *ngIf="codigoBarras" type="button"
          class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
          (click)="limpiarCodigo()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
    </div>
    <div class="col-2">
      <label style="white-space: nowrap;">Importe desde</label>
      <div class="position-relative">
        <input type="number" class="form-control" [(ngModel)]="importeDesde" (keyup.enter)="buscar(true)">
        <button *ngIf="importeDesde" type="button" style="margin-right: 2rem;"
          class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
          (click)="limpiarDesde()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
    </div>
    <div class="col-2">
      <label style="white-space: nowrap;">Importe hasta</label>
      <div class="position-relative">
        <input type="number" class="form-control" [(ngModel)]="importeHasta" (keyup.enter)="buscar(true)">
        <button *ngIf="importeHasta" type="button" style="margin-right: 2rem;"
          class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
          (click)="limpiarHasta()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-2">
      <label style="white-space: nowrap;">Fecha inicial</label>
      <div class="position-relative">
        <input type="date" class="form-control" [(ngModel)]="fechaIni" (change)="buscar(true)">
        <button *ngIf="fechaIni" type="button" style="margin-right: 2.5rem;"
          class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
          (click)="limpiarIni()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
    </div>
    <div class="col-2">
      <label style="white-space: nowrap;">Fecha final</label>
      <div class="position-relative">
        <input type="date" class="form-control" [(ngModel)]="fechaFin" (change)="buscar(true)">
        <button *ngIf="fechaFin" type="button" style="margin-right: 2.5rem;"
          class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
          (click)="limpiarFin()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
    </div>

    <div class="col-4" style="text-align: start; margin-top: 1rem;">
      <button class="btn-rojo" (click)="limpiarFiltros()" [disabled]="cargando">
        <mat-icon>clear</mat-icon>&nbsp;Limpiar
      </button>
    </div>

    <div class="col-4" style="text-align: end; height: min-content; margin-top: 1rem;">
      <button class="btn-gris" (click)="buscar(true)" [disabled]="cargando">
        <mat-icon>search</mat-icon>&nbsp;Buscar
      </button>
    </div>
  </div>
</div>

<div [class.loading]="cargando">
  <table mat-table [dataSource]="rows" class="tabla" multiTemplateDataRows>

    <!-- Detalle -->
    <ng-container matColumnDef="acciones">
      <th mat-header-cell *matHeaderCellDef>Det.</th>
      <td mat-cell *matCellDef="let r">
        <button mat-icon-button (click)="toggleDetalle(r)" matTooltip="Ver detalle">
          <mat-icon>{{ expandedId === r.compraId ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </td>
      <td mat-footer-cell *matFooterCellDef></td>
    </ng-container>

    <!-- Fecha -->
    <ng-container matColumnDef="fecha">
      <th mat-header-cell *matHeaderCellDef>Fecha</th>
      <td mat-cell *matCellDef="let r">{{ r.fecha | date:'dd/MM/yyyy HH:mm' }}</td>
      <td mat-footer-cell *matFooterCellDef></td>
    </ng-container>

    <!-- Proveedor -->
    <ng-container matColumnDef="proveedor">
      <th mat-header-cell *matHeaderCellDef>Proveedor</th>
      <td mat-cell *matCellDef="let r">{{ r.proveedor }}</td>
      <td mat-footer-cell *matFooterCellDef class="text-end">
        <strong>Gran Total ==&gt;</strong>
      </td>
    </ng-container>

    <!-- Total -->
    <ng-container matColumnDef="total">
      <th mat-header-cell *matHeaderCellDef class="text-end">Total</th>
      <td mat-cell *matCellDef="let r" class="text-end fw-600">
        ${{ r.total | number:'1.2-2' }}
      </td>
      <td mat-footer-cell *matFooterCellDef class="text-end fw-700">
        {{ (footer?.totalCompras || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
      </td>
    </ng-container>

    <!-- Fila de detalle -->
    <ng-container matColumnDef="detail">
      <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
        <div class="detalle-tabla-wrapper">
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Código de Barras</th>
                <th class="text-end">Cantidad</th>
                <th>Lote</th>
                <th>Caducidad</th>
                <th class="text-end">Costo U.</th>
                <th class="text-end">Precio U.</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of row.productos; trackBy: trackByProd">
                <td>{{ p.nombre }}</td>
                <td>{{ p.codigoBarras }}</td>
                <td class="text-end">{{ p.cantidad | number }}</td>
                <td>{{ p.lote }}</td>
                <td>{{ p.fechaCaducidad | date:'dd/MM/yyyy' }}</td>
                <td class="text-end">${{ p.costoUnitario | number:'1.2-2' }}</td>
                <td class="text-end">${{ p.precioUnitario | number:'1.2-2' }}</td>
              </tr>
              <tr *ngIf="!row.productos || row.productos.length === 0">
                <td colspan="7" class="text-center text-muted">Sin productos en esta compra.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </td>
    </ng-container>

    <!-- Fila principal -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByCompra"></tr>

    <tr mat-row *matRowDef="let row; columns: ['detail']; when: isDetailRow"></tr>

    <tr mat-footer-row *matFooterRowDef="displayedColumns"
        [style.display]="rows.length ? '' : 'none'">
    </tr>

    <!-- Mensaje sin resultados -->
    <tr *ngIf="!cargando && rows.length === 0">
      <td [attr.colspan]="displayedColumns.length" class="text-center text-muted p-2">
        Sin resultados en el rango/criterios seleccionados.
      </td>
    </tr>
  </table>
</div>

<mat-paginator class="paginator-custom" [length]="paginacion.total || 0" [pageSize]="limit"
  [pageIndex]="(page - 1)" [pageSizeOptions]="[15, 30, 50, 100]" (page)="cambioPagina($event)"
  [showFirstLastButtons]="true">
</mat-paginator>
