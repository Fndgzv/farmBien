<div class="ventas-container">
  <div class="titulo-container">
    <h1 class="titulo">Ventas</h1>
  </div>

  <div class="row align-items-center mb-1">
    <div class="col-md-1">
      <h2 class="subtitulo">Cliente:</h2>
    </div>
    <div class="col-md-3">
      <mat-form-field class="compact-field wide-client" appearance="outline">
        <mat-label>Buscar cliente por nombre</mat-label>
        <input type="text" matInput [formControl]="clienteNombreCtrl" [matAutocomplete]="autoClientes" />

        <mat-autocomplete #autoClientes="matAutocomplete" [displayWith]="displayCliente"
          (optionSelected)="onClienteSelected($event.option.value)">
          <mat-option *ngFor="let c of filteredClientes$ | async" [value]="c">
            {{ c.nombre }}
            <small *ngIf="c.telefono"> â€” {{ c.telefono }}</small>
          </mat-option>
          <mat-option *ngIf="(filteredClientes$ | async)?.length === 0" disabled>
            Sin coincidencias
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <!-- Sugerencias nativas del navegador -->
      <datalist id="clientesList">
        <option *ngFor="let c of opcionesClientes" [value]="c.nombre + (c.telefono ? ' â€” ' + c.telefono : '')">
        </option>
      </datalist>
    </div>

    <div class="col-md-1 text-end">
      <label class="cliente-tel">TelÃ©fono:</label>
    </div>

    <div class="col-md-2 position-relative">
      <input type="text" [(ngModel)]="telefonoCliente" (input)="buscarCliente()" [disabled]="carrito.length > 0"
        class="form-control pe-5" />
      <button *ngIf="telefonoCliente" type="button" [disabled]="carrito.length > 0" (click)="limpiarCliente()"
        class="btn btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico">
        <fa-icon [icon]="faTimes"></fa-icon>
      </button>
    </div>

    <div class="col-md-3">
      <span *ngIf="nombreCliente" class="cliente-nombre">{{ nombreCliente }}</span>
    </div>

    <div class="col-md-2 text-end">
      <button (click)="abrirModalConsultaPrecio()" class="btn-gris consultar-precio">Consultar Precio</button>
    </div>
  </div>

  <div class="productos-container">
    <h2 class="subtitulo">Producto:</h2>

    <input #codigoBarrasRef type="text" id="codigoBarras" [(ngModel)]="codigoBarras"
      (keyup.enter)="agregarProductoPorCodigo()" placeholder="Escanear CÃ³d. barras" class="input-text input-cb"
      [attr.tabindex]="mostrarModalPago ? -1 : 0" [disabled]="mostrarModalPago" />

    <!-- Filtro por CÃ“DIGO venta -->
    <mat-form-field appearance="outline" class="compact-field wide-field mr-field">
      <mat-label>Buscar CÃ³d. barras</mat-label>
      <input matInput [(ngModel)]="busquedaPorCodigo" [matAutocomplete]="autoCodigo" (input)="filtrarPorCodigo()">
      <mat-autocomplete #autoCodigo="matAutocomplete" [displayWith]="displayCodigo"
        (optionSelected)="seleccionarPorCodigo($event)">
        <mat-option *ngFor="let p of productosFiltradosPorCodigo" [value]="p._id">
          {{ p.codigoBarras }} â€” {{ p.nombre }}
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>

    <!-- Filtro por NOMBRE venta -->
    <mat-form-field appearance="outline" class="compact-field wider-field">
      <mat-label>Buscar producto</mat-label>
      <input matInput [(ngModel)]="busquedaProducto" [matAutocomplete]="autoNombre" (input)="filtrarProductos()">
      <mat-autocomplete #autoNombre="matAutocomplete" [displayWith]="displayNombre"
        (optionSelected)="seleccionarProducto($event)">
        <mat-option *ngFor="let p of productosFiltrados" [value]="p._id">
          {{ p.nombre }}
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>

    <button (click)="limpiarProducto()" class="btn-rojo-tache">
      <i class="fas fa-times"></i>
    </button>
  </div>


  <div *ngIf="mostrarModalConsultaPrecio" class="modal-overlay">
    <div class="modal-content" style="width: 600px;">
      <h2>Consultar Precio</h2>
      <div class="input-container position-relative">
        <input type="text" [(ngModel)]="codigoConsulta" (keyup.enter)="consultarPrecio()" placeholder="CÃ³digo de barras"
          class="input-field">
        <button (click)="limpiarBarras()"
          class="btn btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>

      <div *ngIf="consultaEncontrado" class="consulta-img-wrap">
        <img [src]="consultaImgUrl" (error)="consultaImgUrl = placeholderSrc" alt="Imagen de producto">
      </div>

      <div *ngIf="!consultaEncontrado">
        <!-- ðŸ”Ž Filtro por CÃ“DIGO -->
        <mat-form-field appearance="outline" class="w-100 mb-1 compact-field">
          <input matInput [(ngModel)]="busquedaConsultaCodigo" [matAutocomplete]="autoConsCodigo"
            placeholder="Buscar CÃ³d. barras" (input)="filtrarConsultaPorCodigo()" />
          <mat-autocomplete #autoConsCodigo="matAutocomplete" (optionSelected)="onSelectConsultaCodigo($event)">
            <mat-option *ngFor="let p of productosConsultaFiltradosPorCodigo" [value]="p.codigoBarras">
              {{ p.codigoBarras }} â€” {{ p.nombre }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <!-- ðŸ”Ž Filtro por NOMBRE -->
        <mat-form-field appearance="outline" class="w-100 mb-1 compact-field">
          <input matInput [(ngModel)]="busquedaConsultaNombre" [matAutocomplete]="autoConsNombre"
            placeholder="Buscar producto por nombre" (input)="filtrarConsultaPorNombre()" />
          <mat-autocomplete #autoConsNombre="matAutocomplete" (optionSelected)="onSelectConsultaNombre($event)">
            <mat-option *ngFor="let p of productosConsultaFiltradosPorNombre" [value]="p.codigoBarras">
              {{ p.nombre }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>


      <div *ngIf="productoConsultado">
        <p><strong>Nombre: </strong>{{ productoConsultado.nombre }}</p>
        <p><strong>Precio Normal:</strong> {{ productoConsultado.precioNormal | currency }}</p>
        <p *ngIf="productoConsultado.promo1"><strong>{{ productoConsultado.promo1 }}</strong>{{
          productoConsultado.precioLunes }}</p>
        <p *ngIf="productoConsultado.lunesMasInapam">{{ productoConsultado.lunesMasInapam }}</p>

        <p *ngIf="productoConsultado.promo2"><strong>{{ productoConsultado.promo2 }}</strong>{{
          productoConsultado.precioMartes }}</p>
        <p *ngIf="productoConsultado.martesMasInapam">{{ productoConsultado.martesMasInapam }}</p>

        <p *ngIf="productoConsultado.promo3"><strong>{{ productoConsultado.promo3 }}</strong>{{
          productoConsultado.precioMiercoles }}</p>
        <p *ngIf="productoConsultado.miercolesMasInapam">{{ productoConsultado.miercolesMasInapam }}</p>

        <p *ngIf="productoConsultado.promo4"><strong>{{ productoConsultado.promo4 }}</strong>{{
          productoConsultado.precioJueves }}</p>
        <p *ngIf="productoConsultado.juevesMasInapam">{{ productoConsultado.juevesMasInapam }}</p>

        <p *ngIf="productoConsultado.promo5"><strong>{{ productoConsultado.promo5 }}</strong>{{
          productoConsultado.precioViernes }}</p>
        <p *ngIf="productoConsultado.viernesMasInapam">{{ productoConsultado.viernesMasInapam }}</p>

        <p *ngIf="productoConsultado.promo6"><strong>{{ productoConsultado.promo6 }}</strong>{{
          productoConsultado.precioSabado }}</p>
        <p *ngIf="productoConsultado.sabadoMasInapam">{{ productoConsultado.sabadoMasInapam }}</p>

        <p *ngIf="productoConsultado.promo0"><strong>{{ productoConsultado.promo0 }}</strong>{{
          productoConsultado.precioDomingo }}</p>
        <p *ngIf="productoConsultado.domingoMasInapam">{{ productoConsultado.domingoMasInapam }}</p>

        <p *ngIf="productoConsultado.promo"><strong>Promo: </strong>{{ productoConsultado.promo }}</p>
        <p *ngIf="productoConsultado.precioConDescuento"><strong>Precio c/promo: </strong>{{
          productoConsultado.precioConDescuento }}</p>
        <p *ngIf="productoConsultado.precioDescuentoMasInapam"><strong>Precio promo + inapam: </strong>{{
          productoConsultado.precioDescuentoMasInapam }}</p>
        <p *ngIf="productoConsultado.precioInapam"><strong>Precio Inapam: </strong>{{ productoConsultado.precioInapam }}
        </p>
        <p *ngIf="productoConsultado.promoCliente">{{ productoConsultado.promoCliente }}</p>


      </div>

      <button (click)="cerrarModalConsultaPrecio()" class="btn-rojo-tache">Cerrar</button>
    </div>
  </div>

  <table class="tabla">
    <thead>
      <tr>
        <th></th>
        <th></th>
        <th></th>
        <th class="col-img">Imagen</th>
        <th>Producto</th>
        <th>Cant.</th>
        <th>P. U.</th>
        <th>Imp. normal</th>
        <th>Promo</th>
        <th>% desc.</th>
        <th>Monedero</th>
        <th>Desc.</th>
        <th>Precio Final</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let p of carrito; let i = index">
        <td>
          <button [disabled]="p.esGratis" [class.deshabilitado]="p.esGratis" title="Eliminar renglÃ³n"
            class="btn-icono btn-rojo-tache" (click)="eliminarProducto(i)">
            <i class="fas fa-times"></i>
          </button>
        </td>
        <td>
          <button [disabled]="p.esGratis" [class.deshabilitado]="p.esGratis" title="Aumentar uno"
            class="btn-icono btn-verde" (click)="incrementarCantidad(i)">
            <i class="fas fa-plus"></i>
          </button>
        </td>
        <td>
          <button [disabled]="p.esGratis" [class.deshabilitado]="p.esGratis" title="Quitar uno"
            class="btn-icono btn-gris" (click)="decrementarCantidad(i)">
            <i class="fas fa-minus"></i>
          </button>
        </td>
        <td class="col-img">
          <div class="img-cell">
            <button type="button" class="img-button" (click)="openPreviewVenta(p)" title="Ver imagen">
              <img [src]="thumbs[p.producto] || placeholderSrc" (error)="onThumbError($event, p)" alt="" loading="lazy"
                decoding="async" />
              <span class="zoom-corner"><i class="fas fa-search-plus"></i></span>
            </button>
          </div>
        </td>
        <td>{{ p.nombre }}</td>
        <td>{{ p.cantidad }}</td>
        <td>{{ p.precioOriginal | currency }}</td> <!-- precio unitario -->
        <td>{{ (p.precioOriginal * p.cantidad) | currency }}</td> <!-- importe sin descuento -->
        <td>{{ p.tipoDescuento !== 'Ninguno' ? p.tipoDescuento : '-' }}</td>
        <!-- muestra cadena de promociones aplicadas -->
        <td>{{ p.cadDesc }}</td> <!-- muestra cadena de porcentajes -->
        <td>{{ p.alMonedero * p.cantidad | currency }}</td>
        <td>{{ (p.descuentoUnitario * p.cantidad) | currency }}</td>
        <td>{{ (p.precioFinal * p.cantidad) | currency }}</td>
      </tr>
    </tbody>
  </table>

  <div class="total-container">
    <div class="left">Total de artÃ­culos: {{ totalArticulos }}</div>
    <div class="center">Abono al Monedero: {{ totalAlmonedero | currency }}</div>
    <div class="center">Usted ahorrÃ³: {{ totalDescuento | currency }}</div>
    <div class="right">Total: {{ total | currency }}</div>
  </div>

  <div *ngIf="carrito.length" class="botones-container">
    <button (click)="pausarVenta()" class="btn-amarillo">Pausar Venta</button>
    <button (click)="cancelarVenta()" class="btn-rojo">Cancelar Venta</button>
    <button (click)="abrirModalPago()" class="btn-verde btn-right">Finalizar Venta</button>
  </div>

  <div *ngIf="ventasPausadas.length" class="mt-4">
    <h2 class="subtitulo">Ventas Pausadas</h2>
    <button *ngFor="let venta of ventasPausadas; let i = index" (click)="reanudarVenta(i)"
      class="btn-gris d-block w-100 mb-2">
      {{ venta.captionButtomReanudar }}
    </button>
  </div>

</div>

<!-- Modal MÃ©todo de Pago -->
<form #payForm="ngForm" (ngSubmit)="finalizarVenta()">
  <div class="modal-overlay" *ngIf="mostrarModalPago">
    <div class="modal-content">
      <div class="modal-header bg-info-subtle text-blue">
        <h5 class="modal-title">MÃ©todo de Pago</h5>
      </div>

      <div class="modal-body">
        <p class="total-pago">Total a pagar: <strong>{{ total | currency }}</strong></p>

        <!-- Efectivo -->
        <div class="form-group row mb-2">
          <label for="efectivoRecibido" class="col-sm-4 col-form-label text-left">Efectivo:</label>
          <div class="col-sm-7 offset-sm-1 d-flex justify-content-end">
            <input #efectivoRecibidoRef id="efectivoRecibido" name="efectivoRecibido" type="number"
              class="form-control text-end" [(ngModel)]="efectivoRecibido" (ngModelChange)="calculaCambio()" [min]="0"
              step="0.1" [disabled]="ocultarEfectivo" autocomplete="off" inputmode="decimal" [attr.autofocus]="true" />
          </div>
        </div>

        <!-- Tarjeta -->
        <div class="form-group row mb-2">
          <label for="montoTarjeta" class="col-sm-4 col-form-label text-left">Tarjeta:</label>
          <div class="col-sm-7 offset-sm-1 d-flex justify-content-end">
            <input id="montoTarjeta" name="montoTarjeta" type="number" class="form-control text-end"
              [(ngModel)]="montoTarjeta" (ngModelChange)="pagoTarjeta()" [min]="0"
              [max]="total - pagoTransferencia1 - pagoVale1" step="0.1" [disabled]="ocultaTarjeta" autocomplete="off"
              inputmode="decimal" />
          </div>
        </div>

        <!-- Transferencia -->
        <div class="form-group row mb-2">
          <label for="montoTransferencia" class="col-sm-4 col-form-label">Transferencia:</label>
          <div class="col-sm-7 offset-sm-1 d-flex justify-content-end">
            <input id="montoTransferencia" name="montoTransferencia" type="number" class="form-control text-end"
              [(ngModel)]="montoTransferencia" (ngModelChange)="pagoTransferencia()" [min]="0"
              [max]="total - pagoTarjeta1 - pagoVale1" step="0.1" [disabled]="ocultaTransferencia" autocomplete="off"
              inputmode="decimal" />
          </div>
        </div>

        <!-- Monedero -->
        <div class="monedero-container" *ngIf="montoMonederoCliente > 0">
          <!-- 1) Mostrar cuÃ¡nto tiene acumulado -->
          <div class="form-group row mb-2">
            <label class="col-12 text-center" style="color: rgb(3, 7, 83); font-weight: bold; font-size: large;">
              Tiene en monedero: {{ montoMonederoCliente | currency }}
            </label>
          </div>

          <!-- 2) Mostrar checkbox "Desea usar su monedero" -->
          <div class="form-group row mb-2">
            <div class="col-sm-8">
              <label for="usarMonedero" class="col-form-label">Usar monedero:</label>
            </div>
            <div class="col-sm-4 d-flex align-items-center">
              <input id="usarMonedero" type="checkbox" class="form-check-input" name="usarMonedero"
                [(ngModel)]="usarMonedero" (ngModelChange)="onToggleMonedero()" />
              <label for="usarMonedero" class="ms-2">SÃ­</label>
            </div>
          </div>

          <!-- 3â€“4) Cuando el checkbox estÃ¡ marcado, mostramos el monto asignado de manera automÃ¡tica -->
          <div class="form-group row mb-2" *ngIf="usarMonedero">
            <label class="col-sm-8 col-form-label text-left">Monto monedero usado:</label>
            <div class="col-sm-4 d-flex justify-content-end">
              <!-- Simplemente mostramos el valor calculado; el usuario ya no lo edita manualmente -->
              <span class="form-control-plaintext text-end">
                {{ montoVale | currency }}
              </span>
            </div>
          </div>
        </div>

        <!-- Cambio y mensajes -->
        <p class="mt-3 cambio">Cambio: <strong>{{ cambio | currency }}</strong></p>

        <p *ngIf="pagoEfectivo + pagoTarjeta1 + pagoTransferencia1 + pagoVale1 < total" class="text-danger mt-3">
          AÃºn falta cubrir el total de la venta.
        </p>
        <p *ngIf="pagoEfectivo + pagoTarjeta1 + pagoTransferencia1 + pagoVale1 >= total" class="text-success mt-3">
          El total de la venta ha sido cubierto.
        </p>
      </div>

      <div class="btns-container">
        <button type="button" class="btn-rojo-tache" (click)="cancelarPago()">Cancelar</button>
        <button type="submit" class="btn-gris"
          [disabled]="pagoEfectivo + pagoTarjeta1 + pagoTransferencia1 + pagoVale1 < total">
          Imprimir
        </button>
      </div>

      <div class="button-container">
        <button *ngIf="inputsHabilitados" type="button" class="btn-amarillo" (click)="habilitarInputs()">
          <i class="fas fa-sync-alt"></i> Habilitar pagos
        </button>
      </div>
    </div>
  </div>
</form>




<app-venta-ticket *ngIf="ventaParaImpresion && mostrarTicket" [venta]="ventaParaImpresion"
  class="ticket-impresion"></app-venta-ticket>