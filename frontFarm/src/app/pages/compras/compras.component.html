<div class="compras-container">

    <!-- TÍTULO -->
    <div class="titulo-container">
        <h1 class="titulo">Compras</h1>
    </div>

    <!-- CABECERA: PROVEEDOR -->
    <form [formGroup]="headerForm" class="header-form">
        <label>Proveedor:</label>
        <select class="input-text select" style="width: max-content;" formControlName="proveedor">
            <option [ngValue]="null">-- Selecciona --</option>
            <option *ngFor="let p of proveedores" [ngValue]="p._id">{{ p.nombre }}</option>
        </select>

        <!-- NUEVO: Fecha de compra (permite backdate, no futuro) -->
        <label style="margin-left:12px;">Fecha de compra:</label>
        <input type="date" class="input-text" style="width:max-content;" formControlName="fechaCompra" [max]="hoyISO"
            title="Fecha efectiva de la compra (no futuro)" />

        <label style="margin: 0.5rem 0 0 4rem;" for="chk-afectar-exist">Afectar existencias:</label>
        <input id="chk-afectar-exist" type="checkbox" formControlName="afectarExistencias"
            title="Si está marcado, se actualizarán lotes/precios/inventarios; si no, solo se registrará la compra." />
        <small style="margin-top: 0.5rem; color:#f6a80c">
            {{ headerForm.value.afectarExistencias ? 'Sí (actualiza productos)' : 'No (solo registra compra)' }}
        </small>

        <button type="button" class="btn-amarillo-chico d-flex align-items-center" (click)="abrirNuevoProducto()"
            title="Agregar un nuevo producto">
            <fa-icon [icon]='faPlus'></fa-icon>
            <span class="ms-1">Nuevo</span>
        </button>
    </form>

    <!-- FORMULARIO DE INGRESO DE PRODUCTO -->
    <div class="item-form" [formGroup]="itemForm">
        <div class="buscar">
            <label>
                Código de barras:
                <input type="text" formControlName="codigoBarras" (keydown.enter)="onBuscarProducto()"
                    placeholder="Escanea aquí" />
            </label>
            <button *ngIf="nombreProducto.length > 0" (click)="limpiarProducto()" class="btn-rojo"
                matTooltip="Borrar código de barras">
                <i class="fas fa-times"></i>
            </button>
            <span *ngIf="nombreProducto.length > 0" class="producto-nombre">{{ nombreProducto }}</span>
        </div>

        <div class="buscar" *ngIf="!productoEncontrado">
            <label>
                Buscar producto (nombre o código):
                <div class="suggest-wrap">
                    <input type="text" [disabled]="cargandoProducto" placeholder="Escribe al menos 2 caracteres"
                        (input)="onProdInput(($any($event.target).value || '').trim())" />

                    <!-- Panel de sugerencias -->
                    <div class="suggest-panel" *ngIf="prodOpts.length">
                        <div class="suggest-grid">
                            <button type="button" class="suggest-item" *ngFor="let p of prodOpts"
                                (click)="selectProd(p)">
                                <div class="suggest-title">{{ p.nombre || '(sin nombre)' }}</div>
                                <div class="suggest-sub">{{ p.codigoBarras || '—' }}</div>
                            </button>
                        </div>
                    </div>
                </div>
            </label>
        </div>


        <div class="detalles-producto" *ngIf="nombreProducto.length > 0">
            <label style="width: 10%;">Cantidad: <input type="number" formControlName="cantidad" min="1" /></label>
            <label style="width: 10%;">Lote:
                <input type="text" formControlName="lote" placeholder="Solo A-Z y 0-9" />
            </label>

            <div class="field-stack" style="width: 18rem;">
                <label style="width: 10%;" for="caducidadMMYY">Caducidad:</label>

                <input id="caducidadMMYY" type="text" inputmode="numeric" maxlength="4"
                    formControlName="caducidadMMAAAA" placeholder="mmAA" autocomplete="off"
                    (blur)="itemForm.get('caducidadMMAAAA')?.markAsTouched()" />

                <!-- ayuda -->
                <small class="field-help text-muted" *ngIf="itemForm.value.fechaCaducidad">
                    Se enviará: {{ itemForm.value.fechaCaducidad }}
                </small>

                <!-- error -->
                <div class="field-error"
                    *ngIf="itemForm.get('caducidadMMAAAA')?.invalid && itemForm.get('caducidadMMAAAA')?.touched">
                    Fecha inválida. Escribe <strong>mmAA</strong> (p. ej. 0925 → 2025-09-30).
                </div>
            </div>

            <label style="width: 10%;">Costo U.: <input type="number" formControlName="costoUnitario"
                    step="0.01" /></label>
            <label style="width: 10%;">Precio U.: <input type="number" formControlName="precioUnitario"
                    step="0.01" /></label>
            <label style="width: 10%;">Stock mínimo.: <input type="number" formControlName="stockMinimo"
                    step="1" /></label>
            <label style="width: 10%;">Stock máximo.: <input type="number" formControlName="stockMaximo"
                    step="1" /></label>

            <button [disabled]="itemForm.invalid" class="btn-verde" style="height: fit-content; margin-top: 1rem;"
                type="button" (click)="onAgregarItem()">Agregar al
                carrito</button>
        </div>
    </div>

    <!-- TABLA DEL CARRITO -->
    <table *ngIf="carrito.length" class="tabla">
        <thead>
            <tr>
                <th></th>
                <th>Producto</th>
                <th>Codigo barras</th>
                <th>Cant.</th>
                <th>Lote</th>
                <th>Caducidad</th>
                <th>Costo U.</th>
                <th>Precio U.</th>
                <th>Stock Mín.</th>
                <th>Stock Máx.</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            <ng-container *ngFor="let it of carrito; let i = index">
                <tr>
                    <td>
                        <button (click)="onEliminarItem(i)" class="btn-icono btn-rojo-tache"
                            matTooltip="Quitar este producto de la compra">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                    <td>{{ it.nombre }}</td>
                    <td>{{ it.codigoBarras }}</td>
                    <td>{{ it.cantidad }}</td>
                    <td>{{ it.lote }}</td>
                    <td>{{ it.fechaCaducidad | date:'dd/MM/yyyy' }}</td>
                    <td>{{ it.costoUnitario | currency }}</td>
                    <td>{{ it.precioUnitario | currency }}</td>
                    <td>{{ it.stockMinimo }}</td>
                    <td>{{ it.stockMaximo }}</td>
                    <td>{{ (it.costoUnitario * it.cantidad) | currency }}</td>
                    <button [class]="editingPromoIndex===i?'btn-icono btn-rojo' : 'btn-icono btn-verde'"
                        style="margin-top: 8px;" (click)="toggleEditPromo(i)"
                        [matTooltip]="editingPromoIndex===i?'Cerrar la edición':'Editar promos y cantidades'">
                        <mat-icon>{{ editingPromoIndex === i ? 'close' : 'edit' }}</mat-icon>
                    </button>

                </tr>

                <!-- EDICIÓN -->
                <tr *ngIf="editingPromoIndex === i" class="promo-editor">
                    <td colspan="12">

                        <!-- DATOS GENERALES EDITABLES DEL ITEM -->
                        <div class="row mb-3 text-center align-items-center"
                            style="background-color: #f5f5f5; padding-bottom: 10px;">
                            <div class="col-1">
                                <label><strong>Cant.:</strong></label>
                                <input type="number" [(ngModel)]="it.cantidad" class="form-control form-control-sm">
                            </div>
                            <div class="col-3">
                                <label><strong>Lote:</strong></label>
                                <input type="text" [(ngModel)]="it.lote" class="form-control form-control-sm">
                            </div>
                            <div class="col-2">
                                <label><strong>Caducidad:</strong></label>
                                <input type="date" [(ngModel)]="it.fechaCaducidad" class="form-control form-control-sm">
                            </div>
                            <div class="col-2">
                                <label><strong>Costo:</strong></label>
                                <input type="number" [(ngModel)]="it.costoUnitario" step="0.1"
                                    class="form-control form-control-sm">
                            </div>
                            <div class="col-2">
                                <label><strong>Precio:</strong></label>
                                <input type="number" [(ngModel)]="it.precioUnitario"
                                    class="form-control form-control-sm">
                            </div>
                            <div class="col-1">
                                <label><strong>Mín:</strong></label>
                                <input type="number" [(ngModel)]="it.stockMinimo" class="form-control form-control-sm">
                            </div>
                            <div class="col-1">
                                <label><strong>Máx:</strong></label>
                                <input type="number" [(ngModel)]="it.stockMaximo" class="form-control form-control-sm">
                            </div>
                        </div>

                        <!-- SELECCIÓN DE TIPO DE PROMO -->
                        <div class="row text-center mb-1">
                            <div class="col-2 fw-bold">
                                <label>Elige promoción:</label>
                            </div>
                            <div class="col-2">
                                <label [ngClass]="{'selected-radio': editPromos.tipoPromocion === 'ninguna'}">
                                    <input type="radio" name="promo-{{i}}" [(ngModel)]="editPromos.tipoPromocion"
                                        value="ninguna" />
                                    Ninguna
                                </label>
                            </div>
                            <div class="col-2"><label
                                    [ngClass]="{'selected-radio': editPromos.tipoPromocion === 'dia'}">
                                    <input type="radio" name="promo-{{i}}" [(ngModel)]="editPromos.tipoPromocion"
                                        value="dia" />
                                    Por día
                                </label>
                            </div>
                            <div class="col-2"><label
                                    [ngClass]="{'selected-radio': editPromos.tipoPromocion === 'cantidad'}">
                                    <input type="radio" name="promo-{{i}}" [(ngModel)]="editPromos.tipoPromocion"
                                        value="cantidad" />
                                    Cantidad
                                </label>
                            </div>
                            <div class="col-2"><label
                                    [ngClass]="{'selected-radio': editPromos.tipoPromocion === 'temporada'}">
                                    <input type="radio" name="promo-{{i}}" [(ngModel)]="editPromos.tipoPromocion"
                                        value="temporada" />
                                    Temporada
                                </label>
                            </div>
                            <!-- INAPAM -->
                            <div class="col-2">
                                <label [ngClass]="{'selected-checkbox': editPromos.descuentoINAPAM}">
                                    INAPAM(+5%)
                                    <input type="checkbox" class="form-check-input"
                                        [(ngModel)]="editPromos.descuentoINAPAM" />
                                </label>
                            </div>

                        </div>

                        <!-- POR DÍA -->
                        <div *ngIf="editPromos.tipoPromocion === 'dia'" class="mb-4">
                            <div class="row fw-bold text-center align-items-center">
                                <div class="col-2 text-end" style="padding-top: 10px;">Día</div>
                                <div class="col-2" style="padding-top: 10px;">% Desc.</div>
                                <div class="col-3" style="padding-top: 10px;">Inicia</div>
                                <div class="col-3" style="padding-top: 10px;">Termina</div>
                                <div class="col-2 text-start" style="padding-top: 10px;">Monedero</div>
                            </div>

                            <div *ngFor="let dia of diasSemana" class="row mb-2 align-items-center">
                                <div class="col-2 text-end text-primary fw-bold">{{ dia.name }}</div>
                                <div class="col-2">
                                    <input type="number" [(ngModel)]="editPromos[dia.prop].porcentaje"
                                        class="form-control form-control-sm">
                                </div>
                                <div class="col-3">
                                    <input type="date" [(ngModel)]="editPromos[dia.prop].inicio"
                                        class="form-control form-control-sm">
                                </div>
                                <div class="col-3">
                                    <input type="date" [(ngModel)]="editPromos[dia.prop].fin"
                                        class="form-control form-control-sm">
                                </div>
                                <div class="col-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input"
                                            [(ngModel)]="editPromos[dia.prop].monedero">
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- POR CANTIDAD -->
                        <div *ngIf="editPromos.tipoPromocion==='cantidad'" class="row mb-4 align-items-center">
                            <div class="row fw-bold text-center align-items-center">
                                <div class="col-2" style="padding-top: 10px;">Cantidad</div>
                                <div class="col-5" style="padding-top: 10px;">Inicia</div>
                                <div class="col-5" style="padding-top: 10px;">Termina</div>
                            </div>
                            <div class="row">
                                <div class="col-2">
                                    <select [(ngModel)]="editPromos.promoCantidadRequerida"
                                        class="form-control form-control-sm">
                                        <option [ngValue]="null">--</option>
                                        <option [ngValue]="2">2x1</option>
                                        <option [ngValue]="3">3x2</option>
                                        <option [ngValue]="4">4x3</option>
                                    </select>
                                </div>
                                <div class="col-5">
                                    <input type="date" [(ngModel)]="editPromos.inicioPromoCantidad"
                                        class="form-control form-control-sm">
                                </div>
                                <div class="col-5">
                                    <input type="date" [(ngModel)]="editPromos.finPromoCantidad"
                                        class="form-control form-control-sm">
                                </div>
                            </div>
                        </div>

                        <!-- POR TEMPORADA -->
                        <div *ngIf="editPromos.tipoPromocion==='temporada'" class="row mb-3">
                            <div class="row fw-bold text-center align-items-center">
                                <div class="col-2" style="padding-top: 10px;">% Desc.</div>
                                <div class="col-4" style="padding-top: 10px;">Inicia</div>
                                <div class="col-4" style="padding-top: 10px;">Termina</div>
                                <div class="col-2 text-start" style="padding-top: 10px;">Monedero</div>
                            </div>
                            <div class="col-2">
                                <input type="number" [(ngModel)]="editPromos.promoDeTemporada.porcentaje"
                                    class="form-control form-control-sm">
                            </div>
                            <div class="col-4">
                                <input type="date" [(ngModel)]="editPromos.promoDeTemporada.inicio"
                                    class="form-control form-control-sm">
                            </div>
                            <div class="col-4">
                                <input type="date" [(ngModel)]="editPromos.promoDeTemporada.fin"
                                    class="form-control form-control-sm">
                            </div>
                            <div class="col-2">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input"
                                        [(ngModel)]="editPromos.promoDeTemporada.monedero">
                                </div>
                            </div>
                        </div>

                        <!-- BOTONES -->
                        <div class="guardar-cancelar">
                            <button class="btn-rojo-chico" style="margin-left: 2rem;"
                                matTooltip="Cancelar edición del producto" (click)="cancelPromos()">Cancelar</button>
                            <button class="btn-verde-chico" style="margin-right: 2rem;" matTooltip="Guardar cambios"
                                (click)="savePromos(i)">Guardar</button>
                        </div>

                    </td>
                </tr>

            </ng-container>
        </tbody>

        <tfoot>
            <tr>
                <td colspan="10" class="total-label">Total:</td>
                <td colspan="2" style="text-align: start;">{{ total | currency }}</td>
            </tr>
        </tfoot>
    </table>

    <!-- BOTONES DE ACCIÓN -->
    <div class="acciones">
        <button class="btn-rojo" (click)="carrito = []; total = 0" [disabled]="!carrito.length || estaEditandoPromos"
            matTooltip="Cancelar toda la compra">Cancelar
        </button>
        <button class="btn-gris" (click)="onRegistrarCompra()" matTooltip="Registrar la compra completa"
            [disabled]="!carrito.length || headerForm.invalid || estaEditandoPromos">Registrar Compra
        </button>
    </div>

        <!-- Overlay -->
    <div class="modal-backdrop" *ngIf="mostrarNuevoProducto" #backdrop tabindex="-1"
        (keydown.escape)="cerrarNuevoProducto()">
        <!-- Caja del modal -->
        <div class="modal-dialog" role="dialog" aria-modal="true" (mousedown)="$event.stopPropagation()"
            (click)="$event.stopPropagation()">
            <h3 class="titulo text-center mb-3">Nuevo producto</h3>

            <form [formGroup]="nuevoProductoForm" autocomplete="off">
                <div class="row g-3">
                    <div class="col-12">
                        <label>Nombre *</label>
                        <input type="text" formControlName="nombre" #firstInput class="form-control" />
                    </div>

                    <div class="col-3">
                        <label>Código de barras *</label>
                        <input type="text" formControlName="codigoBarras" class="form-control" />
                    </div>
                    <div class="col-3">
                        <label>Categoría *</label>
                        <input type="text" formControlName="categoria" class="form-control" />
                    </div>
                    <div class="col-2">
                        <label>Unidad *</label>
                        <input type="text" formControlName="unidad" class="form-control" />
                    </div>
                    <div class="col-2">
                        <label>Precio *</label>
                        <input type="number" formControlName="precio" class="form-control" />
                    </div>
                    <div class="col-2">
                        <label>Costo *</label>
                        <input type="number" formControlName="costo" class="form-control" />
                    </div>

                    <div class="col-2">
                        <label>Stock Mín *</label>
                        <input type="number" formControlName="stockMinimo" class="form-control" />
                    </div>

                    <div class="col-2">
                        <label>Stock Máx *</label>
                        <input type="number" formControlName="stockMaximo" class="form-control" />
                    </div>

                    <div class="col-2 form-check-vertical">
                        <label for="chkIva" class="form-label">IVA</label>
                        <input type="checkbox" class="form-check-input" formControlName="iva" id="chkIva" />
                    </div>

                    <div class="col-2 form-check-vertical">
                        <label for="chkGen" class="form-label">Genérico</label>
                        <input type="checkbox" class="form-check-input" formControlName="generico" id="chkGen" />
                    </div>

                    <div class="col-2 form-check-vertical">
                        <label for="chkINA" class="form-label">INAPAM</label>
                        <input type="checkbox" class="form-check-input" formControlName="descuentoINAPAM" id="chkINA" />
                    </div>

                    <div class="col-2">
                        <label>Ubicación</label>
                        <input type="text" formControlName="ubicacion" class="form-control" />
                    </div>

                </div>
            </form>

            <div class="modal-actions mt-3">
                <button type="button" class="btn-rojo-chico w-100" (click)="cerrarNuevoProducto()">Cancelar</button>
                <button type="button" class="btn-verde-chico w-100"
                    [disabled]="nuevoProductoForm.invalid || guardandoNuevo" (click)="guardarNuevoProducto()">
                    {{ guardandoNuevo ? 'Guardando…' : 'Guardar' }}
                </button>
            </div>
        </div>
    </div>

</div>