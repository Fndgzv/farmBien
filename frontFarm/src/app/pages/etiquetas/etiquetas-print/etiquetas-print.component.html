<!-- etiquetas-print.component.html -->
<div class="etiquetas">
  <h2 class="titulo text-center">Impresi√≥n de etiquetas</h2>
  <div class="barra">
    <!-- üîπ Farmacia -->
    <label>Farmacia</label>
    <select [(ngModel)]="farmaciaId" (change)="onFarmaciaChange()">
      <option value="" disabled selected>‚Äî Selecciona ‚Äî</option>
      <option *ngFor="let f of farmacias" [value]="f._id">{{ f.nombre }}</option>
    </select>

    <!-- üîπ Dise√±o (deshabilitado hasta elegir farmacia opcionalmente) -->
    <label>Dise√±o</label>
    <select [(ngModel)]="designId" (change)="loadDesign()" [disabled]="!farmaciaId || !disenos?.length">
      <option *ngFor="let d of disenos" [value]="d._id">{{ d.nombre }}</option>
    </select>

    <input placeholder="Filtrar por nombre" [(ngModel)]="fNombre" (keyup.enter)="buscar()" [disabled]="!farmaciaId">
    <input placeholder="Categor√≠a" [(ngModel)]="fCategoria" (keyup.enter)="buscar()" [disabled]="!farmaciaId">
    <button class="btn-gris" (click)="buscar()" [disabled]="!farmaciaId">Buscar</button>

    <button class="btn-amarillo" [disabled]="!farmaciaId || seleccionados.length===0 || !design" (click)="previsualizar()">
      Previsualizar / Imprimir
    </button>
  </div>

  <table class="tabla">
    <thead>
      <tr>
        <th><input type="checkbox" [checked]="allChecked" (change)="toggleAll($event)"></th>
        <th>Nombre</th>
        <th>Categor√≠a</th>
        <th>C√≥digo barras</th>
        <th>Precio</th>
        <th>Exist.</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let p of productos">
        <td><input type="checkbox" [(ngModel)]="p._checked" (ngModelChange)="updateChecked()"></td>
        <td>{{p.nombre}}</td>
        <td>{{p.categoria}}</td>
        <td>{{p.codigoBarras}}</td>
        <td>{{p.precioVenta | currency}}</td>
        <td>{{p.existencia}}</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Contenedor oculto que se muestra s√≥lo al imprimir -->
<div class="etiquetas-impresion" *ngIf="mostrarPrint"  #printHost>
  <div class="page" [style.width]="(design?.pageWidthMm || 210) + 'mm'"
     [style.height]="(design?.pageHeightMm || 297) + 'mm'">

    <div class="labels-grid"
        [style.gap]="(design?.gapYmm || 0) + 'mm ' + (design?.gapXmm || 0) + 'mm'"
        [style.gridTemplateColumns]="'repeat(' + (design?.cols || 1) + ', ' + (design?.widthMm || 0) + 'mm)'"
        [style.gridTemplateRows]="'repeat(' + (design?.rows || 1) + ', ' + (design?.heightMm || 0) + 'mm)'">

      <ng-container *ngFor="let item of itemsParaImprimir">
        <div class="label-box" [style.width]="(design?.widthMm || 0) + 'mm'"
         [style.height]="(design?.heightMm || 0) + 'mm'">
          <div class="label-inner" [style.padding]="(design?.marginMm || 0) + 'mm'">
            <!-- Renderizamos cada elemento del dise√±o con los datos del producto -->
            <ng-container *ngFor="let el of design!.elements">
              <div class="el" [style.left.%]="el.x" [style.top.%]="el.y" [style.width.%]="el.w" [style.height.%]="el.h"
                [ngStyle]="styleTexto(el)">
                <ng-container [ngSwitch]="el.type">
                  <div *ngSwitchCase="'text'">{{ valorCampo(item, el) }}</div>
                  <div *ngSwitchCase="'price'">{{ valorPrecio(item, el) }}</div>
                  <div *ngSwitchCase="'barcode'">
                    <svg class="barcode" #printBarcode></svg>
                  </div>
                </ng-container>
              </div>
            </ng-container>
          </div>
        </div>
      </ng-container>

    </div>
  </div>
</div>