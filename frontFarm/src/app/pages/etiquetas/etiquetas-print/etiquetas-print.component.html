<!-- etiquetas-print.component.html -->
<div class="etiquetas">
  <h2 class="titulo text-center">Impresi√≥n de etiquetas</h2>
  <div class="filtros">
    <div class="row g-2 align-items-end">
      <!-- üîπ Farmacia -->
      <div class="col-md-2">
        <label class="form-label">Farmacia</label>
        <div>
          <select class="form-select" [(ngModel)]="farmaciaId" (change)="onFarmaciaChange()">
            <option value="" disabled selected>‚Äî Selecciona ‚Äî</option>
            <option *ngFor="let f of farmacias" [value]="f._id">{{ f.nombre }}</option>
          </select>
        </div>
      </div>

      <!-- üîπ Dise√±o (deshabilitado hasta elegir farmacia opcionalmente) -->
      <div class="col-md-2">
        <label class="form-label">Dise√±o</label>
        <div>
          <select class="form-select" [(ngModel)]="designId" (change)="loadDesign()"
            [disabled]="!farmaciaId || !(disenos && disenos.length)">
            <option *ngFor="let d of disenos" [value]="d._id">{{ d.nombre }}</option>
          </select>
        </div>
      </div>

      <div class="col-md-3">
        <label class="form-label">Nombre</label>
        <div>
          <input class="form-control" placeholder="Nombre" [(ngModel)]="fNombre" (keyup.enter)="buscar()"
            [disabled]="!farmaciaId">
        </div>
      </div>

      <div class="col-md-3">
        <label class="form-label">Categor√≠a</label>
        <div>
          <input class="form-control" placeholder="Categor√≠a" [(ngModel)]="fCategoria" (keyup.enter)="buscar()"
            [disabled]="!farmaciaId">
        </div>
      </div>

      <div class="col-md-1">
        <label class="form-label">x p√°g.:</label>
        <div>
          <select class="form-select" [ngModel]="limit" (ngModelChange)="cambiarLimit($event)">
            <option [ngValue]="10">10</option>
            <option [ngValue]="20">20</option>
            <option [ngValue]="50">50</option>
            <option [ngValue]="100">100</option>
          </select>
        </div>
      </div>

      <div class="col-md-1" style="margin-top: 1.3rem;">
        <button type="button" class="btn-rojo" (click)="limpiar()" matTooltip="Limpiar filtros"><i
            class="fas fa-times"></i></button>
      </div>
    </div>

    <div class="row g-2 align-items-end mb-2">
      <div class="col-md-6" style="margin-top: 1.3rem;">
        <button class="btn-amarillo btn-icon-only"
          [disabled]="!farmaciaId || seleccionados.length===0 || !design || isPrinting" (click)="previsualizar()"
          matTooltip="Imprimir" aria-label="Imprimir">
          <span *ngIf="!isPrinting"><i class="bi bi-printer"></i></span>
          <span *ngIf="isPrinting">Imprimiendo‚Ä¶</span>
        </button>
      </div>
      <div class="col-md-6" style="margin-top: 1.3rem; text-align: end;">
        <button class="btn-gris" (click)="buscar()" [disabled]="!farmaciaId">Buscar</button>
      </div>
    </div>
  </div>

  <table class="tabla">
    <thead>
      <tr>
        <th><input type="checkbox" [checked]="allChecked" (change)="toggleAll($event)"></th>
        <th class="sortable" (click)="toggleSort('nombre')" title="Ordenar por nombre">
          Nombre
          <span class="sort" *ngIf="sortBy==='nombre'">{{ sortDir==='asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </th>
        <th>C√≥digo barras</th>
        <th>Rengl√≥n 1</th>
        <th>Rengl√≥n 2</th>
        <th class="sortable" (click)="toggleSort('categoria')" title="Ordenar por categor√≠a">
          Categor√≠a
          <span class="sort" *ngIf="sortBy==='categoria'">{{ sortDir==='asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </th>
        <th>Precio</th>
        <th>Exist.</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let p of productos; trackBy: trackById">
        <td>
          <input type="checkbox" [(ngModel)]="p._checked" (ngModelChange)="onToggleRow(p)">
        </td>
        <td>{{p.nombre}}</td>
        <td>{{p.codigoBarras}}</td>
        <td>{{p.renglon1}}</td>
        <td>{{p.renglon2}}</td>
        <td>{{p.categoria}}</td>
        <td>{{p.precioVenta | currency}}</td>
        <td>{{p.existencia}}</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="mt-2 paginacion">
  <span><b>Etiquetas a imprimir:</b> {{ totalSeleccionados }}</span>
</div>

<!-- Resumen y paginaci√≥n -->
<div class="mt-2 paginacion">
  <button (click)="irPrimera()" [disabled]="page<=1" matTooltip="Inicio">
    <i class="fa fa-angle-double-left"></i>
  </button>
  <button (click)="irAnterior()" [disabled]="page<=1" matTooltip="Anterior">
    <i class="fa fa-angle-left"></i>
  </button>

  <span>&nbsp; {{ totalFiltrado }} productos. P√°gina {{ page }} / {{ totalPages }} &nbsp;</span>

  <button (click)="irSiguiente()" [disabled]="page>=totalPages" matTooltip="Siguiente">
    <i class="fa fa-angle-right"></i>
  </button>
  <button (click)="irUltima()" [disabled]="page>=totalPages" matTooltip="Fin">
    <i class="fa fa-angle-double-right"></i>
  </button>
</div>

<!-- Contenedor de impresi√≥n -->
<div class="etiquetas-impresion" *ngIf="mostrarPrint">
  <div #printHost class="print-root">
    <!-- Cada etiqueta = UNA hoja/corte -->
    <section class="sheet"
             *ngFor="let item of itemsParaImprimir"
             [style.width.mm]="lblWmm"
             [style.height.mm]="lblHmm">
      <div class="label-inner" [style.padding.mm]="padMm">
        <ng-container *ngFor="let el of design!.elements">
          <div class="el"
               [style.left.%]="el.x" [style.top.%]="el.y"
               [style.width.%]="el.w" [style.height.%]="el.h"
               [ngStyle]="styleTexto(el)">
            <ng-container [ngSwitch]="el.type">
              <div *ngSwitchCase="'text'">{{ valorCampo(item, el) }}</div>
              <div *ngSwitchCase="'price'">{{ valorPrecio(item, el) }}</div>
              <!-- marcador de CB; lo sustituyo por SVG -->
              <img *ngSwitchCase="'barcode'" class="barcode" />
            </ng-container>
          </div>
        </ng-container>
      </div>
    </section>
  </div>
</div>