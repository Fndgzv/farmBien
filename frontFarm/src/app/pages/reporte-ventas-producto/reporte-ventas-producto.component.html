<div>
  <div class="titulo-container mb-2">
    <h2 class="titulo">Ventas por producto</h2>
  </div>
  <form (ngSubmit)="buscar()" class="row align-items-end">
    <div class="row filtros">
      <div class="col-md-2">
        <label class="form-label">Farmacia</label>
        <select class="form-select" [(ngModel)]="farmaciaId" name="farmaciaId">
          <option value="">Todas</option>
          <option *ngFor="let f of farmacias" [ngValue]="f._id">
            {{ f.nombre }}
          </option>
        </select>
      </div>

      <!-- Producto (Angular Material Autocomplete) -->
      <div class="col-md-4">
        <label class="form-label d-block">Producto</label>

        <mat-form-field appearance="outline" class="compact-field wide-field">
          <input
            matInput
            [formControl]="productCtrl"
            [matAutocomplete]="auto"
            placeholder="Escribe código de barras o nombre"
          />

          <button
            *ngIf="productCtrl.value"
            matSuffix
            type="button"
            class="btn-rojo-chico"
            (click)="limpiarProducto()"
            style="width: 30px; height: 30px;"
            aria-label="Limpiar producto"
          >
            <fa-icon [icon]="faTimes"></fa-icon>
          </button>

          <mat-autocomplete
            #auto="matAutocomplete"
            [displayWith]="displayProducto"
            (optionSelected)="onOptionSelected($event.option.value)"
          >
            <mat-option *ngFor="let p of opcionesProductos" [value]="p">
              <div class="d-flex justify-content-between w-100">
                <span>{{ p.nombre }}</span>
                <small class="text-muted ms-2">{{ p.codigoBarras || '—' }}</small>
              </div>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>



      <div class="col-md-2">
        <label class="form-label">Fecha inicial</label>
        <input type="date" class="form-control" [(ngModel)]="fechaIni" name="fechaIni"/>
      </div>

      <div class="col-md-2">
        <label class="form-label">Fecha final</label>
        <input type="date" class="form-control" [(ngModel)]="fechaFin" name="fechaFin"/>
      </div>

      <div class="col-md-1 d-flex" style="margin-top: -10px;">
        <button type="button" class="btn-rojo compact-btn" (click)="limpiar()" [disabled]="cargando" matTooltip="Borrar filtro">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="col-md-1 d-flex text-end" style="margin-top: -10px;">
        <button class="btn-gris compact-btn" type="submit" [disabled]="cargando">
          {{ cargando ? 'Buscando...' : 'Buscar' }}
        </button>
      </div>

    </div>
    <div class="col-12 mt-2">
      <button class="btn-verde" type="button" (click)="exportarCSV()" [disabled]="cargando || !rows.length">
        Exportar CSV
      </button>
    </div>

  </form>

  <div class="table-responsive mt-3">
    <table class="tabla">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Farmacia</th>
          <th>Usuario</th>
          <th>Cód. barras</th>
          <th>Producto</th>
          <th class="text-end">Cantidad</th>
          <th class="text-end">Importe</th>
          <th class="text-end">Costo</th>
          <th class="text-end">Utilidad</th>
          <th class="text-end">% Gan.</th>
          <th>Folio venta</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of pagedRows">
          <td>{{ r.fecha | date:'dd-MM-yyyy' }}</td>
          <td>{{ r.farmaciaNombre }}</td>
          <td>{{ r.usuarioNombre }}</td>
          <td>{{ r.codigoBarras || '—' }}</td>
          <td>{{ r.productoNombre }}</td>
          <td class="text-end">{{ r.cantidadVendida }}</td>
          <td class="text-end">{{ r.importeTotal | currency }}</td>
          <td class="text-end">{{ r.costoTotal | currency }}</td>
          <td class="text-end" [ngClass]="{ 'text-danger': (r.utilidad || 0) < 0 }">
            {{ r.utilidad | currency }}
          </td>
          <td class="text-end" [ngClass]="{ 'text-danger': (r.utilidad || 0) < 0 }">
            {{ r.margenRenglonPct  == null ? '—' : (r.margenRenglonPct  | number:'1.0-2') + '%' }}
          </td>
          <td>{{ r.folio }}</td>
        </tr>

        <tr *ngIf="rows.length === 0">
          <td colspan="11" class="text-center text-muted">Sin resultados</td>
        </tr>
      </tbody>

      <tfoot *ngIf="rows.length">
        <tr class="fw-bold">
          <td colspan="5" class="text-end">Totales:</td>
          <td class="text-end">{{ totalCantidad }}</td>
          <td class="text-end">{{ totalImporte | currency }}</td>
          <td class="text-end">{{ totalCosto | currency }}</td>
          <td class="text-end" [ngClass]="{ 'text-danger': totalUtilidad < 0 }">
            {{ totalUtilidad | currency }}
          </td>
          <td class="text-end">
            {{ totalMargenPct == null ? '—' : (totalMargenPct | number:'1.0-2') + '%' }}
          </td>
          <td></td>
        </tr>
      </tfoot>
    </table>


    <div class="paginacion" *ngIf="totalItems > 0">
      <button (click)="goFirst()" [disabled]="page === 1" matTooltip="Inicio">
        <i class="fa fa-angle-double-left"></i>
      </button>
      <button (click)="goPrev()" [disabled]="page === 1" matTooltip="Anterior">
        <i class="fa fa-angle-left"></i>
      </button>

      Página {{ page }} de {{ totalPages }} — {{ totalItems }} registros

      <button (click)="goNext()" [disabled]="page === totalPages" matTooltip="Siguiente">
        <i class="fa fa-angle-right"></i>
      </button>
      <button (click)="goLast()" [disabled]="page === totalPages" matTooltip="Fin">
        <i class="fa fa-angle-double-right"></i>
      </button>
    </div>

  </div>
</div>