<!-- <div class="container"> -->

<div class="titulo-container">
    <h1 class="titulo">Ajustes de Inventario en {{ nombreFarmaciaSeleccionada }}</h1>
</div>

<form [formGroup]="formFiltros" (ngSubmit)="buscar()" class="filter-container">
    <div class="row">

        <div class="col-md-1">
            <label>Farmacia</label>
            <select class="form-control" formControlName="farmacia" required>
                <option *ngFor="let f of farmacias" [value]="f._id">{{ f.nombre }}</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="me-2 mb-0" style="white-space: nowrap;">Nombre producto</label>
            <div class="position-relative">
                <input type="text" formControlName="nombre" class="form-control pe-4 flex-grow-1">
                <button *ngIf="formFiltros.get('nombre')?.value" type="button"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('nombre')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <div class="col-md-2">
            <label class="me-2 mb-0" style="white-space: nowrap;">Código barras</label>
            <div class="position-relative">
                <input type="text" formControlName="codigoBarras" class="form-control pe-4 flex-grow-1">
                <button *ngIf="formFiltros.get('codigoBarras')?.value" type="button"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('codigoBarras')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <div class="col-md-2">
            <label class="me-2 mb-0" style="white-space: nowrap;">Categoría</label>
            <div class="position-relative">
                <input type="text" formControlName="categoria" class="form-control pe-4 flex-grow-1">
                <button *ngIf="formFiltros.get('categoria')?.value" type="button"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('categoria')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <!-- Dentro del <form [formGroup]="formFiltros"> -->
        <div class="col-md-2">
        <label class="me-2 mb-0" style="white-space: nowrap;">Ubicación en farmacia</label>
        <div class="position-relative">
            <input type="text" formControlName="ubicacionFarmacia" class="form-control pe-4 flex-grow-1">
            <button *ngIf="formFiltros.get('ubicacionFarmacia')?.value" type="button"
            class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
            (click)="limpiarFiltro('ubicacionFarmacia')">
            <fa-icon [icon]="faTimes"></fa-icon>
            </button>
        </div>
        </div>

        <div class="col-md-1">
            <label class="me-2 mb-0" style="white-space: nowrap;">INAPAM</label>
            <div class="position-relative">
                <select class="form-control pe-4 flex-grow-1" formControlName="inapam">
                    <option value="">--</option>
                    <option value="true">Sí</option>
                    <option value="false">No</option>
                </select>
                <button *ngIf="formFiltros.get('inapam')?.value !== ''" type="button"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('inapam')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <div class="col-md-1">
            <label class="me-2 mb-0" style="white-space: nowrap;">Genérico?</label>
            <div class="position-relative">
                <select class="form-control pe-4 flex-grow-1" formControlName="generico">
                    <option value="">--</option>
                    <option value="true">Sí</option>
                    <option value="false">No</option>
                </select>
                <button *ngIf="formFiltros.get('generico')?.value !== ''" type="button"
                    class="btn-icon-chico btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico"
                    (click)="limpiarFiltro('generico')">
                    <fa-icon [icon]="faTimes"></fa-icon>
                </button>
            </div>
        </div>

        <div class="col-md-1 text-end mt-3">
            <button type="submit" class="btn-gris" [disabled]="cargando">
                {{ cargando ? 'Cargando…' : 'Buscar' }}</button>
        </div>
    </div>

</form>

<div *ngIf="inventario.length > 0" class="mt-3">
    <table class="tabla">
        <thead class="text-center">
            <tr style="color: blue;">
                <th>AJUSTE MASIVO</th>
                <th></th>
                <th>
                    <input [(ngModel)]="ajusteMasivo.ubicacionFarmacia"
                            class="form-control form-control-sm"
                            type="text"
                            placeholder="Ubic farma">
                </th>
                <th></th>
                <th></th>
                <th></th>
                <th>
                    <input [(ngModel)]="ajusteMasivo.existencia" class="form-control form-control-sm" type="number" style="width: 60px;"
                        placeholder="Exis">
                </th>
                <th>
                    <input [(ngModel)]="ajusteMasivo.stockMin" class="form-control form-control-sm" type="number" style="width: 60px;"
                        placeholder="Mín">
                </th>
                <th>
                    <input [(ngModel)]="ajusteMasivo.stockMax" class="form-control form-control-sm" type="number" style="width: 60px;"
                        placeholder="Máx">
                </th>
                <th>
                    <button class="btn-icon-chico btn-rojo-chico" (click)="resetInputsMasivos()"
                        matTooltip="Limpiar parámetros de ajustes masivos"
                        [disabled]="deshabilitarBotonAplicar || aplicandoCambiosMasivos">
                        <fa-icon [icon]="faTimes"></fa-icon>
                    </button>
                </th>
                <th>
                    <input [(ngModel)]="ajusteMasivo.precioVenta" class="form-control form-control-sm" type="number" style="width: 72px;"
                        placeholder="Precio">
                </th>
                <th>
                    <button class="btn-verde-chico" (click)="guardarAjusteMasivo()"
                        [disabled]="deshabilitarBotonAplicar || aplicandoCambiosMasivos">
                        {{ aplicandoCambiosMasivos ? 'Guardando…' : 'Aplicar a todos' }}
                    </button>
                </th>
                
            </tr>
            <tr>
                <th>
                    <input type="checkbox" (change)="seleccionarTodos($event)">
                </th>
                <th (click)="clickSortNombre()" class="th-sort" title="Ordenar por nombre">
                    Nombre
                    <i class="bi" [ngClass]="{
                        'bi-caret-up-fill':   sortBy === 'nombre' && sortDir === 'asc',
                        'bi-caret-down-fill': sortBy === 'nombre' && sortDir === 'desc',
                        'bi-caret-up':        sortBy !== 'nombre'
                        }" style="margin-left:.25rem;">
                    </i>
                </th>
                <th>Ubicación</th>
                <th>Categoria</th>
                <th title="Generico">Gen.</th>
                <th title="INAPAM">INPM</th>
                <th (click)="clickSortExistencia()" class="th-sort text-center" title="Ordenar por existencia">
                    Exis.
                    <i class="bi" [ngClass]="{
                            'bi-caret-up-fill':   sortBy === 'existencia' && sortDir === 'asc',
                            'bi-caret-down-fill': sortBy === 'existencia' && sortDir === 'desc',
                            'bi-caret-up':        sortBy !== 'existencia'
                            }" style="margin-left:.25rem;">
                    </i>
                </th>
                <th>Stock Mín</th>
                <th>Stock Máx</th>
                <th>Costo</th>
                <th>
                    Precio Venta
                </th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let i of inventarioPaginado;">
                <td>
                    <input type="checkbox" [(ngModel)]="i.seleccionado">
                </td>

                <td class="nombre-cell">
                    <div class="nombre-text">{{ i.producto?.nombre }}</div>
                    <small class="codigo-mini">{{ i.producto?.codigoBarras || '—' }}</small>
                </td>

                <td>
                    <ng-container *ngIf="estadoEdicion[i._id]; else verUbicacionFarmacia">
                        <input [(ngModel)]="i.ubicacionFarmacia"
                            class="form-control form-control-sm"
                            type="text"
                            placeholder="Ubic farma">
                    </ng-container>
                    <ng-template #verUbicacionFarmacia>
                        {{ i.ubicacionFarmacia || '—' }}
                    </ng-template>
                </td>

                <td>{{ i.producto?.categoria }}</td>

                <td class="text-center">
                    {{ i.producto?.generico ? 'Sí' : 'No' }}
                </td>

                <td class="text-center">
                    {{ i.producto?.descuentoINAPAM ? 'Sí' : 'No' }}
                </td>

                <td class="text-end">
                    <ng-container *ngIf="estadoEdicion[i._id]; else existenciaVista">
                    <input [disabled]="!estadoEdicion[i._id]" [(ngModel)]="i.existencia" type="number"
                        class="form-control form-control-sm text-end">
                    </ng-container>

                    <ng-template #existenciaVista>
                        <span>{{ i.existencia }}</span>
                    </ng-template>
                </td>

                <td class="text-end">
                    <ng-container *ngIf="estadoEdicion[i._id]; else stockMinVista">
                    <input [disabled]="!estadoEdicion[i._id]" [(ngModel)]="i.stockMin" type="number"
                        class="form-control form-control-sm text-end">
                    </ng-container>

                    <ng-template #stockMinVista>
                        <span>{{ i.stockMin }}</span>
                    </ng-template>
                </td>

                <td class="text-end">
                    <ng-container *ngIf="estadoEdicion[i._id]; else stockMaxVista">
                    <input [disabled]="!estadoEdicion[i._id]" [(ngModel)]="i.stockMax" type="number"
                        class="form-control form-control-sm text-end">
                    </ng-container>

                    <ng-template #stockMaxVista>
                        <span>{{ i.stockMax }}</span>
                    </ng-template>
                </td>
                <td class="text-end">
                    {{ i.producto.costo | currency:'MXN':'symbol-narrow':'1.2-2' }}
                </td>
                <td class="text-end">
                    <ng-container *ngIf="estadoEdicion[i._id]; else precioVista">
                        <input
                        [disabled]="!estadoEdicion[i._id]"
                        [(ngModel)]="i.precioVenta"
                        type="number"
                        class="form-control form-control-sm text-end"
                        step="0.01"
                        >
                    </ng-container>

                    <ng-template #precioVista>
                        <span>{{ i.precioVenta | currency:'MXN':'symbol-narrow':'1.2-2' }}</span>
                    </ng-template>
                    
                </td>


                <td>
                    <div class="d-flex justify-content-center">
                        <!-- Botón Editar -->
                        <button class="btn-icon-chico btn-gris-chico" [disabled]="estadoEdicion[i._id]"
                            (click)="habilitarEdicion(i._id)" matTooltip="Editar renglón">
                            <fa-icon [icon]="faEdit"></fa-icon>
                        </button>

                        <!-- Botón Guardar -->
                        <button class="btn-icon-chico btn-verde-chico"
                            [disabled]="estadoGuardado[i._id] === 'guardando' || !estadoEdicion[i._id]"
                            (click)="guardarFila(i)" matTooltip="Guardar">
                            <fa-icon *ngIf="estadoGuardado[i._id] === 'guardando'" [icon]="faSpinner"
                                class="fa-spin"></fa-icon>
                            <fa-icon *ngIf="estadoGuardado[i._id] === 'exito'" [icon]="faCheck"></fa-icon>
                            <fa-icon *ngIf="!estadoGuardado[i._id] || estadoGuardado[i._id] === 'idle'"
                                [icon]="faSave"></fa-icon>
                        </button>

                        <!-- Botón Cancelar -->
                        <button class="btn-icon-chico btn-rojo-chico"
                            [disabled]="estadoGuardado[i._id] === 'guardando' || !estadoEdicion[i._id]"
                            (click)="cancelarEdicion(i)" matTooltip="Cancelar">
                            <fa-icon [icon]="faTimes"></fa-icon>
                        </button>
                    </div>
                </td>

            </tr>
        </tbody>

    </table>
</div>

<div class="paginacion">
    <button (click)="irAPrimera()" [disabled]="paginaActual === 1" matTooltip="Primera página">
        <i class="fa fa-angle-double-left"></i>
    </button>

    <button (click)="paginaAnterior()" [disabled]="paginaActual === 1" matTooltip="Anterior">
        <i class="fa fa-angle-left"></i>
    </button>

    Página {{ paginaActual }} de {{ totalPaginas }}
    <span class="total-registros">({{ inventario.length }} productos)</span>

    <button (click)="paginaSiguiente()" [disabled]="paginaActual === totalPaginas" matTooltip="Siguiente">
        <i class="fa fa-angle-right"></i>
    </button>

    <button (click)="irAUltima()" [disabled]="paginaActual === totalPaginas" matTooltip="Última página">
        <i class="fa fa-angle-double-right"></i>
    </button>
</div>

<!-- </div> -->