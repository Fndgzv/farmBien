import{D as _e,E as ge,a as le}from"./chunk-TLW2RIS7.js";import{$c as se,Ab as I,Ac as $,Bb as V,Bc as J,Bd as pe,Cb as D,Cd as N,Db as M,Eb as h,Ec as K,Ed as T,Fb as k,Fc as Q,Ic as X,Ja as c,Jc as Y,Kc as Z,Mc as ee,Na as F,Pc as te,Qc as ie,Rc as ne,Sc as ae,Ua as G,Vc as oe,Xa as b,Z as B,Zc as re,_c as ce,ad as xe,bd as me,ca as W,cb as l,cd as de,d as ve,ec as L,fc as U,gb as o,hb as a,ia as _,ib as u,ja as g,lb as E,mc as z,nb as v,ob as d,pd as ue,rd as A,sc as H,tc as q,yc as R,zb as m}from"./chunk-3TU753TR.js";var x=ve(xe());var j=class s{constructor(t){this.http=t}baseUrl=`${R.apiUrl}/inventario-farmacia`;buscarInventarioFarmacia(t){let e=new H;return t.farmacia&&(e=e.set("farmacia",t.farmacia)),t.nombre&&(e=e.set("nombre",t.nombre)),t.codigoBarras&&(e=e.set("codigoBarras",t.codigoBarras)),t.categoria&&(e=e.set("categoria",t.categoria)),t.inapam!==""&&(e=e.set("inapam",t.inapam)),t.generico!==""&&(e=e.set("generico",t.generico)),this.http.get(`${this.baseUrl}/`,{params:e})}actualizarUno(t,e){return this.http.put(`${this.baseUrl}/${t}`,e)}actualizarMasivo(t,e){return this.http.put(`${this.baseUrl}/masivo/${t}`,e)}static \u0275fac=function(e){return new(e||s)(W(q))};static \u0275prov=B({token:s,factory:s.\u0275fac,providedIn:"root"})};function he(s,t){if(s&1&&(o(0,"option",33),m(1),a()),s&2){let e=t.$implicit;l("value",e._id),c(),I(e.nombre)}}function ke(s,t){if(s&1){let e=E();o(0,"button",34),v("click",function(){_(e);let n=d();return g(n.limpiarFiltro("nombre"))}),u(1,"fa-icon",35),a()}if(s&2){let e=d();c(),l("icon",e.faTimes)}}function Ce(s,t){if(s&1){let e=E();o(0,"button",34),v("click",function(){_(e);let n=d();return g(n.limpiarFiltro("codigoBarras"))}),u(1,"fa-icon",35),a()}if(s&2){let e=d();c(),l("icon",e.faTimes)}}function Se(s,t){if(s&1){let e=E();o(0,"button",34),v("click",function(){_(e);let n=d();return g(n.limpiarFiltro("categoria"))}),u(1,"fa-icon",35),a()}if(s&2){let e=d();c(),l("icon",e.faTimes)}}function ye(s,t){if(s&1){let e=E();o(0,"button",34),v("click",function(){_(e);let n=d();return g(n.limpiarFiltro("inapam"))}),u(1,"fa-icon",35),a()}if(s&2){let e=d();c(),l("icon",e.faTimes)}}function Ee(s,t){if(s&1){let e=E();o(0,"button",34),v("click",function(){_(e);let n=d();return g(n.limpiarFiltro("generico"))}),u(1,"fa-icon",35),a()}if(s&2){let e=d();c(),l("icon",e.faTimes)}}function Fe(s,t){if(s&1&&u(0,"fa-icon",53),s&2){let e=d(3);l("icon",e.faSpinner)}}function Ie(s,t){if(s&1&&u(0,"fa-icon",35),s&2){let e=d(3);l("icon",e.faCheck)}}function Ve(s,t){if(s&1&&u(0,"fa-icon",35),s&2){let e=d(3);l("icon",e.faSave)}}function je(s,t){if(s&1){let e=E();o(0,"tr")(1,"td")(2,"input",44),k("ngModelChange",function(n){let r=_(e).$implicit;return h(r.seleccionado,n)||(r.seleccionado=n),g(n)}),a()(),o(3,"td"),m(4),a(),o(5,"td"),m(6),a(),o(7,"td"),m(8),a(),o(9,"td",38),m(10),a(),o(11,"td",38),m(12),a(),o(13,"td")(14,"input",45),k("ngModelChange",function(n){let r=_(e).$implicit;return h(r.existencia,n)||(r.existencia=n),g(n)}),a()(),o(15,"td")(16,"input",45),k("ngModelChange",function(n){let r=_(e).$implicit;return h(r.stockMax,n)||(r.stockMax=n),g(n)}),a()(),o(17,"td")(18,"input",45),k("ngModelChange",function(n){let r=_(e).$implicit;return h(r.stockMin,n)||(r.stockMin=n),g(n)}),a()(),o(19,"td")(20,"input",46),k("ngModelChange",function(n){let r=_(e).$implicit;return h(r.precioVenta,n)||(r.precioVenta=n),g(n)}),a()(),o(21,"td")(22,"div",47)(23,"button",48),v("click",function(){let n=_(e).$implicit,r=d(2);return g(r.habilitarEdicion(n._id))}),u(24,"fa-icon",35),a(),o(25,"button",49),v("click",function(){let n=_(e).$implicit,r=d(2);return g(r.guardarFila(n))}),b(26,Fe,1,1,"fa-icon",50)(27,Ie,1,1,"fa-icon",51)(28,Ve,1,1,"fa-icon",51),a(),o(29,"button",52),v("click",function(){let n=_(e).$implicit,r=d(2);return g(r.cancelarEdicion(n))}),u(30,"fa-icon",35),a()()()()}if(s&2){let e=t.$implicit,i=d(2);c(2),M("ngModel",e.seleccionado),c(2),I(e.producto==null?null:e.producto.nombre),c(2),I(e.producto==null?null:e.producto.codigoBarras),c(2),I(e.producto==null?null:e.producto.categoria),c(2),V(" ",e.producto!=null&&e.producto.generico?"S\xED":"No"," "),c(2),V(" ",e.producto!=null&&e.producto.descuentoINAPAM?"S\xED":"No"," "),c(2),l("disabled",!i.estadoEdicion[e._id]),M("ngModel",e.existencia),c(2),l("disabled",!i.estadoEdicion[e._id]),M("ngModel",e.stockMax),c(2),l("disabled",!i.estadoEdicion[e._id]),M("ngModel",e.stockMin),c(2),l("disabled",!i.estadoEdicion[e._id]),M("ngModel",e.precioVenta),c(3),l("disabled",i.estadoEdicion[e._id]),c(),l("icon",i.faEdit),c(),l("disabled",i.estadoGuardado[e._id]==="guardando"||!i.estadoEdicion[e._id]),c(),l("ngIf",i.estadoGuardado[e._id]==="guardando"),c(),l("ngIf",i.estadoGuardado[e._id]==="exito"),c(),l("ngIf",!i.estadoGuardado[e._id]||i.estadoGuardado[e._id]==="idle"),c(),l("disabled",i.estadoGuardado[e._id]==="guardando"||!i.estadoEdicion[e._id]),c(),l("icon",i.faTimes)}}function we(s,t){if(s&1){let e=E();o(0,"div",36)(1,"table",37)(2,"thead",38)(3,"tr",39)(4,"th"),m(5,"AJUSTE MASIVO"),a(),u(6,"th")(7,"th")(8,"th")(9,"th")(10,"th"),o(11,"th")(12,"input",40),k("ngModelChange",function(n){_(e);let r=d();return h(r.ajusteMasivo.existencia,n)||(r.ajusteMasivo.existencia=n),g(n)}),a()(),o(13,"th")(14,"input",40),k("ngModelChange",function(n){_(e);let r=d();return h(r.ajusteMasivo.stockMax,n)||(r.ajusteMasivo.stockMax=n),g(n)}),a()(),o(15,"th")(16,"input",40),k("ngModelChange",function(n){_(e);let r=d();return h(r.ajusteMasivo.stockMin,n)||(r.ajusteMasivo.stockMin=n),g(n)}),a()(),o(17,"th")(18,"button",41),v("click",function(){_(e);let n=d();return g(n.guardarAjusteMasivo())}),m(19," Aplicar a todos "),a()(),u(20,"th"),a(),o(21,"tr")(22,"th")(23,"input",42),v("change",function(n){_(e);let r=d();return g(r.seleccionarTodos(n))}),a()(),o(24,"th"),m(25,"Nombre"),a(),o(26,"th"),m(27,"C\xF3digo barras"),a(),o(28,"th"),m(29,"Categoria"),a(),o(30,"th"),m(31,"Gen\xE9rico"),a(),o(32,"th"),m(33,"INAPAM"),a(),o(34,"th"),m(35,"Existencia"),a(),o(36,"th"),m(37,"Stock M\xE1x"),a(),o(38,"th"),m(39,"Stock M\xEDn"),a(),o(40,"th"),m(41,"Precio Venta"),a(),o(42,"th"),m(43,"Acciones"),a()()(),o(44,"tbody"),b(45,je,31,22,"tr",43),a()()()}if(s&2){let e=d();c(12),M("ngModel",e.ajusteMasivo.existencia),c(2),M("ngModel",e.ajusteMasivo.stockMax),c(2),M("ngModel",e.ajusteMasivo.stockMin),c(2),l("disabled",e.deshabilitarBotonAplicar),c(27),l("ngForOf",e.inventarioPaginado)}}var fe=class s{constructor(t,e,i,n){this.fb=t;this.inventarioService=e;this.farmaciaService=i;this.library=n;n.addIcons(A,N,T)}formFiltros;inventario=[];farmacias=[];ajusteMasivo={existencia:0,stockMax:0,stockMin:0};estadoEdicion={};paginaActual=1;tamanoPagina=15;faSpinner=N;faCheck=T;faSave=A;faEdit=ue;faTimes=pe;estadoGuardado={};ngOnInit(){this.formFiltros=this.fb.group({farmacia:[""],nombre:[""],codigoBarras:[""],categoria:[""],inapam:[""],generico:[""]}),this.cargarFarmacias()}cargarFarmacias(){this.farmaciaService.obtenerFarmacias().subscribe({next:t=>{if(this.farmacias=t,this.farmacias.length>0){let e=this.farmacias[0]._id;this.formFiltros.get("farmacia")?.setValue(e),this.buscar()}},error:()=>this.farmacias=[]})}buscar(){let t=this.formFiltros.value;if(!t.farmacia){alert("Debe seleccionar una farmacia");return}this.inventarioService.buscarInventarioFarmacia(t).subscribe({next:e=>{this.estadoEdicion={},this.inventario=e.map(i=>({_id:i._id,farmacia:i.farmacia,producto:i.producto,existencia:i.existencia,stockMax:i.stockMax,stockMin:i.stockMin,precioVenta:i.precioVenta,seleccionado:!1,copiaOriginal:{existencia:i.existencia,stockMax:i.stockMax,stockMin:i.stockMin,precioVenta:i.precioVenta}})),this.paginaActual=1},error:e=>{console.error("Error al buscar inventario",e),this.inventario=[]}})}seleccionarTodos(t){let e=t.target.checked;this.inventario.forEach(i=>i.seleccionado=e)}guardarAjusteMasivo(){let t=this.formFiltros.get("farmacia")?.value;if(!t)return;let e=Number(this.ajusteMasivo.existencia),i=Number(this.ajusteMasivo.stockMax),n=Number(this.ajusteMasivo.stockMin),r=!isNaN(e),f=!isNaN(i),C=!isNaN(n),S=this.inventario.filter(p=>p.seleccionado&&(r&&p.existencia!==e||f&&p.stockMax!==i||C&&p.stockMin!==n));if(S.length===0){x.default.fire("Sin cambios","No hay productos seleccionados o no hay cambios para aplicar.","info");return}let w=S.map(p=>{let y={id:p._id};return r&&(y.existencia=e),f&&(y.stockMax=i),C&&(y.stockMin=n),y});this.inventarioService.actualizarMasivo(t,w).subscribe({next:()=>{for(let p of S)r&&e>0&&(p.existencia=e,p.copiaOriginal.existencia=e),f&&i>0&&(p.stockMax=i,p.copiaOriginal.stockMax=i),C&&n>0&&(p.stockMin=n,p.copiaOriginal.stockMin=n);x.default.fire("Actualizado","Ajustes aplicados correctamente.","success"),this.ajusteMasivo.existencia=0,this.ajusteMasivo.stockMax=0,this.ajusteMasivo.stockMin=0},error:p=>{console.error("Error en ajuste masivo",p),x.default.fire("Error","No se pudieron aplicar los ajustes.","error")}})}guardarFila(t){let e=t._id,i=[{campo:"existencia",valor:t.existencia},{campo:"stockMax",valor:t.stockMax},{campo:"stockMin",valor:t.stockMin},{campo:"precioVenta",valor:t.precioVenta}];for(let{campo:r,valor:f}of i){if(f==null||f===""){x.default.fire("Campo vac\xEDo",`El campo "${r}" es obligatorio.`,"warning");return}if(isNaN(f)||f<0){x.default.fire("Valor inv\xE1lido",`El campo "${r}" no puede ser negativo.`,"warning");return}}if(t.stockMin>t.stockMax){x.default.fire({icon:"warning",title:"Stock m\xEDnimo inv\xE1lido",text:"El stock m\xEDnimo no puede ser mayor que el stock m\xE1ximo."});return}if(t.existencia==null||isNaN(t.existencia)||!Number.isInteger(t.existencia)||t.existencia<0){x.default.fire("Valor inv\xE1lido","La existencia debe ser un n\xFAmero entero y no negativo.","warning");return}if(t.precioVenta==null||isNaN(t.precioVenta)||t.precioVenta<=0||!/^\d+(\.\d{1,2})?$/.test(t.precioVenta.toString())){x.default.fire("Valor inv\xE1lido","El precio de venta debe ser un n\xFAmero positivo con hasta 2 decimales.","warning");return}if(!(t.existencia!==t.copiaOriginal.existencia||t.stockMax!==t.copiaOriginal.stockMax||t.stockMin!==t.copiaOriginal.stockMin||t.precioVenta!==t.copiaOriginal.precioVenta)){x.default.fire({icon:"info",title:"Sin cambios",text:"No se detectaron cambios en este producto."});return}this.estadoGuardado[e]="guardando",this.inventarioService.actualizarUno(e,{existencia:t.existencia,stockMax:t.stockMax,stockMin:t.stockMin,precioVenta:t.precioVenta}).subscribe({next:()=>{t.copiaOriginal={existencia:t.existencia,stockMax:t.stockMax,stockMin:t.stockMin,precioVenta:t.precioVenta},this.estadoGuardado[e]="exito",setTimeout(()=>{this.estadoGuardado[e]="idle"},1500),x.default.fire({icon:"success",title:"\xC9xito",text:"El producto fue actualizado correctamente.",timer:1600,timerProgressBar:!0,allowOutsideClick:!1,allowEscapeKey:!1}),this.buscar(),this.estadoEdicion[t._id]=!1},error:r=>{console.error("Error al guardar fila:",r),this.estadoGuardado[e]="idle",x.default.fire({icon:"error",title:"Error",text:"No se pudo guardar el producto."})}})}get nombreFarmaciaSeleccionada(){let t=this.formFiltros.get("farmacia")?.value;return this.farmacias.find(i=>i._id===t)?.nombre||"Farmacia"}get totalPaginas(){return Math.ceil(this.inventario.length/this.tamanoPagina)}get inventarioPaginado(){let t=(this.paginaActual-1)*this.tamanoPagina;return this.inventario.slice(t,t+this.tamanoPagina)}paginaAnterior(){this.paginaActual>1&&this.paginaActual--}paginaSiguiente(){this.paginaActual<this.totalPaginas&&this.paginaActual++}irAPrimera(){this.paginaActual=1}irAUltima(){this.paginaActual=this.totalPaginas}sePuedeGuardar(t){if(!t||!t.copiaOriginal)return!1;let e=t.existencia!==t.copiaOriginal.existencia||t.stockMax!==t.copiaOriginal.stockMax||t.stockMin!==t.copiaOriginal.stockMin||t.precioVenta!==t.copiaOriginal.precioVenta,i=t.existencia>=0&&t.stockMax>=0&&t.stockMin>=0&&t.precioVenta>=0;return e&&i}get deshabilitarBotonAplicar(){let{existencia:t,stockMax:e,stockMin:i}=this.ajusteMasivo,n=Number(t),r=Number(e),f=Number(i),C=!isNaN(n),S=!isNaN(r),w=!isNaN(f),p=S&&Number.isInteger(r)&&r>0,y=w&&Number.isInteger(f)&&f>0,O=C&&Number.isInteger(n)&&n>0,P=p&&y?f<=r:!0;return!(O&&r<=0&&f<=0||p&&y&&P||O&&p&&y&&P)}habilitarEdicion(t){this.estadoEdicion[t]=!0}cancelarEdicion(t){t.existencia=t.copiaOriginal.existencia,t.stockMax=t.copiaOriginal.stockMax,t.stockMin=t.copiaOriginal.stockMin,t.precioVenta=t.copiaOriginal.precioVenta,this.estadoEdicion[t._id]=!1,this.estadoGuardado[t._id]="idle"}limpiarFiltro(t){this.formFiltros.get(t)?.setValue(""),this.buscar()}static \u0275fac=function(e){return new(e||s)(F(re),F(j),F(le),F(me))};static \u0275cmp=G({type:s,selectors:[["app-ajustes-inventario-farmacia"]],decls:70,vars:16,consts:[[1,"container"],[1,"titulo-container"],[1,"titulo"],[3,"ngSubmit","formGroup"],[1,"row"],[1,"col-md-2"],["formControlName","farmacia","required","",1,"form-control"],[3,"value",4,"ngFor","ngForOf"],[1,"col-md-3"],[1,"position-relative"],["type","text","formControlName","nombre",1,"form-control","pr-4"],["type","button","class","btn btn-sm btn-light position-absolute top-50 end-0 translate-middle-y btn-rojo-chico",3,"click",4,"ngIf"],["type","text","formControlName","codigoBarras",1,"form-control","pr-4"],["type","text","formControlName","categoria",1,"form-control","pr-4"],[1,"col-md-1"],["formControlName","inapam",1,"form-control","pr-4"],["value",""],["value","true"],["value","false"],["formControlName","generico",1,"form-control","pr-4"],[1,"col-md-1","text-end","mt-3"],["type","submit",1,"btn-gris"],["class","mt-3",4,"ngIf"],[1,"paginacion"],["title","Primera p\xE1gina",3,"click","disabled"],[1,"fa","fa-angle-double-left"],["title","Anterior",3,"click","disabled"],[1,"fa","fa-angle-left"],[1,"total-registros"],["title","Siguiente",3,"click","disabled"],[1,"fa","fa-angle-right"],["title","\xDAltima p\xE1gina",3,"click","disabled"],[1,"fa","fa-angle-double-right"],[3,"value"],["type","button",1,"btn","btn-sm","btn-light","position-absolute","top-50","end-0","translate-middle-y","btn-rojo-chico",3,"click"],[3,"icon"],[1,"mt-3"],[1,"tabla"],[1,"text-center"],[2,"color","blue"],["type","number",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],[1,"btn-gris-chico",3,"click","disabled"],["type","checkbox",3,"change"],[4,"ngFor","ngForOf"],["type","checkbox",3,"ngModelChange","ngModel"],["type","number",1,"form-control","form-control-sm",3,"ngModelChange","disabled","ngModel"],["type","number","step","0.1",1,"form-control","form-control-sm",3,"ngModelChange","disabled","ngModel"],[1,"d-flex","justify-content-center"],["matTooltip","Editar rengl\xF3n",1,"btn-icon-chico","btn-gris-chico",3,"click","disabled"],["matTooltip","Guardar",1,"btn-icon-chico","btn-verde-chico",3,"click","disabled"],["class","fa-spin",3,"icon",4,"ngIf"],[3,"icon",4,"ngIf"],["matTooltip","Cancelar",1,"btn-icon-chico","btn-rojo-chico",3,"click","disabled"],[1,"fa-spin",3,"icon"]],template:function(e,i){if(e&1&&(o(0,"div",0)(1,"div",1)(2,"h1",2),m(3),a()(),o(4,"form",3),v("ngSubmit",function(){return i.buscar()}),o(5,"div",4)(6,"div",5)(7,"label"),m(8,"Farmacia"),a(),o(9,"select",6),b(10,he,2,2,"option",7),a()(),o(11,"div",8)(12,"label"),m(13,"Nombre"),a(),o(14,"div",9),u(15,"input",10),b(16,ke,2,1,"button",11),a()(),o(17,"div",5)(18,"label"),m(19,"C\xF3digo de Barras"),a(),o(20,"div",9),u(21,"input",12),b(22,Ce,2,1,"button",11),a()(),o(23,"div",5)(24,"label"),m(25,"Categor\xEDa"),a(),o(26,"div",9),u(27,"input",13),b(28,Se,2,1,"button",11),a()(),o(29,"div",14)(30,"label"),m(31,"INAPAM"),a(),o(32,"div",9)(33,"select",15)(34,"option",16),m(35,"--"),a(),o(36,"option",17),m(37,"S\xED"),a(),o(38,"option",18),m(39,"No"),a()(),b(40,ye,2,1,"button",11),a()(),o(41,"div",14)(42,"label"),m(43,"Gen\xE9rico?"),a(),o(44,"div",9)(45,"select",19)(46,"option",16),m(47,"--"),a(),o(48,"option",17),m(49,"S\xED"),a(),o(50,"option",18),m(51,"No"),a()(),b(52,Ee,2,1,"button",11),a()(),o(53,"div",20)(54,"button",21),m(55,"Buscar"),a()()()(),u(56,"hr"),b(57,we,46,5,"div",22),o(58,"div",23)(59,"button",24),v("click",function(){return i.irAPrimera()}),u(60,"i",25),a(),o(61,"button",26),v("click",function(){return i.paginaAnterior()}),u(62,"i",27),a(),m(63),o(64,"span",28),m(65),a(),o(66,"button",29),v("click",function(){return i.paginaSiguiente()}),u(67,"i",30),a(),o(68,"button",31),v("click",function(){return i.irAUltima()}),u(69,"i",32),a()()()),e&2){let n,r,f,C,S;c(3),V("Ajustes de Inventario en ",i.nombreFarmaciaSeleccionada,""),c(),l("formGroup",i.formFiltros),c(6),l("ngForOf",i.farmacias),c(6),l("ngIf",(n=i.formFiltros.get("nombre"))==null?null:n.value),c(6),l("ngIf",(r=i.formFiltros.get("codigoBarras"))==null?null:r.value),c(6),l("ngIf",(f=i.formFiltros.get("categoria"))==null?null:f.value),c(12),l("ngIf",((C=i.formFiltros.get("inapam"))==null?null:C.value)!==""),c(12),l("ngIf",((S=i.formFiltros.get("generico"))==null?null:S.value)!==""),c(5),l("ngIf",i.inventario.length>0),c(2),l("disabled",i.paginaActual===1),c(2),l("disabled",i.paginaActual===1),c(2),D(" P\xE1gina ",i.paginaActual," de ",i.totalPaginas," "),c(2),V("(",i.inventario.length," productos)"),c(),l("disabled",i.paginaActual===i.totalPaginas),c(2),l("disabled",i.paginaActual===i.totalPaginas)}},dependencies:[z,L,U,ce,Y,ne,ae,J,Z,$,ie,K,Q,oe,X,se,ee,te,de,ge,_e],styles:[".paginacion[_ngcontent-%COMP%]{text-align:center;font-size:large;font-weight:500;color:#8a2be2}.paginacion[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{color:#0ff;background-color:#8a2be2}.paginacion[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:disabled, .paginacion[_ngcontent-%COMP%]   button[disabled][_ngcontent-%COMP%]{cursor:not-allowed;opacity:.6;color:gray}"]})};export{fe as AjustesInventarioFarmaciaComponent};
