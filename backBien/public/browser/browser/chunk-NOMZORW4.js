import{a as Ce}from"./chunk-ENAHLAZL.js";import{a as Ie}from"./chunk-JKGFMHHD.js";import{$ as I,$c as w,A as L,Ab as n,Ad as ve,Ae as xe,Bb as t,Be as be,Cb as C,Db as E,Eb as P,Fd as _e,Gb as S,Hc as Y,Hd as fe,Ib as x,Ic as Z,Jb as u,Ob as D,Pb as V,Q as j,Qb as R,Rc as J,S as H,Sc as W,Tb as B,Tc as ee,Ub as a,V as U,Vb as s,Wb as _,Xa as l,Zc as te,_ as q,_c as ie,ab as G,cd as F,dc as b,fd as ne,gb as K,gd as O,ha as h,hc as X,ia as y,ic as g,id as re,jc as f,jd as oe,kb as c,kc as $,l as A,od as ae,pd as le,q as z,qd as pe,rb as d,sd as de,tb as Q,vd as se,wd as me,xd as ce,yd as ue,zd as ge}from"./chunk-EXDECSW5.js";import{a as k,b as M,e as Pe}from"./chunk-EQDQRRRY.js";var ye=Pe(Ie());var T=class r{constructor(i){this.http=i}base=`${F.apiUrl}/reportes`;headers(){return new te({"x-auth-token":localStorage.getItem("auth_token")||""})}params(i){let e=new ie;return Object.entries(i||{}).forEach(([o,p])=>{p!=null&&String(p).trim()!==""&&(e=e.set(o,String(p)))}),e}getResumen(i){return this.http.get(`${this.base}/compras-resumen`,{params:this.params(i),headers:this.headers()})}getAgrupado(i,e){return this.http.get(`${this.base}/compras-${i}`,{params:this.params(e),headers:this.headers()})}searchProveedores(i){let e=`${F.apiUrl}/proveedores?buscar=${encodeURIComponent(i)}&limit=10`;return this.http.get(e,{headers:this.headers()}).pipe(H({error:()=>{}}),j(o=>A(o?.data??o?.rows??o??[])))}searchProductos(i){let e=`${F.apiUrl}/productos/search?q=${encodeURIComponent(i)}&limit=50`;return this.http.get(e,{headers:this.headers()}).pipe(z(o=>o?.data??o?.rows??o??[]),L(()=>A([])))}static \u0275fac=function(e){return new(e||r)(q(w))};static \u0275prov=U({token:r,factory:r.\u0275fac,providedIn:"root"})};var Fe=["provInput"],Oe=["prodInput"],Te=r=>({t:"Compras",v:r}),Ne=r=>({t:"Importe",v:r,isMoney:!0}),ke=r=>({t:"Piezas",v:r}),Me=r=>({t:"Ticket Prom.",v:r,isMoney:!0}),Ae=r=>({t:"Costo Prom. Ponderado",v:r,isMoney:!0}),De=r=>({t:"Venta Potencial",v:r,isMoney:!0}),Ve=r=>({t:"Margen Te\xF3rico",v:r,isMoney:!0}),Re=r=>({t:"% Margen",v:r,isPct:!0}),Be=r=>({t:"Proveedores Distintos",v:r}),$e=r=>({t:"Productos Distintos",v:r}),ze=(r,i,e,o,p,m,v,N,Se,Ee)=>[r,i,e,o,p,m,v,N,Se,Ee];function Le(r,i){if(r&1&&(E(0),a(1),P()),r&2){let e=u().$implicit;l(),_(" \u2014 ",e.telefono,"")}}function je(r,i){if(r&1&&(n(0,"option",24),a(1),c(2,Le,2,1,"ng-container",18),t()),r&2){let e=i.$implicit;d("value",e._id),l(),_(" ",e.nombre,""),l(),d("ngIf",e.telefono)}}function He(r,i){if(r&1){let e=S();n(0,"button",35),x("click",function(){let p=h(e).$implicit,m=u(3);return y(m.selectProd(p))}),n(1,"div",36),a(2),t(),n(3,"small",37),a(4),t()()}if(r&2){let e=i.$implicit;l(2),s(e.nombre||"(sin nombre)"),l(2),_("CB: ",e.codigoBarras||"\u2014","")}}function Ue(r,i){if(r&1&&(n(0,"div",33),c(1,He,5,2,"button",34),t()),r&2){let e=u(2);l(),d("ngForOf",e.prodOpts)}}function qe(r,i){if(r&1&&(n(0,"span"),a(1),t()),r&2){let e=u(3);l(),_("\xB7 ",e.prodSel.codigoBarras,"")}}function Ge(r,i){if(r&1){let e=S();n(0,"div",38)(1,"span",39),a(2),c(3,qe,2,1,"span",18),t(),n(4,"button",40),x("click",function(){h(e),u();let p=B(6),m=u();return y(m.clearProd(p))}),a(5,"Borrar"),t()()}if(r&2){let e=u(2);l(2),_(" ",e.prodSel.nombre," "),l(),d("ngIf",e.prodSel.codigoBarras)}}function Ke(r,i){if(r&1&&(n(0,"option",24),a(1),t()),r&2){let e=i.$implicit;d("value",e),l(),s(e)}}function Qe(r,i){if(r&1&&(n(0,"option",24),a(1),t()),r&2){let e=i.$implicit;d("value",e),l(),s(e)}}function Xe(r,i){if(r&1){let e=S();n(0,"div")(1,"div",3)(2,"div",25)(3,"label",11),a(4,"Producto"),t(),n(5,"input",26,0),x("input",function(p){h(e);let m=u();return y(m.onProdInput(p.target.value))}),t(),c(7,Ue,2,1,"div",27)(8,Ge,6,2,"div",28),t(),n(9,"div",10)(10,"label",11),a(11,"Ordenado por:"),t(),n(12,"div",29)(13,"select",30),c(14,Ke,2,2,"option",16),t()()(),n(15,"div",10)(16,"label",11),a(17,"Ascen / Desc:"),t(),n(18,"select",31),c(19,Qe,2,2,"option",16),t()(),n(20,"div",10)(21,"label",11),a(22,"Top N"),t(),C(23,"input",32),t()()()}if(r&2){let e=u();l(5),d("disabled",e.cargando||!!e.prodSel),l(2),d("ngIf",e.prodOpts.length&&!e.prodSel),l(),d("ngIf",e.prodSel),l(6),d("ngForOf",e.ordenes),l(5),d("ngForOf",e.dirs)}}function Ye(r,i){if(r&1){let e=S();n(0,"button",35),x("click",function(){let p=h(e).$implicit,m=u(3);return y(m.selectProd(p))}),n(1,"div",36),a(2),t(),n(3,"small",37),a(4),t()()}if(r&2){let e=i.$implicit;l(2),s(e.nombre||"(sin nombre)"),l(2),_("CB: ",e.codigoBarras||"\u2014","")}}function Ze(r,i){if(r&1&&(n(0,"div",33),c(1,Ye,5,2,"button",34),t()),r&2){let e=u(2);l(),d("ngForOf",e.prodOpts)}}function Je(r,i){if(r&1&&(n(0,"span"),a(1),t()),r&2){let e=u(3);l(),_("\xB7 ",e.prodSel.codigoBarras,"")}}function We(r,i){if(r&1){let e=S();n(0,"div",38)(1,"span",39),a(2),c(3,Je,2,1,"span",18),t(),n(4,"button",40),x("click",function(){h(e),u();let p=B(6),m=u();return y(m.clearProd(p))}),a(5,"Borrar"),t()()}if(r&2){let e=u(2);l(2),_(" ",e.prodSel.nombre," "),l(),d("ngIf",e.prodSel.codigoBarras)}}function et(r,i){if(r&1&&(n(0,"option",24),a(1),t()),r&2){let e=i.$implicit;d("value",e),l(),s(e)}}function tt(r,i){if(r&1&&(n(0,"option",24),a(1),t()),r&2){let e=i.$implicit;d("value",e),l(),s(e)}}function it(r,i){if(r&1&&(n(0,"option",24),a(1),t()),r&2){let e=i.$implicit;d("value",e),l(),s(e)}}function nt(r,i){if(r&1){let e=S();n(0,"div")(1,"div",3)(2,"div",25)(3,"label",11),a(4,"Producto"),t(),n(5,"input",26,0),x("input",function(p){h(e);let m=u();return y(m.onProdInput(p.target.value))}),t(),c(7,Ze,2,1,"div",27)(8,We,6,2,"div",28),t(),n(9,"div",10)(10,"label",11),a(11,"agrupar por:"),t(),n(12,"div",29)(13,"select",41),c(14,et,2,2,"option",16),t()()(),n(15,"div",10)(16,"label",11),a(17,"Ordenar por:"),t(),n(18,"select",42),c(19,tt,2,2,"option",16),t()(),n(20,"div",10)(21,"label",11),a(22,"Ascen / Desc:"),t(),n(23,"select",43),c(24,it,2,2,"option",16),t()(),n(25,"div",10)(26,"label",11),a(27,"Top N:"),t(),C(28,"input",44),t()()()}if(r&2){let e=u();l(5),d("disabled",e.cargando||!!e.prodSel),l(2),d("ngIf",e.prodOpts.length&&!e.prodSel),l(),d("ngIf",e.prodSel),l(6),d("ngForOf",e.agrupaciones),l(5),d("ngForOf",e.ordenes),l(5),d("ngForOf",e.dirs)}}function rt(r,i){if(r&1&&(E(0),n(1,"div",58)(2,"div",59)(3,"div",60),a(4),t(),n(5,"div",61),a(6),g(7,"number"),g(8,"currency"),g(9,"number"),t()()(),P()),r&2){let e=i.$implicit;l(4),s(e.t),l(2),_(" ",e.v===null?"\u2014":e.isPct?$(7,2,e.v,"1.0-2")+"%":e.isMoney?f(8,5,e.v):$(9,7,e.v,"1.0-2")," ")}}function ot(r,i){if(r&1&&(n(0,"tr")(1,"td"),a(2),t(),n(3,"td",62),a(4),g(5,"currency"),t(),n(6,"td",62),a(7),t(),n(8,"td",62),a(9),t(),n(10,"td",62),a(11),g(12,"currency"),t(),n(13,"td",62),a(14),g(15,"currency"),t()()),r&2){let e=i.$implicit;l(2),s(e.nombre||e.proveedorId),l(2),s(f(5,6,e.importe)),l(3),s(e.piezas),l(2),s(e.compras),l(2),s(f(12,8,e.venta)),l(3),s(f(15,10,e.margen))}}function at(r,i){r&1&&(n(0,"tr")(1,"td",63),a(2,"Sin datos"),t()())}function lt(r,i){if(r&1&&(n(0,"tr")(1,"td"),a(2),t(),n(3,"td"),a(4),t(),n(5,"td",62),a(6),g(7,"currency"),t(),n(8,"td",62),a(9),t(),n(10,"td",62),a(11),g(12,"currency"),t(),n(13,"td",62),a(14),g(15,"currency"),t()()),r&2){let e=i.$implicit;l(2),s(e.nombre||e.productoId),l(2),s(e.codigoBarras||"\u2014"),l(2),s(f(7,6,e.importe)),l(3),s(e.piezas),l(2),s(f(12,8,e.venta)),l(3),s(f(15,10,e.margen))}}function pt(r,i){r&1&&(n(0,"tr")(1,"td",63),a(2,"Sin datos"),t()())}function dt(r,i){if(r&1&&(n(0,"tr")(1,"td"),a(2),t(),n(3,"td",62),a(4),g(5,"currency"),t(),n(6,"td",62),a(7),t(),n(8,"td",62),a(9),g(10,"currency"),t(),n(11,"td",62),a(12),g(13,"currency"),t()()),r&2){let e=i.$implicit;l(2),s(e.categoria||"(sin categor\xEDa)"),l(2),s(f(5,5,e.importe)),l(3),s(e.piezas),l(2),s(f(10,7,e.venta)),l(3),s(f(13,9,e.margen))}}function st(r,i){r&1&&(n(0,"tr")(1,"td",64),a(2,"Sin datos"),t()())}function mt(r,i){if(r&1&&(n(0,"tr")(1,"td"),a(2),t(),n(3,"td",62),a(4),g(5,"currency"),t(),n(6,"td",62),a(7),t(),n(8,"td",62),a(9),g(10,"currency"),t(),n(11,"td",62),a(12),g(13,"currency"),t()()),r&2){let e=i.$implicit;l(2),s(e.nombre||e.usuarioId),l(2),s(f(5,5,e.importe)),l(3),s(e.piezas),l(2),s(f(10,7,e.venta)),l(3),s(f(13,9,e.margen))}}function ct(r,i){r&1&&(n(0,"tr")(1,"td",64),a(2,"Sin datos"),t()())}function ut(r,i){if(r&1&&(E(0),n(1,"div",45),c(2,rt,10,10,"ng-container",46),t(),n(3,"div",47)(4,"div",48)(5,"div",49),a(6,"Caducidad"),t(),n(7,"div",50)(8,"div",51)(9,"b"),a(10,"30 d\xEDas \xF3 antes:"),t(),a(11),t(),n(12,"div",51)(13,"b"),a(14,"60 d\xEDas \xF3 antes:"),t(),a(15),t(),n(16,"div",51)(17,"b"),a(18,"90 d\xEDas \xF3 antes:"),t(),a(19),t(),n(20,"div",51)(21,"b"),a(22,"Prom. d\xEDas a caducar:"),t(),a(23),t()()()(),n(24,"div",52)(25,"div",53)(26,"div",54),a(27,"Top Proveedores"),t(),n(28,"div",55)(29,"table",56)(30,"thead")(31,"tr")(32,"th"),a(33,"Proveedor"),t(),n(34,"th"),a(35,"Importe"),t(),n(36,"th"),a(37,"Pzas"),t(),n(38,"th"),a(39,"Compras"),t(),n(40,"th"),a(41,"Venta"),t(),n(42,"th"),a(43,"Margen"),t()()(),n(44,"tbody"),c(45,ot,16,12,"tr",46)(46,at,3,0,"tr",18),t()()()()(),n(47,"div",52)(48,"div",53)(49,"div",57),a(50,"Top Productos"),t(),n(51,"div",55)(52,"table",56)(53,"thead")(54,"tr")(55,"th"),a(56,"Producto"),t(),n(57,"th"),a(58,"CB"),t(),n(59,"th"),a(60,"Importe"),t(),n(61,"th"),a(62,"Pzas"),t(),n(63,"th"),a(64,"Venta"),t(),n(65,"th"),a(66,"Margen"),t()()(),n(67,"tbody"),c(68,lt,16,12,"tr",46)(69,pt,3,0,"tr",18),t()()()()(),n(70,"div",52)(71,"div",53)(72,"div",57),a(73,"Top Categor\xEDas"),t(),n(74,"div",55)(75,"table",56)(76,"thead")(77,"tr")(78,"th"),a(79,"Categor\xEDa"),t(),n(80,"th"),a(81,"Importe"),t(),n(82,"th"),a(83,"Pzas"),t(),n(84,"th"),a(85,"Venta"),t(),n(86,"th"),a(87,"Margen"),t()()(),n(88,"tbody"),c(89,dt,14,11,"tr",46)(90,st,3,0,"tr",18),t()()()()(),n(91,"div",52)(92,"div",53)(93,"div",57),a(94,"Top Usuarios"),t(),n(95,"div",55)(96,"table",56)(97,"thead")(98,"tr")(99,"th"),a(100,"Usuario"),t(),n(101,"th"),a(102,"Importe"),t(),n(103,"th"),a(104,"Pzas"),t(),n(105,"th"),a(106,"Venta"),t(),n(107,"th"),a(108,"Margen"),t()()(),n(109,"tbody"),c(110,mt,14,11,"tr",46)(111,ct,3,0,"tr",18),t()()()()(),P()),r&2){let e,o=i.ngIf;l(2),d("ngForOf",X(33,ze,[b(13,Te,o.kpis.numCompras),b(15,Ne,o.kpis.importe),b(17,ke,o.kpis.piezas),b(19,Me,o.kpis.ticketPromedio),b(21,Ae,o.kpis.costoPromPonderado),b(23,De,o.kpis.ventaPotencial),b(25,Ve,o.kpis.margenTeorico),b(27,Re,o.kpis.margenTeoricoPct),b(29,Be,o.kpis.proveedoresDistintos),b(31,$e,o.kpis.productosDistintos)])),l(9),_(" ",o.caducidades.piezas30," productos"),l(4),_(" ",o.caducidades.piezas60," productos"),l(4),_(" ",o.caducidades.piezas90," productos"),l(4),_(" ",(e=o.caducidades.avgDias)!==null&&e!==void 0?e:"\u2014"," d\xEDas"),l(22),d("ngForOf",o.topProveedores),l(),d("ngIf",!(o.topProveedores!=null&&o.topProveedores.length)),l(22),d("ngForOf",o.topProductos),l(),d("ngIf",!(o.topProductos!=null&&o.topProductos.length)),l(20),d("ngForOf",o.topCategorias),l(),d("ngIf",!(o.topCategorias!=null&&o.topCategorias.length)),l(20),d("ngForOf",o.topUsuarios),l(),d("ngIf",!(o.topUsuarios!=null&&o.topUsuarios.length))}}function gt(r,i){if(r&1&&(n(0,"th"),a(1),t()),r&2){let e=i.$implicit;l(),s(e.label)}}function vt(r,i){if(r&1&&(n(0,"td"),a(1),t()),r&2){let e=i.$implicit,o=u().$implicit,p=u(2);Q("t-num",e.isNum),l(),_(" ",p.formatCell(o,e)," ")}}function _t(r,i){if(r&1&&(n(0,"tr"),c(1,vt,2,3,"td",68),t()),r&2){let e=u(2);l(),d("ngForOf",e.displayCols)}}function ft(r,i){r&1&&(n(0,"tr")(1,"td",69),a(2,"Sin datos"),t()())}function xt(r,i){if(r&1){let e=S();E(0),n(1,"div",65)(2,"button",66),x("click",function(){h(e);let p=u();return y(p.exportarCsv())}),a(3,"Exportar CSV"),t()(),n(4,"div",55)(5,"table",67)(6,"thead")(7,"tr"),c(8,gt,2,1,"th",46),t()(),n(9,"tbody"),c(10,_t,2,1,"tr",46)(11,ft,3,0,"tr",18),t()()(),P()}if(r&2){let e=u();l(2),d("disabled",!e.rowsAgrupado.length),l(6),d("ngForOf",e.displayCols),l(2),d("ngForOf",e.rowsAgrupado),l(),d("ngIf",!e.rowsAgrupado.length)}}var he=class r{constructor(i){this.proveedorService=i}fb=I(_e);http=I(w);svc=I(T);cargando=!1;filtroForm;resumen=null;agrupacion="proveedor";rowsAgrupado=[];displayKeys=[];agrupaciones=["proveedor","producto","categoria","usuario"];ordenes=["importe","piezas","compras","margen","venta"];dirs=["desc","asc"];provOpts=[];prodOpts=[];provSel=null;prodSel=null;proveedores=[];provInput;prodInput;moneyFmt=new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN",minimumFractionDigits:2});numFmt=new Intl.NumberFormat("es-MX",{minimumFractionDigits:0,maximumFractionDigits:2});displayCols=[];buildDisplayCols(i="_"){let e=this.rowsAgrupado?.[0]?Object.keys(this.rowsAgrupado[0]):[],o={proveedor:["proveedorId","_id"],producto:["productoId","_id"],usuario:["usuarioId","_id"],categoria:["_id"],_:[]},p=o[i]??o._,m={proveedorId:{label:"Proveedor Id"},productoId:{label:"Producto Id"},usuarioId:{label:"Usuario Id"},categoria:{label:"Categor\xEDa"},nombre:{label:"Nombre"},codigoBarras:{label:"CB"},compras:{label:"#Compras",type:"num",isNum:!0},piezas:{label:"Pzas",type:"num",isNum:!0},cantidad:{label:"Cantidad",type:"num",isNum:!0},importe:{label:"Importe",type:"money",isNum:!0},costo:{label:"Costo",type:"money",isNum:!0},venta:{label:"Venta",type:"money",isNum:!0},margen:{label:"Margen",type:"money",isNum:!0},margenPct:{label:"% Margen",type:"pct",isNum:!0},fecha:{label:"Fecha",type:"date"}};this.displayCols=e.filter(v=>!p.includes(v)).map(v=>({key:v,label:m[v]?.label??this.toLabel(v),type:m[v]?.type??(typeof this.rowsAgrupado[0][v]=="number"?"num":"text"),isNum:m[v]?.isNum??typeof this.rowsAgrupado[0][v]=="number"}))}toLabel(i){return i.replace(/([A-Z])/g," $1").replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()).trim()}formatCell(i,e){let o=i?.[e.key];if(o==null)return"\u2014";switch(e.type){case"money":return this.moneyFmt.format(+o);case"pct":return`${this.numFmt.format(+o)}%`;case"num":return this.numFmt.format(+o);case"date":{let p=new Date(o);return isNaN(p.getTime())?"\u2014":p.toLocaleDateString("es-MX")}default:return String(o)}}getDisplayKeys(i,e){if(!e?.length)return[];let o=Object.keys(e[0]),m={proveedor:["proveedorId","_id"],producto:["productoId","_id"],usuario:["usuarioId","_id"],categoria:["_id"]}[i]??[];return o.filter(v=>!m.includes(v))}ngOnInit(){let i=new Date,e=new Date(i.getFullYear(),i.getMonth(),1),o=p=>new Date(p.getTime()-p.getTimezoneOffset()*6e4).toISOString().slice(0,10);this.filtroForm=this.fb.group({fechaIni:[o(e),O.required],fechaFin:[o(i),O.required],proveedorId:[""],productoId:[""],categoria:[""],usuarioId:[""],vista:["resumen",O.required],topN:[10],orden:["importe"],dir:["desc"],agrupacion:["proveedor"],ordenAgr:["importe"],dirAgr:["desc"],topNAgr:[10]}),this.loadProveedores(),this.buscar()}loadProveedores(){this.proveedorService.obtenerProveedores().subscribe(i=>{this.proveedores=i.sort((e,o)=>e.nombre.localeCompare(o.nombre,"es",{sensitivity:"base"}))})}buscar(){if(this.cargando)return;this.cargando=!0;let i=this.filtroForm.getRawValue(),e={fechaIni:i.fechaIni,fechaFin:i.fechaFin,proveedorId:i.proveedorId||void 0,productoId:i.productoId||void 0,categoria:i.categoria||void 0,usuarioId:i.usuarioId||void 0};if(i.vista==="resumen")this.svc.getResumen(M(k({},e),{topN:i.topN,orden:i.orden,dir:i.dir})).subscribe({next:o=>{this.resumen=o,this.rowsAgrupado=[],this.displayKeys=[],this.cargando=!1},error:o=>this.handleError(o,"No se pudo cargar el resumen")});else{let o=i.agrupacion;this.svc.getAgrupado(o,M(k({},e),{topN:i.topNAgr,orden:i.ordenAgr,dir:i.dirAgr})).subscribe({next:p=>{this.rowsAgrupado=p?.rows||[],this.buildDisplayCols(o),this.resumen=null,this.cargando=!1},error:p=>this.handleError(p,`No se pudo cargar el agrupado por ${o}`)})}}limpiar(){let i=this.filtroForm.value.vista,e=new Date,o=new Date(e.getFullYear(),e.getMonth(),1),p=m=>new Date(m.getTime()-m.getTimezoneOffset()*6e4).toISOString().slice(0,10);this.filtroForm.reset({fechaIni:p(o),fechaFin:p(e),proveedorId:"",productoId:"",categoria:"",usuarioId:"",vista:i,topN:10,orden:"importe",dir:"desc",agrupacion:"proveedor",ordenAgr:"importe",dirAgr:"desc",topNAgr:10}),this.clearProv(this.provInput?.nativeElement),this.clearProd(this.prodInput?.nativeElement),this.buscar()}onProvInput(i){let e=(i||"").trim();if(e.length<2){this.provOpts=[];return}this.svc.searchProveedores(e).subscribe(o=>{this.provOpts=Array.isArray(o)?o:[]})}selectProv(i){this.provSel=i,this.provOpts=[],this.filtroForm.patchValue({proveedorId:i._id})}clearProv(i){this.provSel=null,this.filtroForm.patchValue({proveedorId:""}),this.provOpts=[],i&&(i.value="",i.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout(()=>i.focus(),0))}onProveedorChange(i){this.provSel=this.proveedores.find(e=>e._id===i)??null}onProdInput(i){let e=(i||"").trim(),o=/^\d[\d\s-]{5,}$/.test(e);if(!e||!o&&e.length<2){this.prodOpts=[];return}this.svc.searchProductos(e).subscribe(p=>{this.prodOpts=Array.isArray(p)?p:[]})}selectProd(i){this.prodSel=i,this.prodOpts=[],this.filtroForm.patchValue({productoId:i._id,categoria:i?.categoria||this.filtroForm.value.categoria})}clearProd(i){this.prodSel=null,this.filtroForm.patchValue({productoId:""}),this.prodOpts=[],i&&(i.value="",i.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout(()=>i.focus(),0))}exportarCsv(){if(!this.rowsAgrupado?.length)return;let i=Object.keys(this.rowsAgrupado[0]),e=this.rowsAgrupado.map(v=>i.map(N=>`"${String(v[N]??"").replace(/"/g,'""')}"`).join(",")),o=[i.join(","),...e].join(`
`),p=URL.createObjectURL(new Blob([o],{type:"text/csv;charset=utf-8;"})),m=document.createElement("a");m.href=p,m.download="compras_agrupado.csv",m.click(),URL.revokeObjectURL(p)}handleError(i,e){console.error("[Compras][ERROR]",i),this.cargando=!1;let o=i?.error?.mensaje||i?.message||e;ye.default.fire("Error",o,"error")}static \u0275fac=function(e){return new(e||r)(G(Ce))};static \u0275cmp=K({type:r,selectors:[["app-compras-page"]],viewQuery:function(e,o){if(e&1&&(D(Fe,5),D(Oe,5)),e&2){let p;V(p=R())&&(o.provInput=p.first),V(p=R())&&(o.prodInput=p.first)}},decls:43,vars:12,consts:[["prodInput",""],[1,"titulo",2,"text-align","center"],[1,"filtros",3,"ngSubmit","formGroup"],[1,"row","g-2","align-items-end","mb-3"],[1,"col-md-3"],[1,"form-label","d-block"],[1,"d-flex","gap-2","flex-wrap"],[1,"report-chip"],["type","radio","formControlName","vista","value","resumen"],["type","radio","formControlName","vista","value","agrupado"],[1,"col-md-2"],[1,"form-label"],["type","date","formControlName","fechaIni",1,"form-control",3,"disabled"],["type","date","formControlName","fechaFin",1,"form-control",3,"disabled"],["formControlName","proveedorId",1,"form-select",3,"change","disabled"],["value",""],[3,"value",4,"ngFor","ngForOf"],["type","text","formControlName","categoria","placeholder","Opcional",1,"form-control",3,"disabled"],[4,"ngIf"],[1,"row","g-2","mb-3"],[1,"col-md-12",2,"text-align","end"],["type","button","matTooltip","Limpiar filtros",1,"btn-rojo",3,"click","disabled"],[1,"fas","fa-times"],["type","submit",1,"btn-gris",2,"margin-left","5rem",3,"disabled"],[3,"value"],[1,"col-md-3","position-relative"],["type","text","placeholder","Nombre del producto",1,"form-control",3,"input","disabled"],["class","suggest-panel",4,"ngIf"],["class","mt-1 d-flex align-items-center gap-2 flex-wrap",4,"ngIf"],[1,"ms-auto","d-flex","gap-2"],["formControlName","orden",1,"form-select","form-select-sm","w-auto"],["formControlName","dir",1,"form-select","form-select-sm","w-auto"],["type","number","formControlName","topN","min","1","max","100",1,"form-control","form-control-sm","w-auto"],[1,"suggest-panel"],["type","button","class","suggest-item",3,"click",4,"ngFor","ngForOf"],["type","button",1,"suggest-item",3,"click"],[1,"fw-semibold"],[1,"text-muted"],[1,"mt-1","d-flex","align-items-center","gap-2","flex-wrap"],[1,"badge","bg-success-subtle","text-success","border","mb-0"],["type","button",1,"btn","btn-link","btn-sm","p-0",3,"click"],["formControlName","agrupacion",1,"form-select","form-select-sm","w-auto"],["formControlName","ordenAgr",1,"form-select","form-select-sm","w-auto"],["formControlName","dirAgr",1,"form-select","form-select-sm","w-auto"],["type","number","formControlName","topNAgr","min","1","max","100",1,"form-control","form-control-sm","w-auto"],[1,"row","row-cols-2","row-cols-sm-3","row-cols-lg-5","g-2"],[4,"ngFor","ngForOf"],[1,"col-12","mt-3"],[1,"card","p-1",2,"background-color","#edf69a","border-color","#0d6efd"],[1,"fw-semibold","mb-2","subtitulo","text-center"],[1,"row","g-2"],[1,"col-12","col-sm-6","col-lg-3"],[1,"row","justify-content-center","gy-4","mt-1"],[1,"col-12","col-xl-8","mx-auto","top-wrap"],[1,"subtitulo","text-centersubtitulo","text-center"],[1,"table-responsive"],[1,"tabla","w-100"],[1,"subtitulo","text-center"],[1,"col"],[1,"kpi-card","h-100"],[1,"kpi-title"],[1,"kpi-value"],[1,"text-end"],["colspan","6",1,"text-center","text-muted"],["colspan","5",1,"text-center","text-muted"],[1,"d-flex","justify-content-end","mb-2"],[1,"btn-amarillo",3,"click","disabled"],[1,"tabla"],[3,"t-num",4,"ngFor","ngForOf"],["colspan","20",1,"text-center","text-muted"]],template:function(e,o){e&1&&(n(0,"h3",1),a(1,"Reporte de Compras Resumen"),t(),n(2,"form",2),x("ngSubmit",function(){return o.buscar()}),n(3,"div",3)(4,"div",4)(5,"label",5),a(6,"Vista del reporte"),t(),n(7,"div",6)(8,"label",7),C(9,"input",8),a(10,"Resumen "),t(),n(11,"label",7),C(12,"input",9),a(13,"Agrupado "),t()()(),n(14,"div",10)(15,"label",11),a(16,"Desde"),t(),C(17,"input",12),t(),n(18,"div",10)(19,"label",11),a(20,"Hasta"),t(),C(21,"input",13),t(),n(22,"div",4)(23,"label",11),a(24,"Proveedor"),t(),n(25,"select",14),x("change",function(m){return o.onProveedorChange(m.target.value)}),n(26,"option",15),a(27,"Todos"),t(),c(28,je,3,3,"option",16),t()(),n(29,"div",10)(30,"label",11),a(31,"Categor\xEDa"),t(),C(32,"input",17),t()(),c(33,Xe,24,5,"div",18)(34,nt,29,6,"div",18),n(35,"div",19)(36,"div",20)(37,"button",21),x("click",function(){return o.limpiar()}),C(38,"i",22),t(),n(39,"button",23),a(40,"Buscar"),t()()()(),c(41,ut,112,44,"ng-container",18)(42,xt,12,4,"ng-container",18)),e&2&&(l(2),d("formGroup",o.filtroForm),l(15),d("disabled",o.cargando),l(4),d("disabled",o.cargando),l(4),d("disabled",o.cargando),l(3),d("ngForOf",o.proveedores),l(4),d("disabled",o.cargando),l(),d("ngIf",o.filtroForm.value.vista==="resumen"),l(),d("ngIf",o.filtroForm.value.vista==="agrupado"),l(3),d("disabled",o.cargando),l(2),d("disabled",o.cargando),l(2),d("ngIf",o.filtroForm.value.vista==="resumen"&&o.resumen),l(),d("ngIf",o.filtroForm.value.vista==="agrupado"))},dependencies:[ee,Y,Z,J,W,fe,ae,ce,ue,ne,le,me,pe,re,oe,ve,ge,de,se,be,xe],styles:[".filtros[_ngcontent-%COMP%]{border-bottom:2px solid #0453b3;margin-bottom:1rem}.form-label[_ngcontent-%COMP%]{margin-bottom:0}.top-wrap[_ngcontent-%COMP%]{max-width:1100px}.t-num[_ngcontent-%COMP%]{text-align:right;white-space:nowrap;font-variant-numeric:tabular-nums}.report-chip[_ngcontent-%COMP%]{border:1px solid #d0d7de;border-radius:9999px;padding:.375rem .75rem;cursor:pointer;-webkit-user-select:none;user-select:none;display:inline-flex;align-items:center;gap:.5rem;transition:all .15s ease-in-out}.report-chip[_ngcontent-%COMP%]:hover{background:#a5d1fa}.report-chip.active[_ngcontent-%COMP%]{border-color:#0d6efd;background:#e7f1ff;color:#0d6efd;font-weight:600;box-shadow:0 0 0 2px #0d6efd26 inset}.suggest-panel[_ngcontent-%COMP%]{position:absolute;z-index:1050;inset-inline:0;top:100%;background:#fff;border:1px solid #d0d7de;border-top:none;max-height:240px;overflow:auto;box-shadow:0 6px 12px #00000014}.suggest-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;width:100%;text-align:left;padding:.5rem .75rem;background:#fff;border:0}.suggest-item[_ngcontent-%COMP%]:hover{background:#f5faff}.report-chip[_ngcontent-%COMP%]{border:1px solid #d0d7de;border-radius:9999px;padding:.25rem .6rem;cursor:pointer;-webkit-user-select:none;user-select:none;display:inline-flex;align-items:center;gap:.5rem;transition:all .15s ease-in-out}.report-chip[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{margin:0}.report-chip[_ngcontent-%COMP%]:hover{background:#eaf4ff}.report-chip[_ngcontent-%COMP%]:has(input:checked){border-color:#0d6efd;background:#e7f1ff;color:#0d6efd;font-weight:600;box-shadow:0 0 0 2px #0d6efd26 inset}.kpi-card[_ngcontent-%COMP%]{border:1.5px solid #256dfc;border-radius:.75rem;padding:.75rem .9rem;background:#edf69a;align-items:center;text-align:center}.kpi-title[_ngcontent-%COMP%]{font-size:.8rem;color:#256dfc}.kpi-value[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:700}"]})};export{he as ComprasPageComponent};
