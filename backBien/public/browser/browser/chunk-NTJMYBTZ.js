import{a as Y}from"./chunk-MU2BUS7P.js";import{a as fe}from"./chunk-JKGFMHHD.js";import{C as oe,N as me,a as Z,b as ee,c as ae,l as te,p as ie,x as re,y as ne}from"./chunk-NLTCMIC6.js";import"./chunk-OIT4XKAV.js";import{A as M,Bb as i,Cb as t,Ce as le,Db as c,De as ce,H as D,Hb as x,Hd as Q,Id as W,Jb as f,Jc as P,Jd as X,Kb as F,Kc as z,Q as L,Sc as j,Vc as O,Wb as m,Xb as E,Ya as o,Yb as h,bb as w,ha as g,hb as q,hd as U,ia as _,id as u,kc as B,kd as $,l as V,lb as b,ld as R,mc as G,q as N,qd as K,rb as A,sb as l,ud as H,xd as J}from"./chunk-WMSMSS64.js";import{a as S,b as I,e as ue}from"./chunk-EQDQRRRY.js";var d=ue(fe());function pe(s,r){if(s&1&&(i(0,"small",31),m(1),B(2,"date"),t()),s&2){let e=F().$implicit;o(),h(" ",G(2,1,e.firmaUpdatedAt,"dd-MM-yyyy")," ")}}function Fe(s,r){if(s&1){let e=x();i(0,"tr")(1,"td"),m(2),t(),i(3,"td"),m(4),t(),i(5,"td"),m(6),t(),i(7,"td"),m(8),t(),i(9,"td"),m(10),t(),i(11,"td")(12,"span",26),m(13,"Secreta"),t(),b(14,pe,3,4,"small",27),t(),i(15,"td")(16,"button",28),f("click",function(){let n=g(e).$implicit,v=F();return _(v.editar(n))}),c(17,"fa-icon",3),t(),i(18,"button",29),f("click",function(){let n=g(e).$implicit,v=F();return _(v.eliminar(n._id))}),c(19,"fa-icon",3),t(),i(20,"button",30),f("click",function(){let n=g(e).$implicit,v=F();return _(v.abrirCambiarFirma(n))}),c(21,"fa-icon",3),t()()()}if(s&2){let e=r.$implicit,a=F();o(2),E(e.titulo1),o(2),E(e.titulo2),o(2),E(e.nombre),o(2),E(e.direccion),o(2),E(e.telefono),o(4),l("ngIf",e.firmaUpdatedAt),o(3),l("icon","pen"),o(),l("disabled",a.cargando||e._bloquearEliminar)("matTooltip",e._bloquearEliminar?"No puedes eliminar: hay turnos de caja abiertos":"Eliminar"),o(),l("icon","trash"),o(2),l("icon","key")}}function ve(s,r){if(s&1){let e=x();i(0,"div",19)(1,"label"),m(2,"Firma actual (requerida para cambiarla):"),t(),i(3,"div",20),c(4,"input",41),i(5,"button",40),f("click",function(){g(e);let n=F(2);return _(n.showFirma=!n.showFirma)}),c(6,"fa-icon",3),t()()()}if(s&2){let e=F(2);o(4),l("type",e.showFirma?"text":"password"),o(),l("matTooltip",e.showFirma?"Ocultar":"Mostrar"),A("aria-pressed",e.showFirma),o(),l("icon",e.showFirma?"eye-slash":"eye")}}function be(s,r){s&1&&(i(0,"div",42),m(1," La nueva firma debe tener al menos 6 caracteres. "),t())}function he(s,r){s&1&&(i(0,"div",42),m(1," La nueva firma no puede ser igual a la actual. "),t())}function ge(s,r){if(s&1){let e=x();i(0,"form",32)(1,"div",19)(2,"label"),m(3,"Titulo1:"),t(),c(4,"input",33),t(),i(5,"div",19)(6,"label"),m(7,"Titulo2:"),t(),c(8,"input",34),t(),i(9,"div",19)(10,"label"),m(11,"Sucursal:"),t(),c(12,"input",35),t(),i(13,"div",19)(14,"label"),m(15,"Direcci\xF3n:"),t(),c(16,"input",36),t(),i(17,"div",19)(18,"label"),m(19,"Tel\xE9fono:"),t(),c(20,"input",37),t(),b(21,ve,7,4,"div",38),i(22,"div",19)(23,"label"),m(24),t(),i(25,"div",20),c(26,"input",39),i(27,"button",40),f("click",function(){g(e);let n=F();return _(n.showFirmaConfirm=!n.showFirmaConfirm)}),c(28,"fa-icon",3),t()(),b(29,be,2,0,"div",25)(30,he,2,0,"div",25),t()()}if(s&2){let e,a,n=F();l("formGroup",n.formFarmacia),o(21),l("ngIf",n.modoEdicion),o(3),h("Nueva firma ",n.modoEdicion?"(m\xEDn. 6, distinta a la actual)":"(obligatoria, m\xEDn. 6)",""),o(2),l("type",n.showFirmaConfirm?"text":"password"),o(),l("matTooltip",n.showFirmaConfirm?"Ocultar":"Mostrar"),A("aria-pressed",n.showFirmaConfirm),o(),l("icon",n.showFirmaConfirm?"eye-slash":"eye"),o(),l("ngIf",((e=n.formFarmacia.get("nuevaFirma"))==null?null:e.hasError("minlength"))&&((e=n.formFarmacia.get("nuevaFirma"))==null?null:e.touched)),o(),l("ngIf",(n.formFarmacia.errors==null?null:n.formFarmacia.errors.nuevaIgualAActual)&&(((a=n.formFarmacia.get("nuevaFirma"))==null?null:a.touched)||((a=n.formFarmacia.get("firmaActual"))==null?null:a.touched)))}}function _e(s,r){s&1&&(i(0,"div",42),m(1," Las firmas no coinciden. "),t())}var se=class s{constructor(r,e,a){this.fb=r;this.farmaciaService=e;a.addIcons(ne,oe,me,re,te,ie),this.formFarmacia=this.fb.group({nombre:["",u.required],titulo1:[""],titulo2:[""],direccion:[""],telefono:[""],firma:["",u.required]})}farmacias=[];cargando=!1;formFarmacia;guardando=!1;modoEdicion=!1;farmaciaEditandoId=null;showFirma=!1;showFirmaConfirm=!1;formCambiarFirma;guardandoFirma=!1;showAdminPass=!1;showNueva=!1;showConfirm=!1;farmaciaTarget=null;ngOnInit(){this.cargarFarmacias(),this.formFarmacia=this.fb.group({nombre:["",[u.required,u.minLength(2)]],titulo1:[""],titulo2:[""],direccion:[""],telefono:[""],firmaActual:[""],nuevaFirma:[""]},{validators:[this.nuevaDistintaDeActualValidator]}),this.formCambiarFirma=this.fb.group({adminPassword:["",[u.required,u.minLength(4)]],nuevaFirma:["",[u.required,u.minLength(4)]],confirmFirma:["",[u.required]]},{validators:[this.firmasIgualesValidatorCambiar]})}nuevaDistintaDeActualValidator=r=>{let e=(r.get("firmaActual")?.value||"").trim(),a=(r.get("nuevaFirma")?.value||"").trim();return!e||!a?null:e===a?{nuevaIgualAActual:!0}:null};configurarValidadoresFirma(){let r=this.formFarmacia.get("firmaActual"),e=this.formFarmacia.get("nuevaFirma");this.modoEdicion?(e.value||"").trim()?(r.setValidators([u.required]),e.setValidators([u.minLength(6)])):(r.clearValidators(),e.clearValidators()):(r.clearValidators(),e.setValidators([u.required,u.minLength(6)])),r.updateValueAndValidity({emitEvent:!1}),e.updateValueAndValidity({emitEvent:!1})}onNuevaFirmaChange(){this.configurarValidadoresFirma()}editar(r){let e=document.getElementById("modalAgregarFarmacia");if(!e)return;this.modoEdicion=!0,this.farmaciaEditandoId=r._id||null,this.formFarmacia.reset({nombre:r.nombre,titulo1:r.titulo1,titulo2:r.titulo2,direccion:r.direccion,telefono:r.telefono,firmaActual:"",nuevaFirma:""}),this.configurarValidadoresFirma(),new bootstrap.Modal(e,{backdrop:"static",keyboard:!1}).show()}firmasIgualesValidatorCambiar=r=>{let e=(r.get("nuevaFirma")?.value||"").trim(),a=(r.get("confirmFirma")?.value||"").trim();return!e&&!a||e===a?null:{firmaNoCoincide:!0}};abrirCambiarFirma(r){this.farmaciaTarget=r,this.formCambiarFirma.reset();let e=document.getElementById("modalCambiarFirma");e&&new bootstrap.Modal(e,{backdrop:"static",keyboard:!1}).show()}confirmarCambioFirma(){if(this.formCambiarFirma.invalid||!this.farmaciaTarget?._id)return;this.guardandoFirma=!0;let{adminPassword:r,nuevaFirma:e}=this.formCambiarFirma.value;this.farmaciaService.cambiarFirma(this.farmaciaTarget._id,{adminPassword:r,nuevaFirma:(e||"").trim()}).subscribe({next:a=>{d.default.fire("Actualizada","La firma se cambi\xF3 correctamente","success").then(()=>{let n=document.getElementById("modalCambiarFirma");n&&bootstrap.Modal.getInstance(n)?.hide(),this.guardandoFirma=!1,this.cargarFarmacias()})},error:a=>{console.error(a),this.guardandoFirma=!1,d.default.fire("Error",a.error?.mensaje||"No se pudo cambiar la firma","error")}})}firmasIgualesValidator=r=>{let e=(r.get("firma")?.value||"").trim(),a=(r.get("firmaConfirm")?.value||"").trim();return!e&&!a?null:e!==a?{firmaNoCoincide:!0}:null};cargarFarmacias(){this.cargando=!0,this.farmaciaService.obtenerFarmacias().pipe(L(r=>this.farmaciaService.abiertosPorFarmacia().pipe(N(({mapa:e})=>r.map(a=>{let n=e[a._id]??0;return I(S({},a),{_abiertos:n,_bloquearEliminar:n>0})})),M(()=>V(r.map(e=>I(S({},e),{_abiertos:0,_bloquearEliminar:!1})))))),D(()=>this.cargando=!1)).subscribe({next:r=>this.farmacias=r,error:()=>d.default.fire("Error","No se pudieron cargar las farmacias","error")})}abrirModalAgregar(){let r=document.getElementById("modalAgregarFarmacia");if(!r)return;this.modoEdicion=!1,this.farmaciaEditandoId=null,this.formFarmacia.reset({nombre:"",tutulo1:"",titulo2:"",direccion:"",telefono:"",firma:"",firmaConfirm:""}),this.configurarValidadoresFirma(),new bootstrap.Modal(r,{backdrop:"static",keyboard:!1}).show()}guardar(){if(this.guardando)return;if(this.configurarValidadoresFirma(),this.formFarmacia.invalid){this.formFarmacia.markAllAsTouched(),d.default.fire("Datos incompletos","Revisa los campos del formulario.","warning");return}this.guardando=!0;let{nombre:r,titulo1:e,titulo2:a,direccion:n,telefono:v,firmaActual:de,nuevaFirma:T}=this.formFarmacia.value,C={nombre:(r||"").trim(),titulo1:(e||"").trim(),titulo2:(a||"").trim(),direccion:(n||"").trim(),telefono:(v||"").trim()},k=()=>{let p=document.getElementById("modalAgregarFarmacia");p&&bootstrap.Modal.getInstance(p)?.hide(),this.formFarmacia.reset(),this.farmaciaEditandoId=null,this.modoEdicion=!1,this.guardando=!1,this.cargarFarmacias()};if(this.modoEdicion&&this.farmaciaEditandoId){let p=(T||"").trim();if(p){if(p.length<6){this.formFarmacia.get("nuevaFirma")?.markAsTouched(),this.guardando=!1,d.default.fire("Firma inv\xE1lida","La nueva firma debe tener al menos 6 caracteres.","warning");return}if(this.formFarmacia.errors?.nuevaIgualAActual){this.formFarmacia.get("nuevaFirma")?.markAsTouched(),this.formFarmacia.get("firmaActual")?.markAsTouched(),this.guardando=!1,d.default.fire("Firma inv\xE1lida","La nueva firma no puede ser igual a la actual.","warning");return}C.firmaActual=(de||"").trim(),C.nuevaFirma=p}this.farmaciaService.actualizarFarmacia(this.farmaciaEditandoId,C).subscribe({next:()=>d.default.fire({icon:"success",title:"Actualizaci\xF3n",text:"Farmacia actualizada correctamente.",timer:1500,showConfirmButton:!1}).then(k),error:y=>{console.error(y),this.guardando=!1,d.default.fire("Error",y?.error?.mensaje||"No se pudo actualizar","error")}})}else{let p=(T||"").trim();if(!p||p.length<6){this.formFarmacia.get("nuevaFirma")?.markAsTouched(),this.guardando=!1,d.default.fire("Firma requerida","La firma debe tener al menos 6 caracteres.","warning");return}C.firma=p,this.farmaciaService.crearFarmacia(C).subscribe({next:()=>d.default.fire({icon:"success",title:"Creaci\xF3n",text:"Farmacia creada correctamente.",timer:1500,showConfirmButton:!1}).then(k),error:y=>{console.error(y),this.guardando=!1,d.default.fire("Error",y?.error?.mensaje||"No se pudo crear","error")}})}}eliminar(r){d.default.fire({title:"\xBFEst\xE1s seguro?",text:"La farmacia ser\xE1 desactivada",icon:"warning",showCancelButton:!0,confirmButtonText:"S\xED, eliminar",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&this.farmaciaService.eliminarFarmacia(r).subscribe({next:()=>{d.default.fire("Desactivada","La farmacia fue desactivada","success"),this.cargarFarmacias()},error:()=>d.default.fire("Error","No se pudo eliminar la farmacia","error")})})}static \u0275fac=function(e){return new(e||s)(w(Q),w(Y),w(Z))};static \u0275cmp=q({type:s,selectors:[["app-farmacias"]],decls:74,vars:17,consts:[[1,"container"],[1,"titulo",2,"text-align","center"],[1,"btn-verde","mb-3",3,"click"],[3,"icon"],[1,"tabla"],[4,"ngFor","ngForOf"],["id","modalAgregarFarmacia","tabindex","-1","aria-hidden","true",1,"modal","fade"],[1,"modal-dialog","modal-dialog-centered"],[1,"modal-content","p-3",2,"background-color","azure"],[1,"modal-header"],[1,"modal-title","titulo"],["type","button","data-bs-dismiss","modal","aria-label","Cerrar",1,"btn-close"],[1,"modal-body"],[3,"formGroup",4,"ngIf"],[1,"modal-footer","d-flex","justify-content-between"],["data-bs-dismiss","modal",1,"btn-rojo"],[1,"btn-gris",3,"click","disabled"],["id","modalCambiarFirma","tabindex","-1","aria-hidden","true",1,"modal","fade"],[1,"modal-body",3,"formGroup"],[1,"mb-2"],[1,"input-group"],["formControlName","adminPassword","autocomplete","current-password",1,"form-control",3,"type"],["type","button",1,"btn-gris",3,"click"],["formControlName","nuevaFirma","autocomplete","new-password",1,"form-control",3,"type"],["formControlName","confirmFirma","autocomplete","new-password",1,"form-control",3,"type"],["class","text-danger mt-1",4,"ngIf"],[1,"badge","bg-secondary"],["class","text-muted d-block",4,"ngIf"],["matTooltip","Editar",1,"btn-icon-chico","btn-gris-chico",3,"click"],[1,"btn-icon-chico","btn-rojo-chico",3,"click","disabled","matTooltip"],["matTooltip","Cambiar firma",1,"btn-icon-chico","btn-verde-chico",3,"click"],[1,"text-muted","d-block"],[3,"formGroup"],["type","text","formControlName","titulo1",1,"form-control"],["type","text","formControlName","titulo2",1,"form-control"],["type","text","formControlName","nombre",1,"form-control"],["type","text","formControlName","direccion",1,"form-control"],["type","text","formControlName","telefono",1,"form-control"],["class","mb-2",4,"ngIf"],["formControlName","nuevaFirma","autocomplete","new-password","spellcheck","false","autocapitalize","off",1,"form-control",3,"type"],["type","button",1,"btn-gris",3,"click","matTooltip"],["formControlName","firmaActual","autocomplete","current-password","spellcheck","false","autocapitalize","off",1,"form-control",3,"type"],[1,"text-danger","mt-1"]],template:function(e,a){if(e&1&&(i(0,"div",0)(1,"h2",1),m(2,"Mantenimiento de Farmacias"),t(),i(3,"button",2),f("click",function(){return a.abrirModalAgregar()}),c(4,"fa-icon",3),m(5," Agregar Farmacia "),t(),i(6,"table",4)(7,"thead")(8,"tr")(9,"th"),m(10,"T\xEDtulo 1"),t(),i(11,"th"),m(12,"T\xEDtulo 2"),t(),i(13,"th"),m(14,"Sucursal"),t(),i(15,"th"),m(16,"Direcci\xF3n"),t(),i(17,"th"),m(18,"Tel\xE9fono"),t(),i(19,"th"),m(20,"Firma"),t(),i(21,"th"),m(22,"Acciones"),t()()(),i(23,"tbody"),b(24,Fe,22,11,"tr",5),t()(),i(25,"div",6)(26,"div",7)(27,"div",8)(28,"div",9)(29,"h5",10),m(30),t(),c(31,"button",11),t(),i(32,"div",12),b(33,ge,31,9,"form",13),t(),i(34,"div",14)(35,"button",15),m(36,"Cancelar"),t(),i(37,"button",16),f("click",function(){return a.guardar()}),m(38),t()()()()(),i(39,"div",17)(40,"div",7)(41,"div",8)(42,"div",9)(43,"h5",10),m(44),t(),c(45,"button",11),t(),i(46,"div",18)(47,"div",19)(48,"label"),m(49,"Tu contrase\xF1a (admin):"),t(),i(50,"div",20),c(51,"input",21),i(52,"button",22),f("click",function(){return a.showAdminPass=!a.showAdminPass}),c(53,"fa-icon",3),t()()(),i(54,"div",19)(55,"label"),m(56,"Nueva firma:"),t(),i(57,"div",20),c(58,"input",23),i(59,"button",22),f("click",function(){return a.showNueva=!a.showNueva}),c(60,"fa-icon",3),t()()(),i(61,"div",19)(62,"label"),m(63,"Confirmar nueva firma:"),t(),i(64,"div",20),c(65,"input",24),i(66,"button",22),f("click",function(){return a.showConfirm=!a.showConfirm}),c(67,"fa-icon",3),t()(),b(68,_e,2,0,"div",25),t()(),i(69,"div",14)(70,"button",15),m(71,"Cancelar"),t(),i(72,"button",16),f("click",function(){return a.confirmarCambioFirma()}),m(73),t()()()()()()),e&2){let n;o(4),l("icon","plus"),o(20),l("ngForOf",a.farmacias),o(6),h(" ",a.modoEdicion?"Editar farmacia":"Agregar nueva farmacia"," "),o(3),l("ngIf",a.formFarmacia),o(4),l("disabled",a.formFarmacia.invalid||a.guardando),o(),h(" ",a.guardando?"Guardando...":a.modoEdicion?"Actualizar":"Guardar"," "),o(6),h("Cambiar firma de ",a.farmaciaTarget==null?null:a.farmaciaTarget.nombre,""),o(2),l("formGroup",a.formCambiarFirma),o(5),l("type",a.showAdminPass?"text":"password"),o(2),l("icon",a.showAdminPass?"eye-slash":"eye"),o(5),l("type",a.showNueva?"text":"password"),o(2),l("icon",a.showNueva?"eye-slash":"eye"),o(5),l("type",a.showConfirm?"text":"password"),o(2),l("icon",a.showConfirm?"eye-slash":"eye"),o(),l("ngIf",(a.formCambiarFirma.errors==null?null:a.formCambiarFirma.errors.firmaNoCoincide)&&(((n=a.formCambiarFirma.get("confirmFirma"))==null?null:n.touched)||((n=a.formCambiarFirma.get("nuevaFirma"))==null?null:n.touched))),o(4),l("disabled",a.formCambiarFirma.invalid||a.guardandoFirma),o(),h(" ",a.guardandoFirma?"Guardando...":"Actualizar firma"," ")}},dependencies:[O,P,z,j,ae,ee,X,K,U,$,R,H,J,W,ce,le],encapsulation:2})};export{se as FarmaciasComponent};
