import{b as ve}from"./chunk-YNUVHICX.js";import{T as Oe,U as Le}from"./chunk-BH6ZDK2X.js";import{a as Be}from"./chunk-JKGFMHHD.js";import"./chunk-AT4VBJFV.js";import{$ as ae,Cd as Se,Db as r,Dd as Ee,Eb as n,Ed as Ie,Fb as v,Fd as we,Gb as W,Gd as Pe,Hb as Y,Hd as De,Jb as h,Lb as b,Mb as d,Md as Te,Nc as L,Nd as ke,Oc as $,Od as Fe,Rb as J,Sb as X,Tb as Z,W as re,Wb as k,Wc as de,Xb as l,Xc as me,Yb as c,Yc as z,Za as o,Zb as F,Zc as P,_b as se,cb as B,ed as ue,fd as V,gd as ge,ia as f,ja as _,jb as I,jd as H,k as R,lc as w,mc as O,md as fe,nb as u,nc as pe,nd as j,oc as ce,p as E,pd as _e,qd as be,sa as le,ub as p,vd as he,wb as y,wd as xe,xd as Ce,z as N,zd as ye}from"./chunk-ZBSVT2Z7.js";import{a as M,b as A,e as Re}from"./chunk-EQDQRRRY.js";var Ne=Re(Be());var q=class a{kpis;static \u0275fac=function(e){return new(e||a)};static \u0275cmp=I({type:a,selectors:[["app-devoluciones-kpis"]],inputs:{kpis:"kpis"},decls:23,vars:9,consts:[[1,"row","g-2","mb-2",2,"text-align","center","color","darkred"],[1,"col-md-3","col-6"],[1,"kpi"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1)(2,"div",2),l(3,"Importe devuelto: "),r(4,"strong"),l(5),w(6,"currency"),n()()(),r(7,"div",1)(8,"div",2),l(9,"Piezas devueltas: "),r(10,"strong"),l(11),n()()(),r(12,"div",1)(13,"div",2),l(14,"# Devoluciones: "),r(15,"strong"),l(16),n()()(),r(17,"div",1)(18,"div",2),l(19,"D\xEDas promedio: "),r(20,"strong"),l(21),w(22,"number"),n()()()()),e&2&&(o(5),c(O(6,4,i.kpis==null?null:i.kpis.totalImporte)),o(6),c(i.kpis==null?null:i.kpis.totalPiezas),o(5),c(i.kpis==null?null:i.kpis.numDevoluciones),o(5),c(pe(22,6,i.kpis==null?null:i.kpis.avgDias,"1.0-2")))},dependencies:[P,me,z],encapsulation:2})};function $e(a,t){if(a&1&&(r(0,"th"),l(1),n()),a&2){let e=t.$implicit;o(),c(e)}}function ze(a,t){if(a&1&&(r(0,"td"),l(1),n()),a&2){let e=t.$implicit,i=d().$implicit;o(),c(i[e])}}function He(a,t){if(a&1&&(r(0,"tr"),u(1,ze,2,1,"td",3),n()),a&2){let e=d();o(),p("ngForOf",e.cols)}}var U=class a{title="";rows=[];get cols(){if(!this.rows?.length)return[];let t=this.rows[0];return"productoId"in t?["nombre","codigoBarras","piezas","importe","devoluciones"]:"motivo"in t?["motivo","piezas","importe","devoluciones"]:"clienteId"in t?["nombre","telefono","piezas","importe","devoluciones"]:"usuarioId"in t?["nombre","piezas","importe","devoluciones"]:"farmaciaId"in t?["nombre","piezas","importe","devoluciones"]:Object.keys(t)}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=I({type:a,selectors:[["app-devoluciones-top-tabla"]],inputs:{title:"title",rows:"rows"},decls:9,vars:3,consts:[[1,"titulo-tabla",2,"text-align","center"],[1,"table-responsive"],[1,"tabla",2,"margin-bottom","1.5rem","margin-top","0"],[4,"ngFor","ngForOf"]],template:function(e,i){e&1&&(r(0,"h6",0),l(1),n(),r(2,"div",1)(3,"table",2)(4,"thead")(5,"tr"),u(6,$e,2,1,"th",3),n()(),r(7,"tbody"),u(8,He,2,1,"tr",3),n()()()),e&2&&(o(),c(i.title),o(5),p("ngForOf",i.cols),o(2),p("ngForOf",i.rows))},dependencies:[P,L],encapsulation:2})};function je(a,t){if(a&1&&(r(0,"tr")(1,"td"),l(2),w(3,"date"),n(),r(4,"td"),l(5),n(),r(6,"td"),l(7),n(),r(8,"td"),l(9),n(),r(10,"td"),l(11),n(),r(12,"td"),l(13),n(),r(14,"td",2),l(15),n(),r(16,"td",2),l(17),w(18,"currency"),n(),r(19,"td",2),l(20),w(21,"currency"),n(),r(22,"td"),l(23),n()()),a&2){let e=t.$implicit;o(2),c(ce(3,10,e.fecha,"dd/MM/yyyy HH:mm","America/Mexico_City")),o(3),c(e.farmacia),o(2),c(e.cliente),o(2),c(e.usuario),o(2),c(e.producto),o(2),c(e.codigoBarras),o(2),c(e.cantidad),o(2),c(O(18,14,e.precioUnit)),o(3),c(O(21,16,e.importe)),o(3),c(e.motivo)}}function qe(a,t){if(a&1&&(r(0,"tfoot")(1,"tr")(2,"th",6),l(3,"Totales"),n(),r(4,"th",2),l(5),n(),v(6,"th"),r(7,"th",2),l(8),w(9,"currency"),n(),v(10,"th"),n()()),a&2){let e=t.ngIf;o(5),c(e.totalPiezas),o(3),c(O(9,2,e.totalImporte))}}function Ke(a,t){if(a&1){let e=h();r(0,"nav",7)(1,"ul",8)(2,"li")(3,"button",9),b("click",function(){f(e);let s=d();return _(s.change(1))}),v(4,"i",10),n()(),r(5,"li")(6,"button",11),b("click",function(){f(e);let s=d();return _(s.change(s.page-1))}),v(7,"i",12),n()(),r(8,"li")(9,"span"),l(10),n()(),r(11,"li")(12,"button",13),b("click",function(){f(e);let s=d();return _(s.change(s.page+1))}),v(13,"i",14),n()(),r(14,"li")(15,"button",15),b("click",function(){f(e);let s=d();return _(s.change(s.pages))}),v(16,"i",16),n()()()()}if(a&2){let e=d();o(2),y("disabled",e.page<=1),o(),p("disabled",e.page<=1),o(2),y("disabled",e.page<=1),o(),p("disabled",e.page<=1),o(4),se("P\xE1gina ",e.page," de ",e.pages,""),o(),y("disabled",e.page>=e.pages),o(),p("disabled",e.page>=e.pages),o(2),y("disabled",e.page>=e.pages),o(),p("disabled",e.page>=e.pages)}}var G=class a{data=null;pageChange=new le;get rows(){return this.data?.rows??[]}get footer(){return this.data?.footer??null}get page(){return this.data?.page??1}get pages(){return this.data?.pages??1}change(t){this.data&&(t<1||t>this.pages||this.pageChange.emit(t))}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=I({type:a,selectors:[["app-devoluciones-listado"]],inputs:{data:"data"},outputs:{pageChange:"pageChange"},decls:28,vars:3,consts:[[1,"table-responsive"],[1,"tabla"],[1,"text-end"],[4,"ngFor","ngForOf"],[4,"ngIf"],["class","mt-3","aria-label","Navegaci\xF3n de p\xE1ginas",4,"ngIf"],["colspan","6",1,"text-end"],["aria-label","Navegaci\xF3n de p\xE1ginas",1,"mt-3"],[1,"pagination","pagination-sm","justify-content-center","paginacion","mb-0"],["type","button","aria-label","Inicio",1,"page-link",3,"click","disabled"],[1,"fa","fa-angle-double-left"],["type","button","aria-label","Anterior",1,"page-link",3,"click","disabled"],[1,"fa","fa-angle-left"],["type","button","aria-label","Siguiente",1,"page-link",3,"click","disabled"],[1,"fa","fa-angle-right"],["type","button","aria-label","Fin",1,"page-link",3,"click","disabled"],[1,"fa","fa-angle-double-right"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"table",1)(2,"thead")(3,"tr")(4,"th"),l(5,"Fecha"),n(),r(6,"th"),l(7,"Farmacia"),n(),r(8,"th"),l(9,"Cliente"),n(),r(10,"th"),l(11,"Usuario"),n(),r(12,"th"),l(13,"Producto"),n(),r(14,"th"),l(15,"C\xF3d. Barras"),n(),r(16,"th",2),l(17,"Cantidad"),n(),r(18,"th",2),l(19,"Precio"),n(),r(20,"th",2),l(21,"Importe"),n(),r(22,"th"),l(23,"Motivo"),n()()(),r(24,"tbody"),u(25,je,24,18,"tr",3),n(),u(26,qe,11,4,"tfoot",4),n()(),u(27,Ke,17,14,"nav",5)),e&2&&(o(25),p("ngForOf",i.rows),o(),p("ngIf",i.footer),o(),p("ngIf",i.pages>1))},dependencies:[P,L,$,z,de],styles:[".paginacion[_ngcontent-%COMP%]{text-align:center;font-size:large;font-weight:500;color:#8a2be2}.paginacion[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{color:#0ff;background-color:#8a2be2}.paginacion[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:disabled, .paginacion[_ngcontent-%COMP%]   button[disabled][_ngcontent-%COMP%]{cursor:not-allowed;opacity:.6;color:gray}"]})};var Q=class a{constructor(t){this.http=t}base=`${H.apiUrl}/reportes`;headers(){return new ue({"x-auth-token":localStorage.getItem("auth_token")||""})}params(t){let e=new V;return Object.entries(t||{}).forEach(([i,s])=>{s!=null&&String(s).trim()!==""&&(e=e.set(i,String(s)))}),e}getResumen(t){return this.http.get(`${this.base}/devoluciones-resumen`,{params:this.params(t),headers:this.headers()})}getAgrupado(t,e){return this.http.get(`${this.base}/devoluciones-${t}`,{params:this.params(e),headers:this.headers()})}getListado(t){return this.http.get(`${this.base}/devoluciones-listado`,{params:this.params(t),headers:this.headers()})}uniqById(t){let e=new Set,i=[];for(let s of t||[]){let m=String(s?._id??"");e.has(m)||(e.add(m),i.push(s))}return i}toProdLite=t=>({_id:String(t?._id??t?.id??""),nombre:String(t?.nombre??""),codigoBarras:t?.codigoBarras?String(t.codigoBarras):void 0});toClienteLite=t=>({_id:String(t?._id??t?.id??""),nombre:String(t?.nombre??""),telefono:t?.telefono?String(t.telefono):void 0});filtrarProductos(t,e,i){let s=e.trim(),m=s.toLowerCase(),g=(t||[]).filter(S=>{let D=(S.nombre||"").toLowerCase(),T=String(S.codigoBarras||"");return i?T.startsWith(s)||T.includes(s):D.includes(m)||T.includes(s)});g.sort((S,D)=>{let T=(S.nombre||"").toLowerCase(),ie=(D.nombre||"").toLowerCase(),Me=String(S.codigoBarras||""),Ae=String(D.codigoBarras||""),ne=i?Me.startsWith(s)?0:1:T.startsWith(m)?0:1,oe=i?Ae.startsWith(s)?0:1:ie.startsWith(m)?0:1;return ne!==oe?ne-oe:T.localeCompare(ie,"es")});let C=new Set,x=[];for(let S of g){let D=S._id;if(!C.has(D)&&(C.add(D),x.push(S),x.length>=10))break}return x}searchProductos(t,e=!1){let i=`${H.apiUrl}/productos`,s=this.headers(),m=new V().set(e?"cb":"q",t).set("limit","50");return this.http.get(`${i}/buscar`,{headers:s,params:m}).pipe(E(g=>(g?.data??g?.rows??g??[]).map(this.toProdLite)),E(g=>this.filtrarProductos(g,t,e)),N(g=>{if(e){let C=new V().set("codigoBarras",t);return this.http.get(`${i}/por-codigo`,{headers:s,params:C}).pipe(E(x=>x?[this.toProdLite(x)]:[]),N(()=>R([])))}else{let C=new V().set("search",t).set("limit","50");return this.http.get(i,{headers:s,params:C}).pipe(E(x=>(x?.data??x?.rows??x??[]).map(this.toProdLite)),E(x=>this.filtrarProductos(x,t,e)),N(()=>R([])))}}))}searchClientes(t){let e=`${H.apiUrl}/clientes/buscar`,i=new V().set("q",t).set("limit","50");return this.http.get(e,{headers:this.headers(),params:i}).pipe(E(s=>(s?.data??s?.rows??s??[]).map(this.toClienteLite)),E(s=>{let m=t.toLowerCase();return s.filter(g=>g.nombre.toLowerCase().includes(m)||String(g.telefono||"").includes(t)).slice(0,10)}),N(()=>R([])))}static \u0275fac=function(e){return new(e||a)(ae(ge))};static \u0275prov=re({token:a,factory:a.\u0275fac,providedIn:"root"})};var Ge=["cliInput"],Qe=["proInput"];function We(a,t){if(a&1&&(r(0,"option",34),l(1),n()),a&2){let e=t.$implicit;p("value",e._id),o(),c(e.nombre)}}function Ye(a,t){if(a&1&&(r(0,"option",34),l(1),n()),a&2){let e=t.$implicit;p("value",e._id),o(),c(e.nombre)}}function Je(a,t){if(a&1&&(r(0,"option",34),l(1),n()),a&2){let e=t.$implicit;p("value",e),o(),c(e)}}function Xe(a,t){if(a&1){let e=h();r(0,"button",37),b("click",function(){let s=f(e).$implicit,m=d(2);return _(m.selectCliente(s))}),r(1,"div",38),l(2),n(),r(3,"small",39),l(4),n()()}if(a&2){let e=t.$implicit;o(2),c(e.nombre||"(sin nombre)"),o(2),c(e.telefono||"\u2014")}}function Ze(a,t){if(a&1&&(r(0,"div",35),u(1,Xe,5,2,"button",36),n()),a&2){let e=d();o(),p("ngForOf",e.clienteOpts)}}function et(a,t){if(a&1&&(r(0,"span"),l(1),n()),a&2){let e=d(2);o(),F("\xB7 ",e.clienteSel.telefono,"")}}function tt(a,t){if(a&1){let e=h();r(0,"div",40)(1,"span",41),l(2),u(3,et,2,1,"span",30),n(),r(4,"button",42),b("click",function(){f(e);let s=d(),m=k(51);return _(s.clearCliente(m))}),l(5,"Borrar"),n()()}if(a&2){let e=d();o(2),F(" ",e.clienteSel.nombre," "),o(),p("ngIf",e.clienteSel.telefono)}}function it(a,t){if(a&1){let e=h();r(0,"button",37),b("click",function(){let s=f(e).$implicit,m=d(2);return _(m.selectProducto(s))}),r(1,"div",38),l(2),n(),r(3,"small",39),l(4),n()()}if(a&2){let e=t.$implicit;o(2),c(e.nombre||"(sin nombre)"),o(2),F("CB: ",e.codigoBarras||"\u2014","")}}function nt(a,t){if(a&1&&(r(0,"div",35),u(1,it,5,2,"button",36),n()),a&2){let e=d();o(),p("ngForOf",e.productoOpts)}}function ot(a,t){if(a&1&&(r(0,"span"),l(1),n()),a&2){let e=d(2);o(),F("\xB7 ",e.productoSel.codigoBarras,"")}}function rt(a,t){if(a&1){let e=h();r(0,"div",40)(1,"span",43),l(2),u(3,ot,2,1,"span",30),n(),r(4,"button",42),b("click",function(){f(e);let s=d(),m=k(59);return _(s.clearProducto(m))}),l(5,"Borrar"),n()()}if(a&2){let e=d();o(2),F(" ",e.productoSel.nombre," "),o(),p("ngIf",e.productoSel.codigoBarras)}}function at(a,t){if(a&1){let e=h();r(0,"div",44)(1,"button",45),b("click",function(){f(e);let s=d();return _(s.limpiar())}),v(2,"i",46),n()()}if(a&2){let e=d();o(),p("disabled",e.cargando)}}function lt(a,t){if(a&1){let e=h();r(0,"div",47)(1,"button",48),b("click",function(){f(e);let s=d();return _(s.buscar())}),l(2),n()()}if(a&2){let e=d();o(),p("disabled",e.cargando),o(),c(e.cargando?"Consultando\u2026":"Buscar")}}function st(a,t){if(a&1&&(r(0,"option",34),l(1),n()),a&2){let e=t.$implicit;p("value",e),o(),c(e)}}function pt(a,t){if(a&1&&(r(0,"option",34),l(1),n()),a&2){let e=t.$implicit;p("value",e),o(),c(e)}}function ct(a,t){if(a&1&&(r(0,"option",34),l(1),n()),a&2){let e=t.$implicit;p("value",e),o(),c(e)}}function dt(a,t){if(a&1){let e=h();W(0),r(1,"div",4)(2,"div",12)(3,"label",13),l(4,"Agrupar por"),n(),r(5,"select",49),u(6,st,2,2,"option",16),n()(),r(7,"div",12)(8,"label",13),l(9,"Top N"),n(),v(10,"input",50),n(),r(11,"div",12)(12,"label",13),l(13,"Ordenar por:"),n(),r(14,"select",51),u(15,pt,2,2,"option",16),n()(),r(16,"div",12)(17,"label",13),l(18,"Descendente \xF3 Ascendente"),n(),r(19,"select",52),u(20,ct,2,2,"option",16),n()(),r(21,"div",53)(22,"button",45),b("click",function(){f(e);let s=d();return _(s.limpiar())}),v(23,"i",46),n()(),r(24,"div",47)(25,"button",48),b("click",function(){f(e);let s=d();return _(s.buscar())}),l(26),n()()(),Y()}if(a&2){let e=d();o(5),p("disabled",e.cargando),o(),p("ngForOf",e.agrupaciones),o(4),p("disabled",e.cargando),o(4),p("disabled",e.cargando),o(),p("ngForOf",e.ordenesTop),o(4),p("disabled",e.cargando),o(),p("ngForOf",e.dirs),o(2),p("disabled",e.cargando),o(3),p("disabled",e.cargando),o(),c(e.cargando?"Consultando\u2026":"Buscar")}}function mt(a,t){if(a&1&&(r(0,"option",34),l(1),n()),a&2){let e=t.$implicit;p("value",e),o(),c(e)}}function ut(a,t){if(a&1){let e=h();W(0),r(1,"div",4)(2,"div",12)(3,"label",13),l(4,"Ordenar por:"),n(),r(5,"select",54)(6,"option",55),l(7,"fecha"),n(),r(8,"option",56),l(9,"importe"),n(),r(10,"option",57),l(11,"cantidad"),n()()(),r(12,"div",12)(13,"label",13),l(14,"Descendente \xF3 Ascendente"),n(),r(15,"select",58),u(16,mt,2,2,"option",16),n()(),r(17,"div",12)(18,"label",13),l(19,"Renglones x P\xE1gina"),n(),v(20,"input",59),n(),r(21,"div",12)(22,"label",13),l(23,"Ir a la p\xE1gina"),n(),v(24,"input",60),n(),r(25,"div",53)(26,"button",45),b("click",function(){f(e);let s=d();return _(s.limpiar())}),v(27,"i",46),n()(),r(28,"div",47)(29,"button",48),b("click",function(){f(e);let s=d();return _(s.buscar())}),l(30),n()()(),Y()}if(a&2){let e=d();o(5),p("disabled",e.cargando),o(10),p("disabled",e.cargando),o(),p("ngForOf",e.dirs),o(4),p("disabled",e.cargando),o(4),p("disabled",e.cargando),o(2),p("disabled",e.cargando),o(3),p("disabled",e.cargando),o(),c(e.cargando?"Consultando\u2026":"Buscar")}}function gt(a,t){if(a&1&&v(0,"app-devoluciones-kpis",61),a&2){let e=d();p("kpis",e.kpis)}}function vt(a,t){if(a&1&&(r(0,"div"),v(1,"app-devoluciones-top-tabla",62)(2,"app-devoluciones-top-tabla",63)(3,"app-devoluciones-top-tabla",64)(4,"app-devoluciones-top-tabla",65)(5,"app-devoluciones-top-tabla",66),n()),a&2){let e=d();o(),p("rows",e.tops.productos),o(),p("rows",e.tops.motivos),o(),p("rows",e.tops.clientes),o(),p("rows",e.tops.usuarios),o(),p("rows",e.tops.farmacias)}}function ft(a,t){if(a&1&&v(0,"app-devoluciones-top-tabla",67),a&2){let e=d();p("title","Top por "+e.filtroForm.value.agrupacion)("rows",e.rowsAgrupado)}}function _t(a,t){if(a&1){let e=h();r(0,"app-devoluciones-listado",68),b("pageChange",function(s){f(e);let m=d();return _(m.pageChange(s))}),n()}if(a&2){let e=d();p("data",e.listado)}}var Ve=class a{constructor(t,e,i){this.fb=t;this.route=e;this.svc=i}cargando=!1;farmacias=[];usuarios=[];motivos=[];kpis=null;tops={};rowsAgrupado=[];listado=null;agrupaciones=["producto","motivo","cliente","usuario","farmacia"];ordenesTop=["importe","piezas","devoluciones"];dirs=["desc","asc"];filtroForm;clienteOpts=[];productoOpts=[];clienteSel=null;productoSel=null;cliInput;proInput;ngOnInit(){let{farmacias:t,usuarios:e,motivos:i}=this.route.snapshot.data.cat||{};this.farmacias=t||[],this.usuarios=e||[],this.motivos=i||[];let s=new Date,m=new Date(s.getFullYear(),s.getMonth(),1),g=C=>new Date(C.getTime()-C.getTimezoneOffset()*6e4).toISOString().slice(0,10);this.filtroForm=this.fb.group({fechaIni:[g(m),j.required],fechaFin:[g(s),j.required],farmaciaId:[""],clienteId:[""],usuarioId:[""],productoId:[""],motivo:[""],vista:["resumen",j.required],topN:[10],ordenResumen:["importe"],dirResumen:["desc"],agrupacion:["producto"],ordenAgr:["importe"],dirAgr:["desc"],topNAgr:[10],ordenList:["fecha"],dirList:["desc"],page:[1],limit:[20]}),this.buscar()}limpiar(){let t=this.filtroForm.value.vista,e=new Date,i=new Date(e.getFullYear(),e.getMonth(),1),s=m=>new Date(m.getTime()-m.getTimezoneOffset()*6e4).toISOString().slice(0,10);this.filtroForm.reset({fechaIni:s(i),fechaFin:s(e),farmaciaId:"",clienteId:"",usuarioId:"",productoId:"",motivo:"",vista:t,topN:10,ordenResumen:"importe",dirResumen:"desc",agrupacion:"producto",ordenAgr:"importe",dirAgr:"desc",topNAgr:10,ordenList:"fecha",dirList:"desc",page:1,limit:20}),this.clearCliente(this.cliInput?.nativeElement),this.clearProducto(this.proInput?.nativeElement),this.buscar()}onClienteInput(t){let e=(t||"").trim();if(e.length<2){this.clienteOpts=[];return}this.svc.searchClientes(e).subscribe(i=>this.clienteOpts=i)}selectCliente(t){this.clienteSel=t,this.clienteOpts=[],this.filtroForm.patchValue({clienteId:t._id})}clearCliente(t){this.clienteSel=null,this.filtroForm.patchValue({clienteId:null}),this.clienteOpts=[],t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout(()=>t.focus(),0))}onProductoInput(t){let e=(t||"").trim();if(!e){this.productoOpts=[];return}let i=/^\d{6,}$/.test(e);this.svc.searchProductos(e,i).subscribe(s=>{this.productoOpts=Array.isArray(s)?s:[]})}onProductoEnter(t){this.productoOpts.length===1&&this.selectProducto(this.productoOpts[0])}selectProducto(t){this.productoSel=t,this.productoOpts=[],this.filtroForm.patchValue({productoId:t._id})}clearProducto(t){this.productoSel=null,this.filtroForm.patchValue({productoId:null}),this.productoOpts=[],t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout(()=>t.focus(),0))}buscar(){if(this.cargando)return;this.cargando=!0;let t=this.filtroForm.getRawValue(),e={fechaIni:t.fechaIni,fechaFin:t.fechaFin,farmaciaId:t.farmaciaId||void 0,clienteId:t.clienteId||void 0,usuarioId:t.usuarioId||void 0,productoId:t.productoId||void 0,motivo:t.motivo||void 0};t.vista==="resumen"?this.svc.getResumen(A(M({},e),{topN:t.topN,orden:t.ordenResumen,dir:t.dirResumen})).subscribe({next:i=>{this.kpis=i?.kpis&&i.kpis[0]||null,this.tops={productos:i?.topProductos||[],motivos:i?.topMotivos||[],clientes:i?.topClientes||[],usuarios:i?.topUsuarios||[],farmacias:i?.topFarmacias||[]},this.rowsAgrupado=[],this.listado=null,this.cargando=!1},error:i=>this.handleError(i,"No se pudo cargar el resumen")}):t.vista==="agrupado"?this.svc.getAgrupado(t.agrupacion,A(M({},e),{topN:t.topNAgr,orden:t.ordenAgr,dir:t.dirAgr})).subscribe({next:i=>{this.rowsAgrupado=i?.rows||[],this.kpis=null,this.tops={},this.listado=null,this.cargando=!1},error:i=>this.handleError(i,`No se pudo cargar el agrupado por ${t.agrupacion}`)}):this.svc.getListado(A(M({},e),{orden:t.ordenList,dir:t.dirList,page:t.page,limit:t.limit})).subscribe({next:i=>{this.listado=i,this.kpis=null,this.tops={},this.rowsAgrupado=[],this.cargando=!1},error:i=>this.handleError(i,"No se pudo cargar el listado")})}pageChange(t){this.filtroForm.patchValue({page:t}),this.buscar()}handleError(t,e){console.error("[Devoluciones][ERROR]",t),this.cargando=!1;let i=t?.error?.mensaje||t?.message||e;Ne.default.fire("Error",i,"error")}static \u0275fac=function(e){return new(e||a)(B(Te),B(ve),B(Q))};static \u0275cmp=I({type:a,selectors:[["app-devoluciones-page"]],viewQuery:function(e,i){if(e&1&&(J(Ge,5),J(Qe,5)),e&2){let s;X(s=Z())&&(i.cliInput=s.first),X(s=Z())&&(i.proInput=s.first)}},decls:71,vars:29,consts:[["cliInput",""],["proInput",""],[1,"titulo","text-center"],[1,"filtros",3,"formGroup"],[1,"row","g-2","align-items-end","mb-3"],[1,"col-md-3"],[1,"form-label","d-block"],[1,"d-flex","gap-2","flex-wrap"],[1,"report-chip"],["type","radio","formControlName","vista","value","resumen"],["type","radio","formControlName","vista","value","agrupado"],["type","radio","formControlName","vista","value","listado"],[1,"col-md-2"],[1,"form-label"],["formControlName","farmaciaId",1,"form-select",3,"disabled"],["value",""],[3,"value",4,"ngFor","ngForOf"],["type","date","formControlName","fechaIni",1,"form-control",3,"disabled"],["type","date","formControlName","fechaFin",1,"form-control",3,"disabled"],["formControlName","usuarioId",1,"form-select",3,"disabled"],["formControlName","motivo",1,"form-select",3,"disabled"],[1,"col-md-3","position-relative"],["type","text","placeholder","Escribe nombre (m\xEDn. 2 letras)",1,"form-control",3,"input","disabled"],["class","suggest-panel",4,"ngIf"],["class","mt-1",4,"ngIf"],["type","hidden","formControlName","clienteId"],["type","text","placeholder","Nombre o c\xF3digo de barras",1,"form-control",3,"input","keyup.enter","disabled"],["type","hidden","formControlName","productoId"],["class","col-md-1 ms-auto",4,"ngIf"],["class","col-md-2 ms-auto text-end",4,"ngIf"],[4,"ngIf"],[3,"kpis",4,"ngIf"],[3,"title","rows",4,"ngIf"],[3,"data","pageChange",4,"ngIf"],[3,"value"],[1,"suggest-panel"],["type","button","class","suggest-item",3,"click",4,"ngFor","ngForOf"],["type","button",1,"suggest-item",3,"click"],[1,"fw-semibold"],[1,"text-muted"],[1,"mt-1"],[1,"badge","bg-primary-subtle","text-primary","border"],["type","button",1,"btn","btn-link","btn-sm","ps-2",3,"click"],[1,"badge","bg-success-subtle","text-success","border"],[1,"col-md-1","ms-auto"],["type","button","matTooltip","Limpiar filtros",1,"btn-rojo",3,"click","disabled"],[1,"fas","fa-times"],[1,"col-md-2","ms-auto","text-end"],["type","button",1,"btn-gris",3,"click","disabled"],["formControlName","agrupacion",1,"form-select",3,"disabled"],["type","number","formControlName","topNAgr","min","1","max","100",1,"form-control",3,"disabled"],["formControlName","ordenAgr",1,"form-select",3,"disabled"],["formControlName","dirAgr",1,"form-select",3,"disabled"],[1,"col-md-2","ms-auto","text-start"],["formControlName","ordenList",1,"form-select",3,"disabled"],["value","fecha"],["value","importe"],["value","cantidad"],["formControlName","dirList",1,"form-select",3,"disabled"],["type","number","formControlName","limit","min","1","max","200",1,"form-control",3,"disabled"],["type","number","formControlName","page","min","1",1,"form-control",3,"disabled"],[3,"kpis"],["title","Productos m\xE1s devueltos",3,"rows"],["title","Motivos de devoluci\xF3n m\xE1s comunes",3,"rows"],["title","Clientes que m\xE1s devuelven",3,"rows"],["title","Empleados que m\xE1s productos han devuelto",3,"rows"],["title","Farmacias con m\xE1s productos devueltos",3,"rows"],[3,"title","rows"],[3,"pageChange","data"]],template:function(e,i){if(e&1){let s=h();r(0,"h2",2),l(1,"Reportes de devoluciones de ventas"),n(),r(2,"form",3)(3,"div",4)(4,"div",5)(5,"label",6),l(6,"Vista del reporte"),n(),r(7,"div",7)(8,"label",8),v(9,"input",9),l(10,"Resumen"),n(),r(11,"label",8),v(12,"input",10),l(13,"Agrupado"),n(),r(14,"label",8),v(15,"input",11),l(16,"Listado"),n()()(),r(17,"div",12)(18,"label",13),l(19,"Farmacia"),n(),r(20,"select",14)(21,"option",15),l(22,"(Todas)"),n(),u(23,We,2,2,"option",16),n()(),r(24,"div",12)(25,"label",13),l(26,"Fecha Inicial"),n(),v(27,"input",17),n(),r(28,"div",12)(29,"label",13),l(30,"Fecha Final"),n(),v(31,"input",18),n(),r(32,"div",5)(33,"label",13),l(34,"Usuario"),n(),r(35,"select",19)(36,"option",15),l(37,"(Todos)"),n(),u(38,Ye,2,2,"option",16),n()()(),r(39,"div",4)(40,"div",5)(41,"label",13),l(42,"Motivo"),n(),r(43,"select",20)(44,"option",15),l(45,"(Todos)"),n(),u(46,Je,2,2,"option",16),n()(),r(47,"div",21)(48,"label",13),l(49,"Cliente"),n(),r(50,"input",22,0),b("input",function(){f(s);let g=k(51);return _(i.onClienteInput(g.value))}),n(),u(52,Ze,2,1,"div",23)(53,tt,6,2,"div",24),n(),v(54,"input",25),r(55,"div",21)(56,"label",13),l(57,"Producto"),n(),r(58,"input",26,1),b("input",function(){f(s);let g=k(59);return _(i.onProductoInput(g.value))})("keyup.enter",function(){f(s);let g=k(59);return _(i.onProductoEnter(g.value))}),n(),u(60,nt,2,1,"div",23)(61,rt,6,2,"div",24),n(),v(62,"input",27),u(63,at,3,1,"div",28)(64,lt,3,2,"div",29),n(),u(65,dt,27,10,"ng-container",30)(66,ut,31,8,"ng-container",30),n(),u(67,gt,1,1,"app-devoluciones-kpis",31)(68,vt,6,5,"div",30)(69,ft,1,2,"app-devoluciones-top-tabla",32)(70,_t,1,1,"app-devoluciones-listado",33)}if(e&2){let s,m,g;o(2),p("formGroup",i.filtroForm),o(6),y("active",((s=i.filtroForm.get("vista"))==null?null:s.value)==="resumen"),o(3),y("active",((m=i.filtroForm.get("vista"))==null?null:m.value)==="agrupado"),o(3),y("active",((g=i.filtroForm.get("vista"))==null?null:g.value)==="listado"),o(6),p("disabled",i.cargando),o(3),p("ngForOf",i.farmacias),o(4),p("disabled",i.cargando),o(4),p("disabled",i.cargando),o(4),p("disabled",i.cargando),o(3),p("ngForOf",i.usuarios),o(5),p("disabled",i.cargando),o(3),p("ngForOf",i.motivos),o(4),p("disabled",i.cargando||!!i.clienteSel),o(2),p("ngIf",i.clienteOpts.length&&!i.clienteSel),o(),p("ngIf",i.clienteSel),o(5),p("disabled",i.cargando||!!i.productoSel),o(2),p("ngIf",i.productoOpts.length&&!i.productoSel),o(),p("ngIf",i.productoSel),o(2),p("ngIf",i.filtroForm.value.vista==="resumen"),o(),p("ngIf",i.filtroForm.value.vista==="resumen"),o(),p("ngIf",i.filtroForm.value.vista==="agrupado"),o(),p("ngIf",i.filtroForm.value.vista==="listado"),o(),p("ngIf",i.filtroForm.value.vista==="resumen"&&i.kpis),o(),p("ngIf",i.filtroForm.value.vista==="resumen"),o(),p("ngIf",i.filtroForm.value.vista==="agrupado"),o(),p("ngIf",i.filtroForm.value.vista==="listado"&&i.listado)}},dependencies:[P,L,$,Fe,he,Ie,we,fe,xe,Ee,Ce,_e,be,De,Pe,ye,Se,ke,Le,Oe,q,U,G],styles:[".filtros[_ngcontent-%COMP%]{border-bottom:2px solid #0453b3;padding-bottom:1rem}.form-label[_ngcontent-%COMP%]{margin-bottom:0}.report-chip[_ngcontent-%COMP%]{border:1px solid #d0d7de;border-radius:9999px;padding:.375rem .75rem;cursor:pointer;-webkit-user-select:none;user-select:none;display:inline-flex;align-items:center;gap:.5rem;transition:all .15s ease-in-out}.report-chip[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{margin:0}.report-chip[_ngcontent-%COMP%]:hover{background:#a5d1fa}.report-chip.active[_ngcontent-%COMP%]{border-color:#0d6efd;background:#e7f1ff;color:#0d6efd;font-weight:600;box-shadow:0 0 0 2px #0d6efd26 inset}.suggest-panel[_ngcontent-%COMP%]{position:absolute;top:calc(100% + 4px);left:0;right:0;z-index:1055;background:#fff;border:1px solid #e5e7eb;box-shadow:0 8px 24px #00000014;border-radius:.5rem;max-height:260px;overflow:auto}.suggest-item[_ngcontent-%COMP%]{width:100%;padding:.5rem .75rem;text-align:left;background:transparent;border:0;cursor:pointer}.suggest-item[_ngcontent-%COMP%]:hover{background:#f8f9fa}"]})};export{Ve as DevolucionesPageComponent};
