import{a as X}from"./chunk-LPTRF4E5.js";import{M as me,N as le}from"./chunk-FPX2FNEV.js";import{Ab as m,Bb as x,Bd as ne,Cb as h,D as N,Ec as O,Fc as u,Hc as U,Ic as $,Ja as o,K as M,Md as oe,Na as y,Nc as R,Ob as q,Qb as B,Rc as K,U as L,Ua as D,Uc as H,Ya as v,a as S,b as I,cb as A,cd as J,d as se,db as l,dd as Q,ed as W,fd as de,gd as Y,hb as r,hc as G,hd as Z,ia as g,ib as i,ic as P,id as ee,ja as _,jb as s,mb as w,mc as z,o as T,ob as f,od as ae,pb as F,pc as j,sd as ie,t as V,xd as te,yd as re}from"./chunk-6VVKRHY3.js";var d=se(de());function ue(c,t){if(c&1&&(r(0,"small",31),m(1),q(2,"date"),i()),c&2){let a=F().$implicit;o(),h(" ",B(2,1,a.firmaUpdatedAt,"dd-MM-yyyy")," ")}}function fe(c,t){if(c&1){let a=w();r(0,"tr")(1,"td"),m(2),i(),r(3,"td"),m(4),i(),r(5,"td"),m(6),i(),r(7,"td")(8,"span",26),m(9,"Secreta"),i(),v(10,ue,3,4,"small",27),i(),r(11,"td")(12,"button",28),f("click",function(){let n=g(a).$implicit,b=F();return _(b.editar(n))}),s(13,"fa-icon",3),i(),r(14,"button",29),f("click",function(){let n=g(a).$implicit,b=F();return _(b.eliminar(n._id))}),s(15,"fa-icon",3),i(),r(16,"button",30),f("click",function(){let n=g(a).$implicit,b=F();return _(b.abrirCambiarFirma(n))}),s(17,"fa-icon",3),i()()()}if(c&2){let a=t.$implicit,e=F();o(2),x(a.nombre),o(2),x(a.direccion),o(2),x(a.telefono),o(4),l("ngIf",a.firmaUpdatedAt),o(3),l("icon","pen"),o(),l("disabled",e.cargando||a._bloquearEliminar)("matTooltip",a._bloquearEliminar?"No puedes eliminar: hay turnos de caja abiertos":"Eliminar"),o(),l("icon","trash"),o(2),l("icon","key")}}function pe(c,t){if(c&1){let a=w();r(0,"div",19)(1,"label"),m(2,"Firma actual (requerida para cambiarla):"),i(),r(3,"div",20),s(4,"input",39),r(5,"button",38),f("click",function(){g(a);let n=F(2);return _(n.showFirma=!n.showFirma)}),s(6,"fa-icon",3),i()()()}if(c&2){let a=F(2);o(4),l("type",a.showFirma?"text":"password"),o(),l("matTooltip",a.showFirma?"Ocultar":"Mostrar"),A("aria-pressed",a.showFirma),o(),l("icon",a.showFirma?"eye-slash":"eye")}}function Fe(c,t){c&1&&(r(0,"div",40),m(1," La nueva firma debe tener al menos 6 caracteres. "),i())}function be(c,t){c&1&&(r(0,"div",40),m(1," La nueva firma no puede ser igual a la actual. "),i())}function ve(c,t){if(c&1){let a=w();r(0,"form",32)(1,"div",19)(2,"label"),m(3,"Nombre:"),i(),s(4,"input",33),i(),r(5,"div",19)(6,"label"),m(7,"Direcci\xF3n:"),i(),s(8,"input",34),i(),r(9,"div",19)(10,"label"),m(11,"Tel\xE9fono:"),i(),s(12,"input",35),i(),v(13,pe,7,4,"div",36),r(14,"div",19)(15,"label"),m(16),i(),r(17,"div",20),s(18,"input",37),r(19,"button",38),f("click",function(){g(a);let n=F();return _(n.showFirmaConfirm=!n.showFirmaConfirm)}),s(20,"fa-icon",3),i()(),v(21,Fe,2,0,"div",25)(22,be,2,0,"div",25),i()()}if(c&2){let a,e,n=F();l("formGroup",n.formFarmacia),o(13),l("ngIf",n.modoEdicion),o(3),h("Nueva firma ",n.modoEdicion?"(m\xEDn. 6, distinta a la actual)":"(obligatoria, m\xEDn. 6)",""),o(2),l("type",n.showFirmaConfirm?"text":"password"),o(),l("matTooltip",n.showFirmaConfirm?"Ocultar":"Mostrar"),A("aria-pressed",n.showFirmaConfirm),o(),l("icon",n.showFirmaConfirm?"eye-slash":"eye"),o(),l("ngIf",((a=n.formFarmacia.get("nuevaFirma"))==null?null:a.hasError("minlength"))&&((a=n.formFarmacia.get("nuevaFirma"))==null?null:a.touched)),o(),l("ngIf",(n.formFarmacia.errors==null?null:n.formFarmacia.errors.nuevaIgualAActual)&&(((e=n.formFarmacia.get("nuevaFirma"))==null?null:e.touched)||((e=n.formFarmacia.get("firmaActual"))==null?null:e.touched)))}}function he(c,t){c&1&&(r(0,"div",40),m(1," Las firmas no coinciden. "),i())}var ce=class c{constructor(t,a,e){this.fb=t;this.farmaciaService=a;this.library=e;e.addIcons(re,ne,oe,te,ae,ie),this.formFarmacia=this.fb.group({nombre:["",u.required],direccion:[""],telefono:[""],firma:["",u.required]})}farmacias=[];cargando=!1;formFarmacia;guardando=!1;modoEdicion=!1;farmaciaEditandoId=null;showFirma=!1;showFirmaConfirm=!1;formCambiarFirma;guardandoFirma=!1;showAdminPass=!1;showNueva=!1;showConfirm=!1;farmaciaTarget=null;ngOnInit(){this.cargarFarmacias(),this.formFarmacia=this.fb.group({nombre:["",[u.required,u.minLength(2)]],direccion:[""],telefono:[""],firmaActual:[""],nuevaFirma:[""]},{validators:[this.nuevaDistintaDeActualValidator]}),this.formCambiarFirma=this.fb.group({adminPassword:["",[u.required,u.minLength(4)]],nuevaFirma:["",[u.required,u.minLength(4)]],confirmFirma:["",[u.required]]},{validators:[this.firmasIgualesValidatorCambiar]})}nuevaDistintaDeActualValidator=t=>{let a=(t.get("firmaActual")?.value||"").trim(),e=(t.get("nuevaFirma")?.value||"").trim();return!a||!e?null:a===e?{nuevaIgualAActual:!0}:null};configurarValidadoresFirma(){let t=this.formFarmacia.get("firmaActual"),a=this.formFarmacia.get("nuevaFirma");this.modoEdicion?(a.value||"").trim()?(t.setValidators([u.required]),a.setValidators([u.minLength(6)])):(t.clearValidators(),a.clearValidators()):(t.clearValidators(),a.setValidators([u.required,u.minLength(6)])),t.updateValueAndValidity({emitEvent:!1}),a.updateValueAndValidity({emitEvent:!1})}onNuevaFirmaChange(){this.configurarValidadoresFirma()}editar(t){let a=document.getElementById("modalAgregarFarmacia");if(!a)return;this.modoEdicion=!0,this.farmaciaEditandoId=t._id||null,this.formFarmacia.reset({nombre:t.nombre,direccion:t.direccion,telefono:t.telefono,firmaActual:"",nuevaFirma:""}),this.configurarValidadoresFirma(),new bootstrap.Modal(a,{backdrop:"static",keyboard:!1}).show()}firmasIgualesValidatorCambiar=t=>{let a=(t.get("nuevaFirma")?.value||"").trim(),e=(t.get("confirmFirma")?.value||"").trim();return!a&&!e||a===e?null:{firmaNoCoincide:!0}};abrirCambiarFirma(t){this.farmaciaTarget=t,this.formCambiarFirma.reset();let a=document.getElementById("modalCambiarFirma");a&&new bootstrap.Modal(a,{backdrop:"static",keyboard:!1}).show()}confirmarCambioFirma(){if(this.formCambiarFirma.invalid||!this.farmaciaTarget?._id)return;this.guardandoFirma=!0;let{adminPassword:t,nuevaFirma:a}=this.formCambiarFirma.value;this.farmaciaService.cambiarFirma(this.farmaciaTarget._id,{adminPassword:t,nuevaFirma:(a||"").trim()}).subscribe({next:e=>{d.default.fire("Actualizada","La firma se cambi\xF3 correctamente","success").then(()=>{let n=document.getElementById("modalCambiarFirma");n&&bootstrap.Modal.getInstance(n)?.hide(),this.guardandoFirma=!1,this.cargarFarmacias()})},error:e=>{console.error(e),this.guardandoFirma=!1,d.default.fire("Error",e.error?.mensaje||"No se pudo cambiar la firma","error")}})}firmasIgualesValidator=t=>{let a=(t.get("firma")?.value||"").trim(),e=(t.get("firmaConfirm")?.value||"").trim();return!a&&!e?null:a!==e?{firmaNoCoincide:!0}:null};cargarFarmacias(){this.cargando=!0,this.farmaciaService.obtenerFarmacias().pipe(L(t=>this.farmaciaService.abiertosPorFarmacia().pipe(V(({mapa:a})=>t.map(e=>{let n=a[e._id]??0;return I(S({},e),{_abiertos:n,_bloquearEliminar:n>0})})),N(()=>T(t.map(a=>I(S({},a),{_abiertos:0,_bloquearEliminar:!1})))))),M(()=>this.cargando=!1)).subscribe({next:t=>this.farmacias=t,error:()=>d.default.fire("Error","No se pudieron cargar las farmacias","error")})}abrirModalAgregar(){let t=document.getElementById("modalAgregarFarmacia");if(!t)return;this.modoEdicion=!1,this.farmaciaEditandoId=null,this.formFarmacia.reset({nombre:"",direccion:"",telefono:"",firma:"",firmaConfirm:""}),this.configurarValidadoresFirma(),new bootstrap.Modal(t,{backdrop:"static",keyboard:!1}).show()}guardar(){if(this.guardando)return;if(this.configurarValidadoresFirma(),this.formFarmacia.invalid){this.formFarmacia.markAllAsTouched(),d.default.fire("Datos incompletos","Revisa los campos del formulario.","warning");return}this.guardando=!0;let{nombre:t,direccion:a,telefono:e,firmaActual:n,nuevaFirma:b}=this.formFarmacia.value,C={nombre:(t||"").trim(),direccion:(a||"").trim(),telefono:(e||"").trim()},k=()=>{let p=document.getElementById("modalAgregarFarmacia");p&&bootstrap.Modal.getInstance(p)?.hide(),this.formFarmacia.reset(),this.farmaciaEditandoId=null,this.modoEdicion=!1,this.guardando=!1,this.cargarFarmacias()};if(this.modoEdicion&&this.farmaciaEditandoId){let p=(b||"").trim();if(p){if(p.length<6){this.formFarmacia.get("nuevaFirma")?.markAsTouched(),this.guardando=!1,d.default.fire("Firma inv\xE1lida","La nueva firma debe tener al menos 6 caracteres.","warning");return}if(this.formFarmacia.errors?.nuevaIgualAActual){this.formFarmacia.get("nuevaFirma")?.markAsTouched(),this.formFarmacia.get("firmaActual")?.markAsTouched(),this.guardando=!1,d.default.fire("Firma inv\xE1lida","La nueva firma no puede ser igual a la actual.","warning");return}C.firmaActual=(n||"").trim(),C.nuevaFirma=p}this.farmaciaService.actualizarFarmacia(this.farmaciaEditandoId,C).subscribe({next:()=>d.default.fire({icon:"success",title:"Actualizaci\xF3n",text:"Farmacia actualizada correctamente.",timer:1500,showConfirmButton:!1}).then(k),error:E=>{console.error(E),this.guardando=!1,d.default.fire("Error",E?.error?.mensaje||"No se pudo actualizar","error")}})}else{let p=(b||"").trim();if(!p||p.length<6){this.formFarmacia.get("nuevaFirma")?.markAsTouched(),this.guardando=!1,d.default.fire("Firma requerida","La firma debe tener al menos 6 caracteres.","warning");return}C.firma=p,this.farmaciaService.crearFarmacia(C).subscribe({next:()=>d.default.fire({icon:"success",title:"Creaci\xF3n",text:"Farmacia creada correctamente.",timer:1500,showConfirmButton:!1}).then(k),error:E=>{console.error(E),this.guardando=!1,d.default.fire("Error",E?.error?.mensaje||"No se pudo crear","error")}})}}eliminar(t){d.default.fire({title:"\xBFEst\xE1s seguro?",text:"La farmacia ser\xE1 desactivada",icon:"warning",showCancelButton:!0,confirmButtonText:"S\xED, eliminar",cancelButtonText:"Cancelar"}).then(a=>{a.isConfirmed&&this.farmaciaService.eliminarFarmacia(t).subscribe({next:()=>{d.default.fire("Desactivada","La farmacia fue desactivada","success"),this.cargarFarmacias()},error:()=>d.default.fire("Error","No se pudo eliminar la farmacia","error")})})}static \u0275fac=function(a){return new(a||c)(y(J),y(X),y(Y))};static \u0275cmp=D({type:c,selectors:[["app-farmacias"]],decls:70,vars:17,consts:[[1,"container","mt-4"],[1,"titulo"],[1,"btn-verde","mb-3",3,"click"],[3,"icon"],[1,"tabla"],[4,"ngFor","ngForOf"],["id","modalAgregarFarmacia","tabindex","-1","aria-hidden","true",1,"modal","fade"],[1,"modal-dialog","modal-dialog-centered"],[1,"modal-content","p-3",2,"background-color","azure"],[1,"modal-header"],[1,"modal-title","titulo"],["type","button","data-bs-dismiss","modal","aria-label","Cerrar",1,"btn-close"],[1,"modal-body"],[3,"formGroup",4,"ngIf"],[1,"modal-footer","d-flex","justify-content-between"],["data-bs-dismiss","modal",1,"btn-rojo"],[1,"btn-gris",3,"click","disabled"],["id","modalCambiarFirma","tabindex","-1","aria-hidden","true",1,"modal","fade"],[1,"modal-body",3,"formGroup"],[1,"mb-2"],[1,"input-group"],["formControlName","adminPassword","autocomplete","current-password",1,"form-control",3,"type"],["type","button",1,"btn-gris",3,"click"],["formControlName","nuevaFirma","autocomplete","new-password",1,"form-control",3,"type"],["formControlName","confirmFirma","autocomplete","new-password",1,"form-control",3,"type"],["class","text-danger mt-1",4,"ngIf"],[1,"badge","bg-secondary"],["class","text-muted d-block",4,"ngIf"],["matTooltip","Editar",1,"btn-icon-chico","btn-gris-chico",3,"click"],[1,"btn-icon-chico","btn-rojo-chico",3,"click","disabled","matTooltip"],["matTooltip","Cambiar firma",1,"btn-icon-chico","btn-verde-chico",3,"click"],[1,"text-muted","d-block"],[3,"formGroup"],["type","text","formControlName","nombre",1,"form-control"],["type","text","formControlName","direccion",1,"form-control"],["type","text","formControlName","telefono",1,"form-control"],["class","mb-2",4,"ngIf"],["formControlName","nuevaFirma","autocomplete","new-password","spellcheck","false","autocapitalize","off",1,"form-control",3,"type"],["type","button",1,"btn-gris",3,"click","matTooltip"],["formControlName","firmaActual","autocomplete","current-password","spellcheck","false","autocapitalize","off",1,"form-control",3,"type"],[1,"text-danger","mt-1"]],template:function(a,e){if(a&1&&(r(0,"div",0)(1,"h2",1),m(2,"Mantenimiento de Farmacias"),i(),r(3,"button",2),f("click",function(){return e.abrirModalAgregar()}),s(4,"fa-icon",3),m(5," Agregar Farmacia "),i(),r(6,"table",4)(7,"thead")(8,"tr")(9,"th"),m(10,"Nombre"),i(),r(11,"th"),m(12,"Direcci\xF3n"),i(),r(13,"th"),m(14,"Tel\xE9fono"),i(),r(15,"th"),m(16,"Firma"),i(),r(17,"th"),m(18,"Acciones"),i()()(),r(19,"tbody"),v(20,fe,18,9,"tr",5),i()(),r(21,"div",6)(22,"div",7)(23,"div",8)(24,"div",9)(25,"h5",10),m(26),i(),s(27,"button",11),i(),r(28,"div",12),v(29,ve,23,9,"form",13),i(),r(30,"div",14)(31,"button",15),m(32,"Cancelar"),i(),r(33,"button",16),f("click",function(){return e.guardar()}),m(34),i()()()()(),r(35,"div",17)(36,"div",7)(37,"div",8)(38,"div",9)(39,"h5",10),m(40),i(),s(41,"button",11),i(),r(42,"div",18)(43,"div",19)(44,"label"),m(45,"Tu contrase\xF1a (admin):"),i(),r(46,"div",20),s(47,"input",21),r(48,"button",22),f("click",function(){return e.showAdminPass=!e.showAdminPass}),s(49,"fa-icon",3),i()()(),r(50,"div",19)(51,"label"),m(52,"Nueva firma:"),i(),r(53,"div",20),s(54,"input",23),r(55,"button",22),f("click",function(){return e.showNueva=!e.showNueva}),s(56,"fa-icon",3),i()()(),r(57,"div",19)(58,"label"),m(59,"Confirmar nueva firma:"),i(),r(60,"div",20),s(61,"input",24),r(62,"button",22),f("click",function(){return e.showConfirm=!e.showConfirm}),s(63,"fa-icon",3),i()(),v(64,he,2,0,"div",25),i()(),r(65,"div",14)(66,"button",15),m(67,"Cancelar"),i(),r(68,"button",16),f("click",function(){return e.confirmarCambioFirma()}),m(69),i()()()()()()),a&2){let n;o(4),l("icon","plus"),o(16),l("ngForOf",e.farmacias),o(6),h(" ",e.modoEdicion?"Editar farmacia":"Agregar nueva farmacia"," "),o(3),l("ngIf",e.formFarmacia),o(4),l("disabled",e.formFarmacia.invalid||e.guardando),o(),h(" ",e.guardando?"Guardando...":e.modoEdicion?"Actualizar":"Guardar"," "),o(6),h("Cambiar firma de ",e.farmaciaTarget==null?null:e.farmaciaTarget.nombre,""),o(2),l("formGroup",e.formCambiarFirma),o(5),l("type",e.showAdminPass?"text":"password"),o(2),l("icon",e.showAdminPass?"eye-slash":"eye"),o(5),l("type",e.showNueva?"text":"password"),o(2),l("icon",e.showNueva?"eye-slash":"eye"),o(5),l("type",e.showConfirm?"text":"password"),o(2),l("icon",e.showConfirm?"eye-slash":"eye"),o(),l("ngIf",(e.formCambiarFirma.errors==null?null:e.formCambiarFirma.errors.firmaNoCoincide)&&(((n=e.formCambiarFirma.get("confirmFirma"))==null?null:n.touched)||((n=e.formCambiarFirma.get("nuevaFirma"))==null?null:n.touched))),o(4),l("disabled",e.formCambiarFirma.invalid||e.guardandoFirma),o(),h(" ",e.guardandoFirma?"Guardando...":"Actualizar firma"," ")}},dependencies:[j,G,P,z,ee,Z,W,R,O,U,$,K,H,Q,le,me],encapsulation:2})};export{ce as FarmaciasComponent};
